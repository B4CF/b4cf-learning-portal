<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bridge4Change â€“ Learning Portal</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700;900&family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">
<style>

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BRIDGE4CHANGE PORTAL â€” Design v10
   Fonts: Playfair Display (headings) + Lato (body)
   Tone: Warm editorial / NGO professional â€” trustworthy, inspiring
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700;900&family=Lato:wght@300;400;700;900&display=swap');

:root {
  --primary:  #1B4332;   /* deep forest green */
  --pl:       #2D6A4F;   /* medium green */
  --pd:       #0D2B1F;   /* very dark green */
  --accent:   #F0A500;   /* warm amber gold */
  --accent2:  #52B788;   /* light mint green */
  --bg:       #F7F5F0;   /* warm off-white */
  --surface:  #FFFFFF;
  --text:     #1A1A2E;
  --muted:    #6B7280;
  --border:   #E0DDD5;
  --green:    #2D6A4F;
  --red:      #DC2626;
  --orange:   #D97706;
  --purple:   #6D28D9;
  --radius:   14px;
  --shadow:   0 4px 24px rgba(27,67,50,.09);
  --shadow-lg:0 12px 48px rgba(27,67,50,.14);
}

*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
html { scroll-behavior:smooth; }
body {
  font-family:'Lato', sans-serif;
  background:var(--bg);
  color:var(--text);
  line-height:1.65;
  -webkit-font-smoothing:antialiased;
}

/* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
header {
  background: linear-gradient(135deg, var(--pd) 0%, var(--primary) 55%, var(--pl) 100%);
  padding:.85rem 0;
  box-shadow: 0 4px 28px rgba(0,0,0,.22);
  position:sticky; top:0; z-index:500;
}
header::after {
  content:'';
  position:absolute; bottom:0; left:0; right:0; height:2px;
  background: linear-gradient(90deg, transparent, var(--accent), transparent);
}
.hdr { max-width:1300px; margin:0 auto; padding:0 1.6rem; display:flex; justify-content:space-between; align-items:center; gap:1rem; }
.hdr-brand { display:flex; align-items:center; gap:.8rem; }
.hdr-brand img { height:44px; width:auto; }
.hdr-brand h1 {
  font-family:'Playfair Display', serif;
  font-size:1.3rem; font-weight:700;
  color:var(--accent); line-height:1.1;
  letter-spacing:-.01em;
}
.hdr-brand p { color:rgba(255,255,255,.6); font-size:.7rem; font-weight:300; letter-spacing:.06em; text-transform:uppercase; }
.hdr-r { display:none; align-items:center; gap:.75rem; }
.hdr-r.show { display:flex; }
.avatar {
  width:34px; height:34px; border-radius:50%;
  background:var(--accent);
  display:flex; align-items:center; justify-content:center;
  font-weight:900; font-size:.8rem; color:var(--primary);
  border:2px solid rgba(255,255,255,.3);
}
.pts {
  background:rgba(240,165,0,.2);
  border:1px solid rgba(240,165,0,.5);
  color:var(--accent);
  padding:.2rem .65rem; border-radius:20px;
  font-size:.73rem; font-weight:700; letter-spacing:.02em;
}
.btn-hdr {
  background:rgba(255,255,255,.1);
  border:1px solid rgba(255,255,255,.25);
  color:#fff; padding:.32rem .9rem;
  border-radius:8px; cursor:pointer; font-size:.78rem;
  font-family:'Lato',sans-serif; font-weight:700;
  transition:.2s;
}
.btn-hdr:hover { background:rgba(255,255,255,.2); }
.uname { color:rgba(255,255,255,.9); font-size:.82rem; font-weight:700; }

/* â”€â”€ PAGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.pg { display:none; } .pg.on { display:block; }
.wrap { max-width:1300px; margin:0 auto; padding:1.6rem; }

/* â”€â”€ CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card {
  background:var(--surface);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  border:1px solid var(--border);
}
.cb { padding:1.7rem; }

/* â”€â”€ AUTH PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.auth-wrap { max-width:460px; margin:2.8rem auto; padding:0 1rem; }
.auth-logo { text-align:center; margin-bottom:1.2rem; }
.auth-logo img { height:72px; }
.card-h {
  font-family:'Playfair Display', serif;
  font-size:1.65rem; font-weight:700;
  color:var(--primary);
  text-align:center; margin-bottom:.25rem;
  line-height:1.2;
}
.card-s { color:var(--muted); font-size:.86rem; text-align:center; margin-bottom:1.2rem; }
.tabs { display:flex; border-bottom:2px solid var(--border); margin-bottom:1.2rem; }
.tab {
  flex:1; padding:.65rem; text-align:center; cursor:pointer;
  font-weight:700; font-size:.84rem; color:var(--muted);
  border-bottom:3px solid transparent; margin-bottom:-2px;
  transition:.2s; letter-spacing:.01em;
}
.tab.on { color:var(--primary); border-bottom-color:var(--primary); }

/* â”€â”€ FORMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.fg { margin-bottom:1.05rem; position:relative; }
label { display:block; font-size:.81rem; font-weight:700; margin-bottom:.32rem; color:var(--text); letter-spacing:.01em; }
input, select, textarea {
  width:100%; padding:.68rem .9rem;
  border:1.5px solid var(--border); border-radius:9px;
  font-size:.88rem; font-family:'Lato',sans-serif;
  background:var(--bg); color:var(--text); transition:.2s;
}
input:focus, select:focus, textarea:focus {
  outline:none; border-color:var(--primary);
  background:#fff; box-shadow:0 0 0 3px rgba(27,67,50,.1);
}
textarea { resize:vertical; min-height:76px; }
.eye {
  position:absolute; right:.9rem; top:2.1rem;
  cursor:pointer; color:var(--muted); user-select:none; font-size:.9rem;
}
.form-row { display:grid; grid-template-columns:1fr 1fr; gap:.95rem; }

/* â”€â”€ BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn {
  display:inline-flex; align-items:center; gap:.35rem;
  padding:.62rem 1.35rem; border:none; border-radius:9px;
  font-size:.875rem; font-weight:700; cursor:pointer;
  font-family:'Lato',sans-serif; transition:.18s;
  text-decoration:none; letter-spacing:.01em;
}
.btn:disabled { opacity:.5; cursor:not-allowed; }
.bp {
  background:linear-gradient(135deg, var(--primary), var(--pl));
  color:#fff;
}
.bp:hover:not(:disabled) { transform:translateY(-1px); box-shadow:0 5px 16px rgba(27,67,50,.3); }
.ba { background:linear-gradient(135deg, var(--accent), #FFCC44); color:var(--primary); }
.ba:hover:not(:disabled) { transform:translateY(-1px); box-shadow:0 4px 14px rgba(240,165,0,.3); }
.bd { background:var(--red); color:#fff; }
.bd:hover:not(:disabled) { background:#b91c1c; }
.bg_ { background:transparent; color:var(--primary); border:1.5px solid var(--border); }
.bg_:hover { background:var(--bg); border-color:var(--pl); }
.badm { background:linear-gradient(135deg, var(--purple), #7C3AED); color:#fff; }
.badm:hover:not(:disabled) { transform:translateY(-1px); box-shadow:0 4px 14px rgba(109,40,217,.3); }
.sm { padding:.36rem .82rem; font-size:.79rem; }
.bw { width:100%; justify-content:center; }

/* â”€â”€ ALERTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.alert { padding:.8rem 1.05rem; border-radius:9px; font-size:.84rem; margin-bottom:.9rem; font-weight:400; }
.ok  { background:#ECFDF5; color:#065F46; border:1px solid #A7F3D0; }
.err { background:#FEF2F2; color:#991B1B; border:1px solid #FECACA; }
.info { background:#EFF6FF; color:#1E40AF; border:1px solid #BFDBFE; }
.hidden { display:none!important; }

/* â”€â”€ STATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stats { display:grid; grid-template-columns:repeat(auto-fill,minmax(152px,1fr)); gap:1rem; margin-bottom:1.15rem; }
.stat {
  background:var(--surface); border:1px solid var(--border);
  border-radius:12px; padding:1.1rem; text-align:center;
  transition:.2s;
}
.stat:hover { box-shadow:var(--shadow); transform:translateY(-2px); }
.sv {
  font-family:'Playfair Display', serif;
  font-size:2rem; font-weight:700; color:var(--primary); line-height:1;
}
.sl { color:var(--muted); font-size:.74rem; margin-top:.3rem; font-weight:700; letter-spacing:.04em; text-transform:uppercase; }

/* â”€â”€ PROGRESS BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.pb-w { background:var(--border); border-radius:999px; height:8px; margin:.38rem 0; overflow:hidden; }
.pb-f { height:100%; border-radius:999px; background:linear-gradient(90deg, var(--primary), var(--accent)); transition:width .6s ease; }

/* â”€â”€ NAV CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.nav-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(215px,1fr)); gap:1.1rem; margin-top:1.15rem; }
.nc {
  background:var(--surface); border:2px solid var(--border);
  border-radius:var(--radius); padding:1.5rem 1.3rem;
  text-align:center; cursor:pointer; transition:.25s;
  position:relative; overflow:hidden;
}
.nc::before {
  content:''; position:absolute; top:0; left:0; right:0; height:4px;
  background:linear-gradient(90deg, var(--primary), var(--accent));
  transform:scaleX(0); transition:.3s; transform-origin:left;
}
.nc:hover::before { transform:scaleX(1); }
.nc:hover {
  border-color:var(--primary);
  box-shadow:var(--shadow-lg);
  transform:translateY(-4px);
}
.nc-icon { font-size:2.2rem; margin-bottom:.55rem; }
.nc h3 {
  font-family:'Playfair Display', serif;
  font-size:1.12rem; color:var(--primary);
  margin-bottom:.25rem; font-weight:700;
}
.nc p { color:var(--muted); font-size:.79rem; }
.ncb {
  display:inline-block; margin-top:.4rem;
  padding:.14rem .5rem; background:var(--primary); color:#fff;
  border-radius:20px; font-size:.69rem; font-weight:700; letter-spacing:.02em;
}

/* â”€â”€ CONTENT GRID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cgrid { display:grid; grid-template-columns:repeat(auto-fill,minmax(285px,1fr)); gap:1.1rem; margin-top:.95rem; }
.cc {
  background:var(--surface); border:1px solid var(--border);
  border-radius:12px; padding:1.1rem; transition:.2s; display:flex; flex-direction:column;
}
.cc:hover { box-shadow:var(--shadow-lg); transform:translateY(-2px); }
.ctag {
  display:inline-block; padding:.12rem .52rem;
  background:rgba(27,67,50,.08); border-radius:6px;
  font-size:.69rem; font-weight:700; color:var(--primary);
  margin-bottom:.45rem; letter-spacing:.03em; text-transform:uppercase;
}
.ctitle {
  font-family:'Playfair Display', serif;
  font-size:1.05rem; font-weight:600;
  margin-bottom:.35rem; color:var(--text); line-height:1.35;
}
.cmeta { color:var(--muted); font-size:.77rem; margin-bottom:.58rem; display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; }
.cdesc { color:var(--muted); font-size:.8rem; margin-bottom:.68rem; line-height:1.55; }
.cacts { margin-top:auto; display:flex; gap:.4rem; flex-wrap:wrap; }
.bdg { display:inline-flex; align-items:center; padding:.12rem .48rem; border-radius:20px; font-size:.69rem; font-weight:700; }
.bdg-g { background:var(--green); color:#fff; }
.bdg-a { background:var(--accent); color:var(--primary); }

/* â”€â”€ FILTER BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.fbar { display:flex; gap:.95rem; margin-bottom:1.05rem; flex-wrap:wrap; align-items:flex-end; }
.fbar .fg { margin-bottom:0; flex:1; min-width:155px; }
.sec-hdr { display:flex; justify-content:space-between; align-items:center; margin-bottom:1.15rem; flex-wrap:wrap; gap:.68rem; }
.sec-t {
  font-family:'Playfair Display', serif;
  font-size:1.6rem; color:var(--primary); font-weight:700;
}
.bk {
  display:inline-flex; align-items:center; gap:.35rem;
  color:var(--muted); cursor:pointer; font-size:.82rem; font-weight:700;
  margin-bottom:.85rem; transition:.15s;
}
.bk:hover { color:var(--primary); }

/* â”€â”€ QUIZ OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.ov {
  position:fixed; inset:0;
  background:rgba(0,0,0,.68); z-index:900;
  display:flex; align-items:center; justify-content:center;
  padding:1.1rem;
}
.qm {
  background:var(--surface); border-radius:16px;
  max-width:610px; width:100%; max-height:88vh;
  overflow-y:auto; box-shadow:var(--shadow-lg);
}
.qhdr {
  padding:1.15rem 1.7rem; border-bottom:1px solid var(--border);
  display:flex; justify-content:space-between; align-items:center;
  position:sticky; top:0; background:var(--surface); z-index:1;
}
.qhdr h2 {
  font-family:'Playfair Display', serif;
  font-size:1.25rem; color:var(--primary);
}
.qbody { padding:1.15rem 1.7rem 1.7rem; }
.qinfo { font-size:.76rem; color:var(--muted); display:flex; justify-content:space-between; margin-bottom:.38rem; }
.qnum { font-size:.74rem; font-weight:700; color:var(--muted); text-transform:uppercase; letter-spacing:.05em; margin-bottom:.32rem; }
.qtxt { font-size:1rem; font-weight:700; margin-bottom:1.05rem; color:var(--text); line-height:1.52; }
.qopts { display:flex; flex-direction:column; gap:.48rem; margin-bottom:.95rem; }
.qopt {
  padding:.78rem 1.05rem; border:2px solid var(--border);
  border-radius:9px; cursor:pointer; transition:.18s;
  font-size:.875rem; background:var(--surface); text-align:left; width:100%;
  font-family:'Lato',sans-serif;
}
.qopt:hover:not(.dis) { border-color:var(--primary); background:rgba(27,67,50,.04); }
.qopt.sel { border-color:var(--primary); background:rgba(27,67,50,.06); }
.qopt.cor { border-color:var(--green); background:rgba(45,106,79,.1); color:#065F46; font-weight:700; }
.qopt.wrg { border-color:var(--red); background:rgba(220,38,38,.07); color:#991b1b; }
.qopt.dis { cursor:default; }
.qfb { padding:.78rem 1.05rem; border-radius:9px; font-size:.85rem; margin-bottom:.95rem; font-weight:700; }
.qfb.ok { background:rgba(45,106,79,.1); color:#065f46; border:1px solid rgba(45,106,79,.3); }
.qfb.no { background:rgba(220,38,38,.08); color:#991b1b; border:1px solid rgba(220,38,38,.2); }
.qres { text-align:center; padding:1.3rem; }
.qsc { font-family:'Playfair Display',serif; font-size:3.4rem; color:var(--primary); font-weight:900; }

/* â”€â”€ LEADERBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.lbt { width:100%; border-collapse:collapse; }
.lbt th {
  background:var(--primary); color:#fff;
  padding:.62rem .95rem; text-align:left;
  font-size:.78rem; font-weight:700; letter-spacing:.03em; text-transform:uppercase;
}
.lbt td { padding:.62rem .95rem; border-bottom:1px solid var(--border); font-size:.85rem; }
.lbt tr:hover td { background:rgba(27,67,50,.04); }

/* â”€â”€ ADMIN LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.adm-layout { display:flex; min-height:calc(100vh - 66px); }
.adm-sb { width:232px; background:var(--pd); display:flex; flex-direction:column; flex-shrink:0; }
.sb-logo {
  padding:.95rem 1.15rem;
  border-bottom:1px solid rgba(255,255,255,.08);
}
.sb-logo .t { font-size:.6rem; color:rgba(255,255,255,.35); text-transform:uppercase; letter-spacing:.08em; margin-bottom:.15rem; }
.sb-logo .n { font-weight:900; font-size:.88rem; color:var(--accent); font-family:'Playfair Display',serif; }
.sb-sl { padding:.8rem 1.15rem .25rem; font-size:.6rem; font-weight:700; color:rgba(255,255,255,.3); text-transform:uppercase; letter-spacing:.08em; }
.sb-ni {
  display:flex; align-items:center; gap:.58rem;
  padding:.62rem 1.15rem; color:rgba(255,255,255,.6);
  cursor:pointer; font-size:.83rem; font-weight:700;
  transition:.18s; letter-spacing:.01em;
}
.sb-ni:hover { background:rgba(255,255,255,.08); color:#fff; }
.sb-ni.on { background:rgba(240,165,0,.13); color:var(--accent); border-right:3px solid var(--accent); }
.sb-ni .ic { font-size:.93rem; width:19px; text-align:center; }
.sb-foot { margin-top:auto; padding:.95rem 1.15rem; border-top:1px solid rgba(255,255,255,.08); }
.adm-main { flex:1; padding:1.6rem; background:var(--bg); overflow-y:auto; }
.as { display:none; } .as.on { display:block; }
.apt {
  font-family:'Playfair Display', serif;
  font-size:1.6rem; color:var(--primary); margin-bottom:1.15rem; font-weight:700;
}

/* â”€â”€ ADMIN TABLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.dt { width:100%; border-collapse:collapse; background:var(--surface); border-radius:12px; overflow:hidden; box-shadow:var(--shadow); }
.dt th {
  background:var(--primary); color:#fff;
  padding:.58rem .95rem; text-align:left;
  font-size:.74rem; font-weight:700; text-transform:uppercase; letter-spacing:.05em;
}
.dt td { padding:.62rem .95rem; border-bottom:1px solid var(--border); font-size:.82rem; vertical-align:middle; }
.dt tr:last-child td { border-bottom:none; }
.dt tr:hover td { background:rgba(27,67,50,.03); }
.tacts { display:flex; gap:.3rem; flex-wrap:wrap; }

/* â”€â”€ ADMIN FORM CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.afc {
  background:var(--surface); border-radius:12px;
  box-shadow:var(--shadow); padding:1.3rem; margin-bottom:1.15rem;
}
.afc-t {
  font-size:.88rem; font-weight:700; color:var(--primary);
  margin-bottom:.85rem; padding-bottom:.42rem; border-bottom:1px solid var(--border);
}

/* â”€â”€ QUIZ BUILDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.qbb { border:1.5px solid var(--border); border-radius:9px; padding:1.05rem; margin-bottom:.85rem; background:var(--surface); }
.qbb-hdr { display:flex; justify-content:space-between; align-items:center; margin-bottom:.68rem; }
.orow {
  display:flex; gap:.5rem; align-items:center; margin-bottom:.48rem;
  background:var(--bg); padding:.42rem .68rem; border-radius:8px;
  border:1.5px solid var(--border); transition:.18s;
}
.orow input[type=radio] { width:auto!important; min-width:15px; height:15px; margin:0; flex-shrink:0; cursor:pointer; accent-color:var(--green); }
.orow .ol { font-size:.74rem; font-weight:700; color:var(--muted); min-width:18px; }
.orow input[type=text] { border:none!important; background:transparent!important; box-shadow:none!important; padding:.12rem .3rem!important; flex:1; font-size:.84rem; }
.orow input[type=text]:focus { outline:none!important; border:none!important; box-shadow:none!important; }
.ohint { font-size:.73rem; color:var(--muted); margin-bottom:.42rem; font-style:italic; }
.orow input[type=checkbox] { width:auto!important; min-width:15px; height:15px; margin:0; flex-shrink:0; cursor:pointer; accent-color:var(--primary); }
.qtype-badge { display:inline-block; padding:.1rem .48rem; border-radius:20px; font-size:.68rem; font-weight:700; text-transform:uppercase; letter-spacing:.04em; }
.qt-mcq  { background:#dbeafe; color:#1e40af; }
.qt-multi { background:#fef9c3; color:#854d0e; }
.qt-long { background:#f3e8ff; color:#6b21a8; }
.qt-tf   { background:#d1fae5; color:#065f46; }
.long-ans { width:100%; min-height:92px; border:1.5px solid var(--border); border-radius:9px; padding:.68rem .9rem; font-size:.9rem; font-family:'Lato',sans-serif; resize:vertical; }
.long-ans:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(27,67,50,.1); }
.long-note { background:#f3e8ff; border:1px solid #d8b4fe; border-radius:8px; padding:.68rem .95rem; font-size:.82rem; color:#6b21a8; margin-bottom:.78rem; }
.multi-note { background:#fef9c3; border:1px solid #fde68a; border-radius:8px; padding:.52rem .78rem; font-size:.79rem; color:#854d0e; margin-bottom:.48rem; }

/* â”€â”€ CONFIRM OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.conf-m {
  background:var(--surface); border-radius:16px;
  padding:1.7rem; max-width:428px; width:100%;
  box-shadow:var(--shadow-lg);
}
.conf-m h3 { font-family:'Playfair Display',serif; font-size:1.25rem; color:var(--primary); margin-bottom:.35rem; }
.conf-m p { color:var(--muted); margin-bottom:1.15rem; font-size:.9rem; }
.conf-acts { display:flex; gap:.65rem; justify-content:flex-end; }

/* â”€â”€ CHIPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.chip { display:inline-block; padding:.12rem .48rem; border-radius:20px; font-size:.7rem; font-weight:700; }
.cg  { background:#D1FAE5; color:#065F46; }
.cr  { background:#FEE2E2; color:#991B1B; }
.cb_ { background:#DBEAFE; color:#1E40AF; }

/* â”€â”€ GAS INFO BOX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.gas-box {
  background:#F0F9FF; border:1px solid #BAE6FD;
  border-radius:9px; padding:.95rem 1.15rem;
  margin-bottom:1.15rem; font-size:.83rem; color:#0C4A6E; line-height:1.78;
}
.gas-box strong { display:block; margin-bottom:.32rem; font-size:.88rem; }
.scm { width:100%; border-collapse:collapse; font-size:.79rem; margin-top:.42rem; }
.scm th { background:var(--primary); color:#fff; padding:.38rem .68rem; text-align:left; }
.scm td { padding:.36rem .68rem; border-bottom:1px solid var(--border); }
.scm tr:last-child td { border-bottom:none; }

/* â”€â”€ SPINNER / EMPTY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.spinner {
  width:34px; height:34px;
  border:3px solid var(--border); border-top-color:var(--primary);
  border-radius:50%; animation:spin .8s linear infinite; margin:2.2rem auto;
}
@keyframes spin { to { transform:rotate(360deg); } }
.empty { text-align:center; padding:2.2rem 1rem; color:var(--muted); }
.ei { font-size:2.4rem; margin-bottom:.68rem; }

/* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toast {
  position:fixed; bottom:1.5rem; right:1.5rem;
  background:var(--primary); color:#fff;
  padding:.8rem 1.4rem; border-radius:9px;
  box-shadow:var(--shadow-lg); z-index:9999;
  font-weight:700; font-size:.84rem;
  animation:slideup .3s ease;
  border-left:4px solid var(--accent);
}
@keyframes slideup { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

/* â”€â”€ ABOUT / INFO PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.about-hero {
  background:linear-gradient(135deg, var(--pd) 0%, var(--primary) 50%, var(--pl) 100%);
  padding:3.2rem 1.6rem; text-align:center; position:relative; overflow:hidden;
}
.about-hero::before {
  content:''; position:absolute; inset:0;
  background:url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Ccircle cx='30' cy='30' r='20'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
}
.about-hero-inner { position:relative; max-width:740px; margin:0 auto; }
.about-hero h1 { font-family:'Playfair Display',serif; font-size:2.5rem; color:#fff; line-height:1.15; margin-bottom:.65rem; font-weight:900; }
.about-hero .tagline { font-size:1.1rem; color:rgba(255,255,255,.82); margin-bottom:1.15rem; font-style:italic; }
.about-hero .hdesc { font-size:.95rem; color:rgba(255,255,255,.65); line-height:1.72; max-width:580px; margin:0 auto; }
.about-hero .hero-badge {
  display:inline-flex; align-items:center; gap:.4rem;
  background:rgba(240,165,0,.18); border:1px solid var(--accent);
  color:var(--accent); padding:.32rem .9rem; border-radius:20px;
  font-size:.78rem; font-weight:700; margin-bottom:1.05rem;
}
.abt-section { max-width:1100px; margin:0 auto; padding:2.2rem 1.6rem; }
.abt-section-t { font-family:'Playfair Display',serif; font-size:1.75rem; color:var(--primary); text-align:center; margin-bottom:.38rem; font-weight:700; }
.abt-section-s { color:var(--muted); font-size:.88rem; text-align:center; margin-bottom:2.1rem; }
.abt-divider { width:60px; height:4px; background:linear-gradient(90deg,var(--primary),var(--accent)); border-radius:2px; margin:.5rem auto 2.1rem; }

/* Feature Cards */
.feat-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:1.15rem; margin-bottom:2.6rem; }
.feat-card {
  background:var(--surface); border:1px solid var(--border); border-radius:var(--radius);
  padding:1.35rem; display:flex; gap:1.05rem; align-items:flex-start;
  transition:.2s; box-shadow:0 2px 8px rgba(0,0,0,.05);
}
.feat-card:hover { box-shadow:var(--shadow); transform:translateY(-2px); }
.feat-icon {
  font-size:1.5rem; width:44px; height:44px; border-radius:10px;
  display:flex; align-items:center; justify-content:center; flex-shrink:0;
}
.feat-card h4 { font-family:'Playfair Display',serif; color:var(--primary); margin-bottom:.2rem; font-size:1rem; }
.feat-card p { color:var(--muted); font-size:.82rem; line-height:1.55; }

/* How It Works */
.hiw-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:1.15rem; margin-bottom:2.6rem; }
.hiw-card {
  background:var(--surface); border:1px solid var(--border); border-radius:var(--radius);
  padding:1.4rem; text-align:center; box-shadow:var(--shadow); transition:.2s;
}
.hiw-card:hover { transform:translateY(-3px); box-shadow:var(--shadow-lg); }
.hiw-num { font-family:'Playfair Display',serif; font-size:2.2rem; font-weight:900; color:var(--accent); line-height:1; margin-bottom:.4rem; }
.hiw-card h4 { font-family:'Playfair Display',serif; color:var(--primary); margin-bottom:.35rem; font-size:1rem; }
.hiw-card p { color:var(--muted); font-size:.82rem; line-height:1.55; }

/* SOP Steps */
.sop-card { display:flex; gap:1rem; margin-bottom:1.1rem; align-items:flex-start; }
.sop-num {
  background:linear-gradient(135deg, var(--primary), var(--pl));
  color:#fff; min-width:40px; height:40px;
  border-radius:10px; display:flex; align-items:center; justify-content:center;
  font-weight:900; font-size:.88rem; flex-shrink:0; letter-spacing:.03em;
}
.sop-card h4 { font-family:'Playfair Display',serif; color:var(--primary); margin-bottom:.2rem; }
.sop-card p { color:var(--muted); font-size:.84rem; line-height:1.55; }

/* Points Table */
.pts-table { width:100%; border-collapse:collapse; font-size:.88rem; }
.pts-table th { background:var(--primary); color:#fff; padding:.6rem 1rem; text-align:left; font-size:.78rem; text-transform:uppercase; letter-spacing:.04em; }
.pts-table td { padding:.6rem 1rem; border-bottom:1px solid var(--border); }
.pts-table tr:last-child td { border-bottom:none; }
.pts-table tr:hover td { background:rgba(27,67,50,.04); }

.about-text-block {
  background:var(--surface); border-left:4px solid var(--accent);
  border-radius:0 12px 12px 0; padding:1.25rem 1.45rem;
  margin-bottom:2.1rem; font-size:.93rem; line-height:1.82;
  color:var(--text); box-shadow:0 2px 8px rgba(0,0,0,.05);
}
.contact-box {
  background:linear-gradient(135deg,rgba(27,67,50,.06),rgba(45,106,79,.1));
  border:1px solid var(--border); border-radius:var(--radius);
  padding:1.6rem; text-align:center; margin-top:2.1rem;
}
.contact-box p { font-size:.88rem; color:var(--muted); line-height:1.72; }

/* â”€â”€ CERTIFICATES PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root {
  --bronze:#CD7F32; --bronze-light:#F5E6D3; --bronze-dark:#8B5A1F;
  --silver:#A8A9AD; --silver-light:#F0F0F2; --silver-dark:#6B6C70;
  --gold:#F0A500;   --gold-light:#FFF8D6;   --gold-dark:#B8860B;
  --plat:#5C6BC0;   --plat-light:#E8EAF6;   --plat-dark:#283593;
}
.cert-milestones { display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:.95rem; margin-bottom:1.55rem; }
.cm { border-radius:var(--radius); padding:1.15rem 1.05rem; text-align:center; border:2.5px solid; position:relative; overflow:hidden; transition:.2s; }
.cm:hover { transform:translateY(-2px); }
.cm-badge { font-size:2.1rem; margin-bottom:.35rem; }
.cm-tier { font-family:'Playfair Display',serif; font-size:1rem; font-weight:700; margin-bottom:.18rem; }
.cm-pts { font-size:.74rem; font-weight:700; margin-bottom:.52rem; }
.cm-status { font-size:.72rem; font-weight:700; padding:.18rem .62rem; border-radius:20px; display:inline-block; }
.cm.bronze { background:var(--bronze-light); border-color:var(--bronze); } .cm.bronze .cm-tier { color:var(--bronze-dark); }
.cm.silver { background:var(--silver-light); border-color:var(--silver); } .cm.silver .cm-tier { color:var(--silver-dark); }
.cm.gold   { background:var(--gold-light);   border-color:var(--gold);   } .cm.gold   .cm-tier { color:var(--gold-dark);   }
.cm.plat   { background:var(--plat-light);   border-color:var(--plat);   } .cm.plat   .cm-tier { color:var(--plat-dark);   }
.cm-earned .cm-status { background:var(--green); color:#fff; }
.cm-locked .cm-status { background:var(--border); color:var(--muted); }
.cm-locked { opacity:.65; }

.cert-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(270px,1fr)); gap:1.05rem; margin-top:1.05rem; }
.cert-card { border-radius:var(--radius); padding:1.25rem; position:relative; overflow:hidden; transition:.2s; border:2px solid; }
.cert-card:hover { transform:translateY(-3px); box-shadow:0 10px 28px rgba(0,0,0,.14); }
.cert-card.bronze { background:var(--bronze-light); border-color:var(--bronze); }
.cert-card.silver { background:var(--silver-light); border-color:var(--silver); }
.cert-card.gold   { background:var(--gold-light);   border-color:var(--gold);   }
.cert-card.plat   { background:var(--plat-light);   border-color:var(--plat);   }
.cert-card-badge { font-size:1.9rem; margin-bottom:.38rem; }
.cert-card-tier { font-family:'Playfair Display',serif; font-size:1.08rem; font-weight:700; margin-bottom:.22rem; }
.cert-card.bronze .cert-card-tier { color:var(--bronze-dark); }
.cert-card.silver .cert-card-tier { color:var(--silver-dark); }
.cert-card.gold   .cert-card-tier { color:var(--gold-dark);   }
.cert-card.plat   .cert-card-tier { color:var(--plat-dark);   }
.cert-card-id   { font-size:.68rem; font-weight:700; color:var(--muted); letter-spacing:.07em; margin-bottom:.52rem; }
.cert-card-pts  { font-size:.82rem; font-weight:700; color:var(--text); margin-bottom:.32rem; }
.cert-card-date { font-size:.73rem; color:var(--muted); }
.cert-card-acts { display:flex; gap:.52rem; margin-top:.88rem; }

/* â”€â”€ CERTIFICATE OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cert-ov { position:fixed; inset:0; background:rgba(0,0,0,.74); z-index:2000; display:flex; align-items:center; justify-content:center; padding:1.05rem; overflow-y:auto; }
.cert-ov-inner { background:#fff; border-radius:var(--radius); max-width:810px; width:100%; box-shadow:var(--shadow-lg); overflow:hidden; }
.cert-ov-bar { padding:.78rem 1.35rem; display:flex; justify-content:space-between; align-items:center; background:var(--bg); border-bottom:1px solid var(--border); }
.cert-ov-bar h3 { font-family:'Playfair Display',serif; color:var(--primary); font-size:1.08rem; }
.cert-ov-acts { display:flex; gap:.58rem; }
#cert-canvas-wrap { padding:1.25rem; background:#E8E4DA; }
.certificate { background:#fff; width:100%; max-width:750px; margin:0 auto; font-family:'Lato',sans-serif; overflow:hidden; position:relative; }
.cert-tier-strip { height:6px; }
.cert-tier-strip.bronze { background:linear-gradient(90deg,var(--bronze-dark),var(--bronze),var(--bronze-dark)); }
.cert-tier-strip.silver { background:linear-gradient(90deg,var(--silver-dark),var(--silver),var(--silver-dark)); }
.cert-tier-strip.gold   { background:linear-gradient(90deg,var(--gold-dark),var(--gold),var(--gold-dark)); }
.cert-tier-strip.plat   { background:linear-gradient(90deg,var(--plat-dark),var(--plat),var(--plat-dark)); }
.cert-hdr { padding:1.35rem 2rem 1.05rem; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--border); }
.cert-hdr-logo { height:54px; width:auto; object-fit:contain; }
.cert-hdr-right { text-align:right; }
.cert-hdr-org { font-family:'Playfair Display',serif; font-size:1.02rem; font-weight:700; color:var(--primary); line-height:1.2; }
.cert-hdr-sub { font-size:.62rem; color:var(--muted); letter-spacing:.1em; text-transform:uppercase; }
.cert-body { padding:1.65rem 2rem 1.25rem; text-align:center; }
.cert-tier-badge-wrap { margin-bottom:.85rem; }
.cert-tier-icon { font-size:2.7rem; line-height:1; }
.cert-tier-label { font-family:'Playfair Display',serif; font-size:.85rem; font-weight:700; letter-spacing:.13em; text-transform:uppercase; display:block; margin-top:.12rem; }
.cert-tier-label.bronze { color:var(--bronze-dark); }
.cert-tier-label.silver { color:var(--silver-dark); }
.cert-tier-label.gold   { color:var(--gold-dark);   }
.cert-tier-label.plat   { color:var(--plat-dark);   }
.cert-title-txt { font-family:'Playfair Display',serif; font-size:1.58rem; color:#1B4332; font-weight:700; margin-bottom:.26rem; line-height:1.2; }
.cert-sub-txt { font-size:.76rem; color:var(--muted); margin-bottom:.62rem; }
.cert-divider { display:flex; align-items:center; gap:.52rem; margin:.52rem auto .72rem; max-width:380px; }
.cert-divider-line { flex:1; height:1px; }
.cert-divider-line.bronze { background:var(--bronze); }
.cert-divider-line.silver { background:var(--silver); }
.cert-divider-line.gold   { background:var(--gold);   }
.cert-divider-line.plat   { background:var(--plat);   }
.cert-divider-dot { width:6px; height:6px; border-radius:50%; }
.cert-divider-dot.bronze { background:var(--bronze); }
.cert-divider-dot.silver { background:var(--silver); }
.cert-divider-dot.gold   { background:var(--gold);   }
.cert-divider-dot.plat   { background:var(--plat);   }
.cert-name { font-family:'Playfair Display',serif; font-size:2.05rem; font-weight:900; color:#1B4332; margin-bottom:.18rem; line-height:1.15; }
.cert-name-line { display:block; width:200px; height:2px; margin:.18rem auto .52rem; }
.cert-name-line.bronze { background:var(--bronze); }
.cert-name-line.silver { background:var(--silver); }
.cert-name-line.gold   { background:var(--gold);   }
.cert-name-line.plat   { background:var(--plat);   }
.cert-pts-txt { font-size:.8rem; color:var(--muted); margin-bottom:.32rem; }
.cert-pts-pill { display:inline-block; padding:.3rem 1.05rem; border-radius:20px; font-size:.82rem; font-weight:700; margin-bottom:.22rem; }
.cert-pts-pill.bronze { background:var(--bronze-light); color:var(--bronze-dark); border:1.5px solid var(--bronze); }
.cert-pts-pill.silver { background:var(--silver-light); color:var(--silver-dark); border:1.5px solid var(--silver); }
.cert-pts-pill.gold   { background:var(--gold-light);   color:var(--gold-dark);   border:1.5px solid var(--gold);   }
.cert-pts-pill.plat   { background:var(--plat-light);   color:var(--plat-dark);   border:1.5px solid var(--plat);   }
.cert-ftr { padding:.62rem 1.6rem 1.15rem; text-align:center; }
.cert-ftr-issued { font-size:.72rem; color:var(--muted); margin-bottom:.52rem; }
.cert-meta { background:#F5F3EE; border-top:1px solid #E0DBD0; padding:.42rem 2rem; display:flex; justify-content:space-between; }
.cert-meta span { font-size:.6rem; color:#9AAAB5; letter-spacing:.04em; }
.cert-meta .cert-id-pill { background:#E0DBD0; padding:.08rem .42rem; border-radius:3px; font-weight:700; color:#6B5A30; font-size:.59rem; }

@media print {
  body>*:not(.cert-ov) { display:none!important; }
  .cert-ov { position:static; background:none; padding:0; display:block; }
  .cert-ov-inner { box-shadow:none; border-radius:0; }
  .cert-ov-bar, .cert-ov-acts { display:none!important; }
  #cert-canvas-wrap { padding:0; background:#fff; }
  @page { margin:.25in; size:A4 landscape; }
}

.cert-pts-progress { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:1.25rem 1.55rem; margin-bottom:1.25rem; }
.cert-pts-progress h3 { font-family:'Playfair Display',serif; color:var(--primary); margin-bottom:.72rem; font-size:1.08rem; }
.tier-row { display:flex; align-items:center; gap:.85rem; margin-bottom:.52rem; }
.tier-row-icon { font-size:1.2rem; width:28px; text-align:center; }
.tier-row-label { font-size:.8rem; font-weight:700; width:70px; }
.tier-row-bar { flex:1; background:var(--border); border-radius:999px; height:8px; overflow:hidden; }
.tier-row-fill { height:100%; border-radius:999px; transition:width .6s ease; }
.tier-row-fill.bronze { background:var(--bronze); }
.tier-row-fill.silver { background:var(--silver); }
.tier-row-fill.gold   { background:var(--gold);   }
.tier-row-fill.plat   { background:var(--plat);   }
.tier-row-pts { font-size:.72rem; color:var(--muted); width:80px; text-align:right; }

/* â”€â”€ ADMIN INFO EDITOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.info-ed-tab { display:flex; gap:.42rem; flex-wrap:wrap; margin-bottom:1.15rem; }
.iet { padding:.42rem .95rem; border:1.5px solid var(--border); border-radius:8px; font-size:.8rem; font-weight:700; cursor:pointer; background:var(--surface); color:var(--muted); transition:.18s; }
.iet.on { background:var(--primary); color:#fff; border-color:var(--primary); }
.iet:hover:not(.on) { border-color:var(--primary); color:var(--primary); }
.ie-section { display:none; } .ie-section.on { display:block; }
.step-ed { background:var(--bg); border:1.5px solid var(--border); border-radius:10px; padding:1.05rem; margin-bottom:.72rem; position:relative; }
.step-ed-hdr { display:flex; justify-content:space-between; align-items:center; margin-bottom:.68rem; }
.step-ed-num { background:var(--primary); color:#fff; padding:.15rem .58rem; border-radius:6px; font-size:.75rem; font-weight:700; }

/* â”€â”€ TABLET (â‰¤768px) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media(max-width:768px) {
  .wrap { padding:1.05rem; }
  .hdr { padding:0 .95rem; }
  .hdr-brand h1 { font-size:1.08rem; }
  .hdr-brand p { display:none; }
  .nav-grid { grid-template-columns:repeat(2,1fr); gap:.75rem; }
  .nc { padding:1.05rem .85rem; }
  .cgrid { grid-template-columns:1fr; }
  .cc { padding:.88rem; }
  .ctitle { font-size:.92rem; }
  .stats { grid-template-columns:repeat(2,1fr); }
  .cert-ov { padding:.42rem; }
  .cert-ov-inner { border-radius:10px; }
  .cert-ov-bar { padding:.62rem .95rem; flex-wrap:wrap; gap:.42rem; }
  .cert-hdr { padding:.95rem 1.05rem; }
  .cert-hdr-logo { height:40px; }
  .cert-body { padding:1.05rem .95rem .85rem; }
  .cert-meta { padding:.32rem .95rem; flex-direction:column; gap:.18rem; }
  .cert-name { font-size:1.52rem; }
  .about-hero h1 { font-size:1.75rem; }
  .about-hero .tagline { font-size:.92rem; }
  .hiw-grid { grid-template-columns:1fr 1fr; }
  .feat-grid { grid-template-columns:1fr; }
  .sop-card { flex-direction:column; gap:.78rem; }
  .cert-milestones { grid-template-columns:repeat(2,1fr); }
  .cert-pts-progress { padding:.95rem 1.05rem; }
  .cacts { flex-wrap:wrap; gap:.38rem; }
  .auth-wrap { margin:1.25rem auto; }
  .adm-layout { flex-direction:column; }
  .adm-sb { width:100%; flex-direction:row; overflow-x:auto; padding:.42rem; }
  .sb-sl, .sb-foot, .sb-logo { display:none; }
  .sb-ni { flex-direction:column; padding:.38rem .52rem; font-size:.68rem; gap:.14rem; min-width:58px; }
  .sb-ni .ic { font-size:.85rem; }
  .form-row { grid-template-columns:1fr; }
}

/* â”€â”€ PHONE (â‰¤480px) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media(max-width:480px) {
  .hdr-brand img { height:32px; }
  .hdr-brand h1 { font-size:.95rem; }
  .pts { font-size:.68rem; padding:.12rem .42rem; }
  .btn-hdr { font-size:.72rem; padding:.26rem .68rem; }
  .nav-grid { grid-template-columns:repeat(2,1fr); gap:.52rem; }
  .nc { padding:.88rem .65rem; }
  .nc h3 { font-size:.86rem; }
  .nc .nc-icon { font-size:1.55rem; }
  .ncb { font-size:.65rem; }
  .sec-t { font-size:1.22rem; }
  .ctitle { font-size:.88rem; }
  .ctag { font-size:.62rem; }
  .cdesc { font-size:.78rem; }
  .btn.sm { font-size:.73rem; padding:.28rem .68rem; }
  .cert-milestones { grid-template-columns:repeat(2,1fr); }
  .cert-name { font-size:1.28rem; }
  .cert-tier-icon { font-size:2.1rem; }
  .cert-title-txt { font-size:1.22rem; }
  .cert-ov-bar h3 { font-size:.88rem; }
  .cert-ov-acts .btn { font-size:.72rem; padding:.28rem .62rem; }
  .hiw-grid { grid-template-columns:1fr; }
  .tier-row-label { width:54px; font-size:.7rem; }
  .tier-row-pts { width:66px; font-size:.65rem; }
  .bk { font-size:.8rem; }
  .about-hero h1 { font-size:1.45rem; }
}

</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
</head>
<!-- HEADER -->
<header>
<div class="hdr">
  <div class="hdr-brand">
    <img src="1771142939250_B4C_Main_logo-01_Small.png" alt="B4C" onerror="this.style.display='none'">
    <div><h1>Bridge4Change Foundation</h1><p>Learning Portal</p></div>
  </div>
  <div class="hdr-r" id="hdr-r">
    <div style="display:flex;align-items:center;gap:.5rem">
      <div class="avatar" id="hdr-av">?</div>
      <span class="uname" id="hdr-nm"></span>
      <span class="pts" id="hdr-pts" style="display:none"></span>
    </div>
    <button class="btn-hdr" id="hdr-out" onclick="logout()">Logout</button>
  </div>
</div>
</header>

<!-- ===== AUTH ===== -->
<div id="pg-auth" class="pg on">
<div class="auth-wrap">
<div class="card"><div class="cb">
  <div class="auth-logo"><img src="1771142939250_B4C_Main_logo-01_Small.png" alt="B4C" onerror="this.style.display='none'"></div>
  <div class="card-h">Welcome!</div>
  <div class="card-s">Sign in to start learning</div>
  <div class="tabs" id="atabs">
    <div class="tab on" onclick="atab('in')">Sign In</div>
    <div class="tab" onclick="atab('up')">Sign Up</div>
  </div>
  <!-- SIGN IN -->
  <form id="fin">
    <div class="fg"><label>Email</label><input type="email" id="ie" placeholder="you@example.com" required></div>
    <div class="fg"><label>Password</label><input type="password" id="ip" placeholder="Your password" required><span class="eye" onclick="eye('ip')">ğŸ‘</span></div>
    <div style="text-align:right;margin:-.2rem 0 .75rem"><a href="#" onclick="showPg('pg-reset');return false" style="color:var(--accent);font-size:.79rem">Forgot password?</a></div>
    <div id="ie-err" class="alert err hidden"></div>
    <button type="submit" class="btn bp bw" id="in-btn">Sign In</button>
    <p style="text-align:center;margin-top:.8rem;font-size:.79rem;color:var(--muted)">Admin? <a href="#" onclick="showPg('pg-adm-login');return false" style="color:var(--purple)">Admin Login â†’</a></p>
  </form>
  <!-- SIGN UP -->
  <form id="fup" class="hidden">
    <div class="fg"><label>Full Name *</label><input type="text" id="un" placeholder="Your name" required></div>
    <div class="fg"><label>Email *</label><input type="email" id="ue" placeholder="you@example.com" required></div>
    <div class="fg"><label>Password *</label><input type="password" id="up-p" placeholder="Min 6 characters" minlength="6" required><span class="eye" onclick="eye('up-p')">ğŸ‘</span></div>
    <div class="fg"><label>Institution / Organization *</label><input type="text" id="ui" placeholder="Your institution" required></div>
    <div class="fg"><label>Batch / Cohort</label><input type="text" id="uc" placeholder="e.g. Spring 2025"></div>
    <div id="up-err" class="alert err hidden"></div>
    <button type="submit" class="btn bp bw" id="up-btn">Create Account</button>
  </form>
</div></div>
</div>
</div>

<!-- ===== ADMIN LOGIN ===== -->
<div id="pg-adm-login" class="pg">
<div class="auth-wrap">
<div class="card"><div class="cb">
  <div style="text-align:center;margin-bottom:1.1rem"><div style="font-size:2rem">ğŸ›¡ï¸</div>
    <div class="card-h">Admin Portal</div><div class="card-s">Secure admin access</div>
  </div>
  <form id="fadm">
    <div class="fg"><label>Username</label><input type="text" id="au" placeholder="admin" required></div>
    <div class="fg"><label>Password</label><input type="password" id="ap" placeholder="Admin password" required><span class="eye" onclick="eye('ap')">ğŸ‘</span></div>
    <div id="adm-err" class="alert err hidden"></div>
    <button type="submit" class="btn badm bw">Access Admin Panel</button>
    <p style="text-align:center;margin-top:.8rem;font-size:.79rem"><a href="#" onclick="showPg('pg-auth');return false" style="color:var(--muted)">â† Back to Student Login</a></p>
  </form>
</div></div>
</div>
</div>

<!-- ===== PASSWORD RESET ===== -->
<div id="pg-reset" class="pg">
<div class="auth-wrap">
<div class="card"><div class="cb">
  <div class="card-h">Reset Password</div>
  <div class="card-s">Enter your email and a new password</div>
  <div class="fg"><label>Email Address</label><input type="email" id="rs-e" placeholder="your@email.com"></div>
  <div class="fg"><label>New Password</label><input type="password" id="rs-p1" placeholder="Min 6 characters"></div>
  <div class="fg"><label>Confirm Password</label><input type="password" id="rs-p2" placeholder="Confirm password"></div>
  <div id="rs-msg"></div>
  <button class="btn bp bw" onclick="doReset()">Reset Password</button>
  <p style="text-align:center;margin-top:.8rem;font-size:.79rem"><a href="#" onclick="showPg('pg-auth');return false" style="color:var(--muted)">â† Back to Sign In</a></p>
</div></div>
</div>
</div>

<!-- ===== STUDENT DASHBOARD ===== -->
<div id="pg-dash" class="pg">
<div class="wrap">
  <div class="card" style="margin-bottom:1.1rem"><div class="cb">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:.65rem">
      <div><h2 id="dw" style="font-family:\'Crimson Pro\',serif;font-size:1.5rem;color:var(--primary)">Welcome back! ğŸ‘‹</h2>
        <p style="color:var(--muted)">Continue your learning journey</p></div>
      <div style="text-align:right">
        <div style="font-size:.72rem;color:var(--muted)">Your Rank</div>
        <div id="drk" style="font-family:\'Crimson Pro\',serif;font-size:1.8rem;font-weight:700;color:var(--primary)">#â€“</div>
      </div>
    </div>
    <div style="margin-top:.8rem">
      <div style="display:flex;justify-content:space-between;font-size:.75rem;color:var(--muted);margin-bottom:.2rem">
        <span>Overall Progress</span><span id="dpct">0%</span>
      </div>
      <div class="pb-w"><div class="pb-f" id="dpb" style="width:0%"></div></div>
    </div>
  </div></div>
  <div class="stats" id="dsts"></div>
  <div class="nav-grid">
    <div class="nc" onclick="showPg('pg-vids')"><div class="nc-icon">ğŸ¬</div><h3>Videos</h3><p>Watch learning videos</p><span class="ncb" id="dvc">â€“ Videos</span></div>
    <div class="nc" onclick="showPg('pg-arts')"><div class="nc-icon">ğŸ“š</div><h3>Articles</h3><p>Read insightful articles</p><span class="ncb" id="dac">â€“ Articles</span></div>
    <div class="nc" onclick="showPg('pg-prog')"><div class="nc-icon">ğŸ“Š</div><h3>My Progress</h3><p>Track your journey</p><span class="ncb" id="dcc">0 Completed</span></div>
    <div class="nc" onclick="showPg('pg-lb')"><div class="nc-icon">ğŸ†</div><h3>Leaderboard</h3><p>See top learners</p><span class="ncb">Rankings</span></div>
    <div class="nc" onclick="showPg('pg-certs')"><div class="nc-icon">ğŸ…</div><h3>My Certificates</h3><p>Download your certificates</p><span class="ncb" id="dct" style="background:var(--accent);color:var(--primary)">0 Earned</span></div>
    <div class="nc" onclick="showPg('pg-about')"><div class="nc-icon">â„¹ï¸</div><h3>About Portal</h3><p>How it works &amp; SOP guide</p><span class="ncb" style="background:var(--accent);color:var(--primary)">Read Guide</span></div>
  </div>
</div>
</div>

<!-- ===== VIDEOS PAGE ===== -->
<div id="pg-vids" class="pg">
<div class="wrap">
  <div class="bk" onclick="showPg('pg-dash')">â† Back to Dashboard</div>
  <div class="sec-hdr"><h2 class="sec-t">ğŸ¬ Videos to Watch</h2></div>
  <div class="fbar">
    <div class="fg"><label>Theme</label><select id="vthf" onchange="renVids()"><option value="">All Themes</option></select></div>
    <div class="fg"><label>Search</label><input type="text" id="vsf" placeholder="Search videosâ€¦" oninput="renVids()"></div>
  </div>
  <div class="cgrid" id="vgrid"></div>
</div>
</div>

<!-- ===== ARTICLES PAGE ===== -->
<div id="pg-arts" class="pg">
<div class="wrap">
  <div class="bk" onclick="showPg('pg-dash')">â† Back to Dashboard</div>
  <div class="sec-hdr"><h2 class="sec-t">ğŸ“š Articles to Read</h2></div>
  <div class="fbar">
    <div class="fg"><label>Theme</label><select id="athf" onchange="renArts()"><option value="">All Themes</option></select></div>
    <div class="fg"><label>Search</label><input type="text" id="asf" placeholder="Search articlesâ€¦" oninput="renArts()"></div>
  </div>
  <div class="cgrid" id="agrid"></div>
</div>
</div>

<!-- ===== PROGRESS PAGE ===== -->
<div id="pg-prog" class="pg">
<div class="wrap">
  <div class="bk" onclick="showPg('pg-dash')">â† Back to Dashboard</div>
  <h2 class="sec-t" style="margin-bottom:1.1rem">ğŸ“Š My Progress</h2>
  <div class="stats" id="psts"></div>
  <div class="card" style="margin-bottom:1.1rem"><div class="cb">
    <h3 style="font-family:\'Crimson Pro\',serif;color:var(--primary);margin-bottom:.8rem">Quiz History</h3>
    <div id="qhist"></div>
  </div></div>
  <div class="card"><div class="cb">
    <h3 style="font-family:\'Crimson Pro\',serif;color:var(--primary);margin-bottom:.8rem">Completed Content</h3>
    <div class="cgrid" id="donec"></div>
  </div></div>
</div>
</div>

<!-- ===== LEADERBOARD ===== -->
<div id="pg-lb" class="pg">
<div class="wrap">
  <div class="bk" onclick="showPg('pg-dash')">â† Back to Dashboard</div>
  <h2 class="sec-t" style="margin-bottom:1.1rem">ğŸ† Leaderboard</h2>
  <div class="card"><div class="cb" id="lb-body"><div class="spinner"></div></div></div>
</div>
</div>

<!-- ===== CERTIFICATES PAGE ===== -->
<div id="pg-certs" class="pg">
<div class="wrap">
  <div class="bk" onclick="showPg('pg-dash')">â† Back to Dashboard</div>
  <div class="sec-hdr" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:.6rem;margin-bottom:1rem">
    <h2 class="sec-t">ğŸ… My Certificates</h2>
    <button class="btn bg_" onclick="loadMyCerts()">ğŸ”„ Refresh</button>
  </div>

  <!-- Tier milestone cards -->
  <div class="cert-milestones" id="cert-milestones"></div>

  <!-- Points progress bars -->
  <div class="cert-pts-progress" id="cert-pts-progress">
    <h3>ğŸ¯ Your Points Journey</h3>
    <div id="cert-tier-bars"></div>
  </div>

  <!-- Earned certificates -->
  <div id="cert-pg-list"></div>
</div>
</div>

<!-- ===== CERTIFICATE OVERLAY ===== -->
<div class="cert-ov hidden" id="cert-ov">
<div class="cert-ov-inner">
  <div class="cert-ov-bar">
    <div style="display:flex;align-items:center;gap:.7rem">
      <button class="btn bg_ sm" onclick="closeCertOv()">â† Back</button>
      <h3 id="cert-ov-title">ğŸ… Certificate</h3>
    </div>
    <div class="cert-ov-acts">
      <button class="btn ba sm" onclick="printCert()">ğŸ–¨ Print / PDF</button>
      <button class="btn bp sm" id="dl-cert-btn" onclick="downloadCert()">â¬‡ Download Image</button>
    </div>
  </div>
  <div id="cert-canvas-wrap"></div>
</div>
</div>



<div id="pg-about" class="pg">

  <!-- Hero -->
  <div class="about-hero">
    <div class="about-hero-inner">
      <div class="hero-badge" id="ab-badge">ğŸŒ Bridge4Change Foundation</div>
      <h1 id="ab-hero-title">Bridge4Change Learning Portal</h1>
      <div class="tagline" id="ab-tagline">Empowering changemakers through knowledge, skills &amp; community.</div>
      <div class="hdesc" id="ab-hero-desc">Welcome to the official Bridge4Change Foundation learning platform â€” a space designed for fellows, volunteers, and partners to grow, learn, and lead change together.</div>
    </div>
  </div>

  <!-- About -->
  <div class="abt-section">
    <div class="bk" onclick="showPg('pg-dash')" style="margin-bottom:1.5rem">â† Back to Dashboard</div>

    <h2 class="abt-section-t" id="ab-about-title">About This Portal</h2>
    <div class="abt-divider"></div>
    <div class="about-text-block" id="ab-about-text">Loadingâ€¦</div>

    <!-- Features / Why Join -->
    <h2 class="abt-section-t">Why Join?</h2>
    <div class="abt-section-s">Everything you need to grow as a changemaker â€” in one place.</div>
    <div class="abt-divider"></div>
    <div class="feat-grid" id="ab-features"></div>

    <!-- How It Works -->
    <h2 class="abt-section-t">How It Works</h2>
    <div class="abt-section-s">Four simple steps to make the most of your learning journey.</div>
    <div class="abt-divider"></div>
    <div class="hiw-grid" id="ab-hiw"></div>

    <!-- SOP -->
    <div style="background:var(--surface);border-radius:16px;padding:2rem;margin-bottom:2.5rem;box-shadow:0 2px 12px rgba(0,0,0,.07);">
      <h2 class="abt-section-t" id="ab-sop-title" style="text-align:left;margin-bottom:.2rem;">Standard Operating Procedure</h2>
      <p style="color:var(--muted);font-size:.87rem;margin-bottom:1.5rem" id="ab-sop-sub">Follow these steps to get the most out of the portal.</p>
      <div id="ab-sop"></div>
    </div>

    <!-- Points Guide -->
    <h2 class="abt-section-t">Points &amp; Rewards Guide</h2>
    <div class="abt-section-s">Earn points for every action you take. More points = higher rank!</div>
    <div class="abt-divider"></div>
    <div style="margin-bottom:2.5rem;overflow-x:auto;">
      <table class="pts-table">
        <thead><tr><th>Activity</th><th>Points Earned</th></tr></thead>
        <tbody id="ab-pts"></tbody>
      </table>
    </div>

    <!-- Badge Guide -->
    <h2 class="abt-section-t">Badge Levels</h2>
    <div class="abt-section-s">Collect points to unlock higher badges and recognition.</div>
    <div class="abt-divider"></div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:.9rem;margin-bottom:2.5rem;">
      <div class="feat-card" style="flex-direction:column;align-items:center;text-align:center;gap:.4rem;">
        <div style="font-size:2rem">ğŸŒ±</div>
        <h4 style="color:var(--primary)">Beginner</h4>
        <p>0 â€“ 49 points</p>
      </div>
      <div class="feat-card" style="flex-direction:column;align-items:center;text-align:center;gap:.4rem;">
        <div style="font-size:2rem">â­</div>
        <h4 style="color:var(--primary)">Rising Star</h4>
        <p>50 â€“ 99 points</p>
      </div>
      <div class="feat-card" style="flex-direction:column;align-items:center;text-align:center;gap:.4rem;">
        <div style="font-size:2rem">ğŸ¥‰</div>
        <h4 style="color:var(--primary)">Bronze</h4>
        <p>100 â€“ 299 points</p>
      </div>
      <div class="feat-card" style="flex-direction:column;align-items:center;text-align:center;gap:.4rem;">
        <div style="font-size:2rem">ğŸ¥ˆ</div>
        <h4 style="color:var(--primary)">Silver</h4>
        <p>300 â€“ 499 points</p>
      </div>
      <div class="feat-card" style="flex-direction:column;align-items:center;text-align:center;gap:.4rem;">
        <div style="font-size:2rem">ğŸ¥‡</div>
        <h4 style="color:var(--primary)">Gold</h4>
        <p>500+ points</p>
      </div>
    </div>

    <!-- Contact -->
    <div class="contact-box">
      <div style="font-size:1.8rem;margin-bottom:.5rem">ğŸ’¬</div>
      <h3 style="font-family:\'Crimson Pro\',serif;font-size:1.2rem;color:var(--primary);margin-bottom:.5rem">Need Help?</h3>
      <p id="ab-contact"></p>
    </div>

    <p style="text-align:center;color:var(--muted);font-size:.75rem;margin-top:1.5rem;padding-bottom:1rem" id="ab-footer"></p>
  </div>
</div>


<div id="pg-admin" class="pg">
<div class="adm-layout">
  <div class="adm-sb">
    <div class="sb-logo"><div class="t">Admin Panel</div><div class="n">Bridge4Change</div></div>
    <div class="sb-sl">Overview</div>
    <div class="sb-ni on" data-s="as-ov" onclick="gadm(this,'as-ov')"><span class="ic">ğŸ“Š</span>Dashboard</div>
    <div class="sb-ni" data-s="as-us" onclick="gadm(this,'as-us')"><span class="ic">ğŸ‘¥</span>Students</div>
    <div class="sb-sl">Content</div>
    <div class="sb-ni" data-s="as-vd" onclick="gadm(this,'as-vd')"><span class="ic">ğŸ¬</span>Videos</div>
    <div class="sb-ni" data-s="as-ar" onclick="gadm(this,'as-ar')"><span class="ic">ğŸ“š</span>Articles</div>
    <div class="sb-sl">Quizzes</div>
    <div class="sb-ni" data-s="as-qz" onclick="gadm(this,'as-qz')"><span class="ic">ğŸ“</span>Quiz Manager</div>
    <div class="sb-ni" data-s="as-at" onclick="gadm(this,'as-at')"><span class="ic">ğŸ“‹</span>Attempts</div>
    <div class="sb-sl">Manage</div>
    <div class="sb-ni" data-s="as-lb" onclick="gadm(this,'as-lb')"><span class="ic">ğŸ†</span>Leaderboard</div>
    <div class="sb-ni" data-s="as-pi" onclick="gadm(this,'as-pi')"><span class="ic">â„¹ï¸</span>Portal Info</div>
    <div class="sb-ni" data-s="as-cert-cfg" onclick="gadm(this,'as-cert-cfg')"><span class="ic">ğŸ…</span>Certificates</div>
    <div class="sb-ni" data-s="as-st" onclick="gadm(this,'as-st')"><span class="ic">âš™ï¸</span>Settings</div>
    <div class="sb-foot"><button class="btn bg_ sm" onclick="admLogout()" style="width:100%;color:#fff;border-color:rgba(255,255,255,.25)">Logout</button></div>
  </div>
  <div class="adm-main">
    <!-- OVERVIEW -->
    <div class="as on" id="as-ov">
      <h2 class="apt">ğŸ“Š Admin Dashboard</h2>
      <div class="stats" id="adm-sts"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-top:1rem">
        <div class="card"><div class="cb"><h3 style="font-family:\'Crimson Pro\',serif;color:var(--primary);margin-bottom:.6rem">Top 5 Students</h3><div id="top5"></div></div></div>
        <div class="card"><div class="cb"><h3 style="font-family:\'Crimson Pro\',serif;color:var(--primary);margin-bottom:.6rem">Recent Activity</h3><div id="recact"></div></div></div>
      </div>
    </div>
    <!-- STUDENTS -->
    <div class="as" id="as-us">
      <h2 class="apt">ğŸ‘¥ All Students</h2>
      <div style="display:flex;gap:.6rem;margin-bottom:.9rem;flex-wrap:wrap">
        <button class="btn bg_" onclick="loadAdmStudents()">ğŸ”„ Refresh from Sheet</button>
      </div>
      <div class="fbar" style="margin-bottom:.9rem"><div class="fg"><label>Search</label><input type="text" id="usrch" placeholder="Name or emailâ€¦" oninput="renUsers()"></div></div>
      <div id="u-loading" class="hidden"><div class="spinner"></div></div>
      <div class="card"><div style="overflow-x:auto"><table class="dt">
        <thead><tr><th>Name</th><th>Email</th><th>Institution</th><th>Cohort</th><th>Points</th><th>Joined</th><th>Adjust</th></tr></thead>
        <tbody id="u-tb"></tbody>
      </table></div></div>
    </div>
    <!-- VIDEOS ADMIN -->
    <div class="as" id="as-vd">
      <h2 class="apt">ğŸ¬ Manage Videos</h2>
      <div class="afc">
        <div class="afc-t" id="vf-t">â• Add New Video</div>
        <input type="hidden" id="vf-id">
        <div class="form-row">
          <div class="fg"><label>Title *</label><input type="text" id="vf-ti" placeholder="e.g. Documentary â€“ Breaking Boundaries"></div>
          <div class="fg"><label>Theme / Category</label><input type="text" id="vf-th" placeholder="e.g. Climate Change"></div>
        </div>
        <div class="form-row">
          <div class="fg"><label>Video URL * (YouTube / Vimeo / Dailymotion)</label><input type="url" id="vf-ur" placeholder="https://www.youtube.com/watch?v=..."></div>
          <div class="fg"><label>Duration</label><input type="text" id="vf-du" placeholder="e.g. 1:14:00"></div>
        </div>
        <div class="fg"><label>Description (optional)</label><textarea id="vf-de" rows="2" placeholder="Brief descriptionâ€¦"></textarea></div>
        <div style="display:flex;gap:.6rem">
          <button class="btn bp" onclick="saveVid()">ğŸ’¾ Save Video</button>
          <button class="btn bg_" onclick="clrVid()">Cancel</button>
        </div>
      </div>
      <div class="card"><div style="overflow-x:auto"><table class="dt">
        <thead><tr><th>Title</th><th>Theme</th><th>Duration</th><th>Has Quiz</th><th>Actions</th></tr></thead>
        <tbody id="vf-tb"></tbody>
      </table></div></div>
    </div>
    <!-- ARTICLES ADMIN -->
    <div class="as" id="as-ar">
      <h2 class="apt">ğŸ“š Manage Articles</h2>
      <div class="afc">
        <div class="afc-t" id="af-t">â• Add New Article</div>
        <input type="hidden" id="af-id">
        <div class="form-row">
          <div class="fg"><label>Title *</label><input type="text" id="af-ti" placeholder="Article title"></div>
          <div class="fg"><label>Theme / Category</label><input type="text" id="af-th" placeholder="e.g. Sustainability"></div>
        </div>
        <div class="form-row">
          <div class="fg"><label>Article URL *</label><input type="url" id="af-ur" placeholder="https://..."></div>
          <div class="fg"><label>Read Time</label><input type="text" id="af-du" placeholder="e.g. 15 min read"></div>
        </div>
        <div class="fg"><label>Description (optional)</label><textarea id="af-de" rows="2" placeholder="Brief descriptionâ€¦"></textarea></div>
        <div style="display:flex;gap:.6rem">
          <button class="btn bp" onclick="saveArt()">ğŸ’¾ Save Article</button>
          <button class="btn bg_" onclick="clrArt()">Cancel</button>
        </div>
      </div>
      <div class="card"><div style="overflow-x:auto"><table class="dt">
        <thead><tr><th>Title</th><th>Theme</th><th>Read Time</th><th>Has Quiz</th><th>Actions</th></tr></thead>
        <tbody id="af-tb"></tbody>
      </table></div></div>
    </div>
    <!-- QUIZ MANAGER -->
    <div class="as" id="as-qz">
      <h2 class="apt">ğŸ“ Quiz Manager</h2>
      <div class="afc">
        <div class="afc-t" id="qf-t">Create New Quiz</div>
        <input type="hidden" id="qf-id">
        <div class="form-row">
          <div class="fg"><label>Quiz Title *</label><input type="text" id="qf-nm" placeholder="e.g. Climate Change Quiz"></div>
          <div class="fg"><label>Points per correct answer</label><input type="number" id="qf-pt" value="10" min="1"></div>
        </div>
        <div class="form-row">
          <div class="fg">
            <label>Link this quiz to</label>
            <select id="qf-ct" onchange="refDrop()">
              <option value="video">A Video</option>
              <option value="article">An Article</option>
              <option value="standalone">Standalone (no content link)</option>
            </select>
          </div>
          <div class="fg" id="qf-lw">
            <label>Select the Video / Article</label>
            <select id="qf-ci"></select>
          </div>
        </div>
        <div class="fg" style="display:flex;align-items:center;gap:.45rem;margin-bottom:.65rem">
          <input type="checkbox" id="qf-re" style="width:auto">
          <label for="qf-re" style="margin:0;cursor:pointer;font-size:.85rem">Allow students to re-attempt this quiz</label>
        </div>
        <div style="border-top:1px solid var(--border);padding-top:.8rem;margin-top:.1rem">
          <div style="margin-bottom:.75rem">
            <strong style="color:var(--primary);font-size:.9rem;display:block;margin-bottom:.5rem">Add Questions</strong>
            <div style="display:flex;gap:.4rem;flex-wrap:wrap">
              <button class="btn bg_ sm" type="button" onclick="addQ(null,'mcq')">&#43; Single Answer (MCQ)</button>
              <button class="btn bg_ sm" type="button" onclick="addQ(null,'multi')" style="color:#F59E0B;border-color:#F59E0B">&#43; Multiple Correct Answers</button>
              <button class="btn bg_ sm" type="button" onclick="addQ(null,'long')" style="color:#7C3AED;border-color:#7C3AED">&#43; Long Answer</button>
              <button class="btn bg_ sm" type="button" onclick="addQ(null,'tf')" style="color:#065f46;border-color:#059669">&#43; True / False</button>
            </div>
          </div>
          <div id="qf-qw"><p class="ohint" style="margin:0">Click one of the buttons above to add a question.</p></div>
        </div>
        <div style="display:flex;gap:.6rem;margin-top:.9rem">
          <button class="btn bp" onclick="saveQuiz()">ğŸ’¾ Save Quiz</button>
          <button class="btn bg_" onclick="clrQz()">Cancel</button>
        </div>
      </div>
      <div class="card"><div style="overflow-x:auto"><table class="dt">
        <thead><tr><th>Title</th><th>Linked To</th><th>Questions</th><th>Pts Each</th><th>Re-attempt</th><th>Actions</th></tr></thead>
        <tbody id="qf-tb"></tbody>
      </table></div></div>
    </div>
    <!-- ATTEMPTS -->
    <div class="as" id="as-at">
      <h2 class="apt">ğŸ“‹ Quiz Attempts</h2>
      <div class="card"><div style="overflow-x:auto"><table class="dt">
        <thead><tr><th>Date</th><th>Student</th><th>Quiz</th><th>Score</th><th>Points</th></tr></thead>
        <tbody id="at-tb"></tbody>
      </table></div></div>
    </div>
    <!-- LEADERBOARD ADMIN -->
    <div class="as" id="as-lb">
      <h2 class="apt">ğŸ† Leaderboard Management</h2>
      <div style="display:flex;gap:.6rem;margin-bottom:1.1rem;flex-wrap:wrap">
        <button class="btn bd" onclick="confReset()">Reset All Points to 0</button>
        <button class="btn bg_" onclick="loadAdmLb()">ğŸ”„ Refresh from Sheet</button>
      </div>
      <div class="card"><div style="overflow-x:auto"><table class="dt">
        <thead><tr><th>Rank</th><th>Name</th><th>Email</th><th>Points</th><th>Adjust</th></tr></thead>
        <tbody id="lb-tb"></tbody>
      </table></div></div>
    </div>
    <!-- PORTAL INFO EDITOR -->
    <div class="as" id="as-pi">
      <h2 class="apt">â„¹ï¸ Portal Info Editor</h2>
      <div class="alert info" style="margin-bottom:1.1rem">
        âœï¸ Edit the content that students see on the <strong>About Portal</strong> page. Changes are saved to Google Sheets and visible to all users immediately after saving.
      </div>

      <!-- Tab switcher -->
      <div class="info-ed-tab">
        <div class="iet on" onclick="piTab(this,'pi-hero')">ğŸ  Hero</div>
        <div class="iet" onclick="piTab(this,'pi-about')">ğŸ“„ About</div>
        <div class="iet" onclick="piTab(this,'pi-features')">â­ Features</div>
        <div class="iet" onclick="piTab(this,'pi-hiw')">ğŸªœ How It Works</div>
        <div class="iet" onclick="piTab(this,'pi-sop')">ğŸ“‹ SOP Steps</div>
        <div class="iet" onclick="piTab(this,'pi-pts')">ğŸ¯ Points Guide</div>
        <div class="iet" onclick="piTab(this,'pi-contact')">ğŸ’¬ Contact</div>
      </div>

      <!-- â”€â”€ HERO â”€â”€ -->
      <div class="ie-section on" id="pi-hero">
        <div class="afc">
          <div class="afc-t">Hero Section</div>
          <div class="fg"><label>Portal Title</label><input type="text" id="pi-hero-title" placeholder="Bridge4Change Learning Portal"></div>
          <div class="fg"><label>Tagline (italic subtitle)</label><input type="text" id="pi-hero-tagline" placeholder="Empowering changemakersâ€¦"></div>
          <div class="fg"><label>Hero Description</label><textarea id="pi-hero-desc" rows="3" placeholder="Welcome toâ€¦"></textarea></div>
          <button class="btn bp" onclick="piSave('hero')">ğŸ’¾ Save Hero Section</button>
        </div>
      </div>

      <!-- â”€â”€ ABOUT â”€â”€ -->
      <div class="ie-section" id="pi-about">
        <div class="afc">
          <div class="afc-t">About Section</div>
          <div class="fg"><label>Section Title</label><input type="text" id="pi-about-title" placeholder="About This Portal"></div>
          <div class="fg"><label>About Text (displayed as a highlighted block)</label><textarea id="pi-about-text" rows="5" placeholder="Describe what the portal isâ€¦"></textarea></div>
          <button class="btn bp" onclick="piSave('about')">ğŸ’¾ Save About Section</button>
        </div>
      </div>

      <!-- â”€â”€ FEATURES â”€â”€ -->
      <div class="ie-section" id="pi-features">
        <div class="afc">
          <div class="afc-t">Feature Cards (Why Join?)</div>
          <p style="color:var(--muted);font-size:.83rem;margin-bottom:1rem">Each card appears in the "Why Join?" grid. Add up to 6 feature cards.</p>
          <div id="pi-feat-list"></div>
          <div style="display:flex;gap:.6rem;margin-top:.6rem">
            <button class="btn bg_" onclick="piFeatAdd()">â• Add Feature Card</button>
            <button class="btn bp" onclick="piSave('features')">ğŸ’¾ Save Features</button>
          </div>
        </div>
      </div>

      <!-- â”€â”€ HOW IT WORKS â”€â”€ -->
      <div class="ie-section" id="pi-hiw">
        <div class="afc">
          <div class="afc-t">How It Works Steps</div>
          <p style="color:var(--muted);font-size:.83rem;margin-bottom:1rem">Numbered steps shown as cards. Ideal for 4 steps.</p>
          <div id="pi-hiw-list"></div>
          <div style="display:flex;gap:.6rem;margin-top:.6rem">
            <button class="btn bg_" onclick="piHiwAdd()">â• Add Step</button>
            <button class="btn bp" onclick="piSave('hiw')">ğŸ’¾ Save Steps</button>
          </div>
        </div>
      </div>

      <!-- â”€â”€ SOP â”€â”€ -->
      <div class="ie-section" id="pi-sop">
        <div class="afc">
          <div class="afc-t">SOP Section</div>
          <div class="form-row" style="margin-bottom:.8rem">
            <div class="fg"><label>SOP Section Title</label><input type="text" id="pi-sop-title" placeholder="Standard Operating Procedure"></div>
            <div class="fg"><label>SOP Subtitle</label><input type="text" id="pi-sop-sub" placeholder="Follow these stepsâ€¦"></div>
          </div>
          <div id="pi-sop-list"></div>
          <div style="display:flex;gap:.6rem;margin-top:.6rem">
            <button class="btn bg_" onclick="piSopAdd()">â• Add SOP Step</button>
            <button class="btn bp" onclick="piSave('sop')">ğŸ’¾ Save SOP</button>
          </div>
        </div>
      </div>

      <!-- â”€â”€ POINTS â”€â”€ -->
      <div class="ie-section" id="pi-pts">
        <div class="afc">
          <div class="afc-t">Points Guide Table</div>
          <p style="color:var(--muted);font-size:.83rem;margin-bottom:1rem">Rows shown in the Points &amp; Rewards table.</p>
          <div id="pi-pts-list"></div>
          <div style="display:flex;gap:.6rem;margin-top:.6rem">
            <button class="btn bg_" onclick="piPtsAdd()">â• Add Row</button>
            <button class="btn bp" onclick="piSave('pts')">ğŸ’¾ Save Points Guide</button>
          </div>
        </div>
      </div>

      <!-- â”€â”€ CONTACT â”€â”€ -->
      <div class="ie-section" id="pi-contact">
        <div class="afc">
          <div class="afc-t">Contact &amp; Footer</div>
          <div class="fg"><label>Support / Contact Text</label><textarea id="pi-contact-text" rows="3" placeholder="For any issues, contactâ€¦"></textarea></div>
          <div class="fg"><label>Footer Note</label><input type="text" id="pi-footer-note" placeholder="Â© Bridge4Change Foundationâ€¦"></div>
          <button class="btn bp" onclick="piSave('contact')">ğŸ’¾ Save Contact Info</button>
        </div>
      </div>

      <!-- Preview button -->
      <div style="margin-top:1rem;padding-top:1rem;border-top:1px solid var(--border)">
        <button class="btn ba" onclick="previewAbout()">ğŸ‘ Preview About Page</button>
        <span style="color:var(--muted);font-size:.79rem;margin-left:.75rem">Save first, then preview to see live changes.</span>
      </div>
    </div>

    <!-- SETTINGS -->
    <div class="as" id="as-st">
      <h2 class="apt">âš™ï¸ Settings</h2>
      <div class="gas-box">
        <strong>ğŸ“Š Google Apps Script URL â€” Required for everything to work!</strong>
        Paste your deployed Web App URL below. Once saved, all content, user accounts, and quizzes are stored in Google Sheets and accessible from any device.
        <table class="scm" style="margin-top:.65rem">
          <thead><tr><th>Sheet Name</th><th>Purpose</th></tr></thead>
          <tbody>
            <tr><td><strong>Users</strong></td><td>Stores accounts with hashed passwords</td></tr>
            <tr><td><strong>Sessions</strong></td><td>Session tokens (7-day expiry)</td></tr>
            <tr><td><strong>Content Library</strong></td><td>ID | Type | Title | URL | Theme | Duration | Description | CreatedAt</td></tr>
            <tr><td><strong>Quizzes</strong></td><td>ID | Title | ContentType | ContentID | PointsEach | AllowRetry | QuestionsJSON | CreatedAt</td></tr>
          </tbody>
        </table>
      </div>
      <div class="afc">
        <div class="afc-t">Google Apps Script URL</div>
        <div class="fg"><label>Paste your deployed Web App URL here (or edit HARDCODED_GAS_URL in the HTML file for all-device support)</label><input type="url" id="st-gas" placeholder="https://script.google.com/macros/s/...exec"></div>
        <div style="display:flex;gap:.6rem;flex-wrap:wrap">
          <button class="btn bp" onclick="saveGas()">Save URL</button>
          <button class="btn bg_" onclick="testGas()">ğŸ” Test Connection</button>
        </div>
      </div>
      <!-- Firebase Settings -->
      <div class="afc" id="fb-settings">
        <div class="afc-t">&#128293; Firebase â€” Real-time Progress &amp; Certificates
          <span id="fb-badge" style="font-size:.7rem;padding:.15rem .45rem;border-radius:6px;margin-left:.5rem;background:#fee2e2;color:#991b1b;font-weight:700">Not connected</span>
        </div>
        <div class="alert info" style="margin:.5rem 0 .85rem;font-size:.83rem">
          <strong>Why Firebase?</strong> Solves the sync delay â€” watched/read status and points update instantly across all devices with no delay.
          Firebase is <strong>free</strong> (Spark plan) and handles hundreds of students.
          <a href="https://console.firebase.google.com/" target="_blank" style="color:var(--primary);font-weight:600">Open Firebase Console &#8599;</a>
        </div>
        <details style="margin-bottom:.9rem;border:1px solid var(--border);border-radius:8px">
          <summary style="padding:.6rem 1rem;cursor:pointer;font-weight:600;font-size:.82rem;background:var(--bg)">&#128203; 5-step setup guide (takes ~5 minutes)</summary>
          <ol style="padding:.75rem 1rem .75rem 2rem;font-size:.81rem;line-height:2;color:var(--text)">
            <li>Go to <a href="https://console.firebase.google.com/" target="_blank" style="color:var(--primary)">console.firebase.google.com</a> &#8594; <em>Add project</em> &#8594; name it &#8594; skip Analytics &#8594; <em>Create project</em></li>
            <li>Click the <strong>&lt;/&gt; Web</strong> icon &#8594; give it a nickname &#8594; <em>Register app</em> &#8594; <strong>copy the config object</strong> shown</li>
            <li>In left menu &#8594; <strong>Authentication</strong> &#8594; <em>Sign-in method</em> &#8594; enable <strong>Email/Password</strong></li>
            <li>In left menu &#8594; <strong>Firestore Database</strong> &#8594; <em>Create database</em> &#8594; <strong>Start in test mode</strong> &#8594; choose a region &#8594; <em>Enable</em></li>
            <li>Paste the config object below and click <strong>Save &amp; Connect</strong></li>
          </ol>
          <div style="padding:.5rem 1rem .75rem;font-size:.79rem;color:var(--muted)">
            &#128161; Test mode is fine for now. You can set proper security rules later â€” the <a href="https://firebase.google.com/docs/firestore/security/rules-structure" target="_blank" style="color:var(--primary)">Firebase docs</a> have templates.
          </div>
        </details>
        <div class="fg">
          <label>Firebase Config <span style="font-weight:400;color:var(--muted)">(paste the firebaseConfig object from Firebase Console)</span></label>
          <textarea id="fb-cfg" rows="7" placeholder='{
  "apiKey": "AIzaSy...",
  "authDomain": "your-app.firebaseapp.com",
  "projectId": "your-app-id",
  "storageBucket": "your-app.appspot.com",
  "messagingSenderId": "1234567890",
  "appId": "1:1234567890:web:abc123"
}'></textarea>
        </div>
        <div id="fb-msg"></div>
        <div style="display:flex;gap:.6rem;flex-wrap:wrap;margin-top:.4rem">
          <button class="btn bp" onclick="saveFbCfg()" style="background:linear-gradient(135deg,#E65100,#FF9800)">&#128293; Save &amp; Connect</button>
          <button class="btn bg_" onclick="testFbCfg()">&#128269; Test Connection</button>
          <button class="btn bg_" id="fb-migrate-btn" style="display:none" onclick="migrateFb()">&#128228; Migrate GAS &#8594; Firebase</button>
        </div>
        <div id="fb-migrate-msg" style="margin-top:.5rem;font-size:.81rem;color:var(--muted)"></div>
      </div>

      <div class="afc">
        <div class="afc-t">Change Admin Credentials</div>
        <div class="form-row">
          <div class="fg"><label>Username</label><input type="text" id="st-au" placeholder="admin"></div>
          <div class="fg"><label>New Password (leave blank to keep current)</label><input type="password" id="st-ap" placeholder="New password"></div>
        </div>
        <div style="display:flex;gap:.6rem;flex-wrap:wrap">
          <button class="btn bp" onclick="saveAdmCreds()">Update Credentials</button>
          <button class="btn bg_" onclick="resetAdmCreds()" style="color:var(--orange);border-color:var(--orange)">Reset to Defaults</button>
        </div>
      </div>
      <div class="afc">
        <div class="afc-t" style="color:var(--red)">âš ï¸ Danger Zone</div>
        <p style="color:var(--muted);font-size:.85rem;margin-bottom:.7rem">Permanently delete ALL local cache. (Does NOT delete Google Sheet data.)</p>
        <button class="btn bd" onclick="clrLocalCache()">ğŸ—‘ï¸ Clear Local Cache</button>
      </div>
    </div>

    <!-- CERTIFICATE SETTINGS -->
    <div class="as" id="as-cert-cfg">
      <h2 class="apt">ğŸ… Certificate Settings</h2>
      <div class="alert info" style="margin-bottom:1.1rem">
        Configure the point thresholds for each certificate tier. Students automatically unlock certificates as they earn points. All thresholds and text can be customised below.
      </div>

      <div class="afc">
        <div class="afc-t">ğŸ¥‰ Bronze Â· ğŸ¥ˆ Silver Â· ğŸ¥‡ Gold Â· ğŸ’ Platinum â€” Point Thresholds</div>
        <p style="color:var(--muted);font-size:.83rem;margin-bottom:.9rem">Students automatically receive a certificate when they reach each threshold. Set each threshold to match your programme's goals.</p>
        <div class="form-row">
          <div class="fg"><label>ğŸ¥‰ Bronze â€” minimum points</label><input type="number" id="cert-bronze-pts" min="1" value="100" placeholder="100"></div>
          <div class="fg"><label>ğŸ¥ˆ Silver â€” minimum points</label><input type="number" id="cert-silver-pts" min="1" value="300" placeholder="300"></div>
        </div>
        <div class="form-row">
          <div class="fg"><label>ğŸ¥‡ Gold â€” minimum points</label><input type="number" id="cert-gold-pts" min="1" value="500" placeholder="500"></div>
          <div class="fg"><label>ğŸ’ Platinum â€” minimum points</label><input type="number" id="cert-plat-pts" min="1" value="1000" placeholder="1000"></div>
        </div>
      </div>

      <div class="afc">
        <div class="afc-t">Certificate Branding</div>
        <div class="form-row">
          <div class="fg"><label>Organisation Name</label><input type="text" id="cert-org" placeholder="Bridge4Change Foundation"></div>
          <div class="fg"><label>Signatory Name</label><input type="text" id="cert-sign-name" placeholder="Programme Director"></div>
        </div>
        <div class="form-row">
          <div class="fg"><label>Signatory Title / Role</label><input type="text" id="cert-sign-title" placeholder="Bridge4Change Foundation"></div>
          <div class="fg"><label>Footer / Description Text</label><input type="text" id="cert-footer-txt" placeholder="In recognition of achievementâ€¦"></div>
        </div>
        <div style="display:flex;gap:.6rem;flex-wrap:wrap">
          <button class="btn bp" onclick="saveCertCfg()">ğŸ’¾ Save Certificate Settings</button>
          <button class="btn ba" onclick="previewSampleCert('gold')">ğŸ‘ Preview Gold Certificate</button>
          <button class="btn bg_" onclick="previewSampleCert('plat')">ğŸ’ Preview Platinum</button>
        </div>
      </div>

      <div class="afc" style="margin-top:1rem">
        <div class="afc-t">Certificates Issued</div>
        <p style="color:var(--muted);font-size:.83rem;margin-bottom:.6rem">All certificates are tracked in the <strong>Certificates</strong> sheet in Google Sheets. Students see and download certificates from "ğŸ… My Certificates" on their dashboard.</p>
      </div>
    </div>
  </div>
</div>
</div>

<!-- ===== QUIZ OVERLAY ===== -->
<div class="ov hidden" id="qov">
<div class="qm">
  <div class="qhdr"><h2 id="qm-t">Quiz</h2><button onclick="closeQz()" style="background:none;border:none;font-size:1.3rem;cursor:pointer;color:var(--muted)">âœ•</button></div>
  <div class="qbody" id="qm-b"></div>
</div>
</div>

<!-- ===== VIDEO VIEWER OVERLAY ===== -->
<div class="ov hidden" id="vov">
<div style="background:var(--surface);border-radius:15px;max-width:760px;width:100%;box-shadow:0 24px 60px rgba(0,0,0,.25)">
  <div style="padding:.9rem 1.4rem;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border)">
    <h3 id="vm-t" style="font-family:\'Crimson Pro\',serif;color:var(--primary)">Video</h3>
    <button onclick="closeVov()" style="background:none;border:none;font-size:1.3rem;cursor:pointer;color:var(--muted)">âœ•</button>
  </div>
  <div style="padding:1.1rem"><div id="vm-b"></div>
    <div style="margin-top:.9rem;display:flex;gap:.6rem;justify-content:flex-end">
      <button class="btn bp" id="vm-mk">âœ“ Mark as Watched</button>
    </div>
  </div>
</div>
</div>

<!-- ===== CONFIRM OVERLAY ===== -->
<div class="ov hidden" id="cov">
<div class="conf-m">
  <h3 id="co-t">Confirm</h3><p id="co-m">Are you sure?</p>
  <div class="conf-acts">
    <button class="btn bg_" onclick="closeCo()">Cancel</button>
    <button class="btn bd" id="co-ok">Confirm</button>
  </div>
</div>
</div>

<!-- ===== ADJUST POINTS OVERLAY ===== -->
<div class="ov hidden" id="aov">
<div class="conf-m">
  <h3>Adjust Points</h3><p id="ao-nm">Student</p>
  <div class="fg"><label>Points (negative to deduct, e.g. -20)</label><input type="number" id="ao-v" placeholder="e.g. 50 or -20"></div>
  <div class="fg"><label>Reason</label><input type="text" id="ao-r" placeholder="Reason for adjustment"></div>
  <div class="conf-acts">
    <button class="btn bg_" onclick="closeAo()">Cancel</button>
    <button class="btn bp" onclick="submitAdj()">Apply</button>
  </div>
</div>
</div>
<script>

// ============================================================
// CONFIG & SESSION
// ============================================================
// ============================================================
// â˜… PASTE YOUR GOOGLE APPS SCRIPT URL HERE â˜…
// Replace the empty string below with your /exec URL.
// This makes the portal work on ALL devices without any setup.
// Example: 'https://script.google.com/macros/s/AKfy.../exec'
// ============================================================
var HARDCODED_GAS_URL = 'https://script.google.com/macros/s/AKfycbxqkAyTLS1xktcrAwBIudrlSfsZAmaKikYo8l5zGIUU_xhlzywIk6lkWarHWO1P9FgnQA/exec';  // â† PASTE YOUR URL BETWEEN THESE QUOTES

var PI_DEFAULTS = {
  hero_title:       'Bridge4Change Learning Portal',
  hero_tagline:     'Empowering changemakers through knowledge, skills & community.',
  hero_description: 'Welcome to the official Bridge4Change Foundation learning platform â€” a space designed for fellows, volunteers, and partners to grow, learn, and lead change together.',
  about_title:      'About This Portal',
  about_text:       'The Bridge4Change Learning Portal is a curated digital library of videos, articles, and interactive quizzes focused on social impact, sustainability, climate action, and community development. Every resource has been carefully selected to support your journey as a changemaker.',
  how_it_works:     JSON.stringify([
    { icon:'ğŸ“', title:'Sign Up',                text:'Create your free account using your email and institution details.' },
    { icon:'ğŸ¬', title:'Watch & Read',            text:'Explore curated videos and articles across multiple themes at your own pace.' },
    { icon:'ğŸ“', title:'Take Quizzes',            text:'Test your understanding with quizzes after each resource and earn points.' },
    { icon:'ğŸ†', title:'Climb the Leaderboard',   text:'Earn points for every activity completed and compete with peers from across the country.' }
  ]),
  features:         JSON.stringify([
    { icon:'ğŸŒ', title:'Social Impact Focus',   text:'All content curated around sustainability, climate, and social change.',       color:'#10B981' },
    { icon:'ğŸ“', title:'Self-Paced Learning',   text:'Learn anytime, anywhere â€” at your own pace, on any device.',                  color:'#3B82F6' },
    { icon:'âš¡', title:'Points & Rewards',      text:'Earn points for every video, article, and quiz you complete.',                color:'#F5B800' },
    { icon:'ğŸ“Š', title:'Track Your Progress',   text:'Your personal dashboard shows exactly how far you have come.',               color:'#7C3AED' },
    { icon:'ğŸ¤', title:'Peer Community',        text:'See how you rank among fellow changemakers on the leaderboard.',             color:'#EF4444' },
    { icon:'ğŸ“±', title:'Works on Any Device',   text:'Fully mobile-friendly â€” works on phones, tablets, and computers.',           color:'#F59E0B' }
  ]),
  sop_title:        'Standard Operating Procedure (SOP)',
  sop_subtitle:     'Follow these steps to get the most out of the portal.',
  sop_steps:        JSON.stringify([
    { step:'01', title:'Complete Your Profile', text:'After signing up, make sure your institution and cohort details are correct.' },
    { step:'02', title:'Start With Videos',     text:'Navigate to the Videos section. Watch each video fully before marking it as watched.' },
    { step:'03', title:'Read All Articles',     text:'Go to the Articles section and read each article. Click "Mark Read" once done.' },
    { step:'04', title:'Attempt Every Quiz',    text:'After watching a video or reading an article, take the associated quiz.' },
    { step:'05', title:'Track Your Progress',   text:'Visit My Progress regularly to see your completion percentage and total points.' },
    { step:'06', title:'Check the Leaderboard', text:'See how you compare to peers. Stay motivated and aim for Gold badge (500+ points).' }
  ]),
  points_guide:     JSON.stringify([
    { action:'Watch a video',         points:'+5 pts' },
    { action:'Read an article',       points:'+5 pts' },
    { action:'Correct quiz answer',   points:'+10 pts (per question)' },
    { action:'Long answer attempt',   points:'+10 pts (full marks)' }
  ]),
  contact_text:     'For any technical issues or questions, please reach out to your programme coordinator or email support@bridge4change.org.',
  footer_note:      'Â© Bridge4Change Foundation. All rights reserved. Learning Portal v2.0.'
};


var CFG = { gas:'', admU:'admin', admP:'outreach2025' };
// Note: admP stores password in plain text locally â€” this is only for the
// local admin panel access check. The GAS backend has its own secure auth.
// Session: token stored in localStorage, user data in memory
var S = { user:null, token:null, isAdmin:false };

// â”€â”€ FIREBASE (progress + certs only â€” GAS handles auth/content) â”€â”€
var FB_APP = null;   // firebase app instance
var FS = null;       // firestore instance

function fbInit(cfg) {
  if (!cfg || !cfg.apiKey || !cfg.projectId) return false;
  try {
    if (FB_APP) return true; // already initialised
    if (typeof firebase === 'undefined') { console.warn('Firebase SDK not loaded'); return false; }
    FB_APP = firebase.initializeApp(cfg);
    FS = firebase.firestore();
    // Enable offline persistence so data loads instantly even offline
    FS.enablePersistence({synchronizeTabs:true}).catch(function(e){
      if (e.code !== 'failed-precondition' && e.code !== 'unimplemented') console.warn('FB persist:', e);
    });
    lsS('fb_cfg', cfg);
    return true;
  } catch(e) { console.error('fbInit error:', e); return false; }
}
function fbOk() { return FS !== null; }

// â”€â”€ Firestore helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// User doc: /users/{email}  â€” stores points
// Progress: /users/{email}/progress/{watched_ID | read_ID}
// Quiz:     /users/{email}/quizzes/{quizId}
// Certs:    /certificates/{certId}

function fbMarkWatched(email, videoId, videoTitle, institution, cohort, cb) {
  if (!fbOk()) { if(cb) cb(null); return; }
  var ref = FS.collection('users').doc(email)
               .collection('progress').doc('v_'+videoId);
  ref.get().then(function(doc){
    if (doc.exists) { if(cb) cb('already'); return; }
    return ref.set({
      type:'video', id:videoId, title:videoTitle||'',
      institution:institution||'', cohort:cohort||'',
      ts: firebase.firestore.FieldValue.serverTimestamp()
    }).then(function(){
      return fbAddPoints(email, 5, cb);
    });
  }).catch(function(e){ console.warn('fbMarkWatched:', e); if(cb) cb(null); });
}

function fbMarkRead(email, articleId, articleTitle, institution, cohort, cb) {
  if (!fbOk()) { if(cb) cb(null); return; }
  var ref = FS.collection('users').doc(email)
               .collection('progress').doc('a_'+articleId);
  ref.get().then(function(doc){
    if (doc.exists) { if(cb) cb('already'); return; }
    return ref.set({
      type:'article', id:articleId, title:articleTitle||'',
      institution:institution||'', cohort:cohort||'',
      ts: firebase.firestore.FieldValue.serverTimestamp()
    }).then(function(){
      return fbAddPoints(email, 5, cb);
    });
  }).catch(function(e){ console.warn('fbMarkRead:', e); if(cb) cb(null); });
}

function fbRecordQuiz(email, quizId, quizTitle, score, total, pts, cb) {
  if (!fbOk()) { if(cb) cb(null); return; }
  FS.collection('users').doc(email)
    .collection('quizzes').add({
      quizId:quizId, quizTitle:quizTitle||'',
      score:score, total:total, pointsEarned:pts,
      ts: firebase.firestore.FieldValue.serverTimestamp()
    }).then(function(){
      if (pts > 0) fbAddPoints(email, pts, cb);
      else if(cb) cb(0);
    }).catch(function(e){ console.warn('fbRecordQuiz:', e); if(cb) cb(null); });
}

function fbAddPoints(email, delta, cb) {
  if (!fbOk() || !delta) { if(cb) cb(null); return; }
  var ref = FS.collection('users').doc(email);
  FS.runTransaction(function(tx){
    return tx.get(ref).then(function(doc){
      var cur = doc.exists ? (Number(doc.data().points)||0) : 0;
      var next = Math.max(0, cur + delta);
      tx.set(ref, {points:next, email:email}, {merge:true});
      return next;
    });
  }).then(function(newPts){
    // Sync to in-memory user
    if (S.user && S.user.email === email) {
      S.user.points = newPts;
      if (g('hdr-pts')) g('hdr-pts').textContent = newPts + ' pts';
    }
    // Note: GAS points are synced separately via VIDEO_WATCHED / ARTICLE_READ / QUIZ_COMPLETED
    // calls in markW / markR / finishQz â€” no need to call ADJUST_POINTS here
    if(cb) cb(newPts);
  }).catch(function(e){ console.warn('fbAddPoints:', e); if(cb) cb(null); });
}

function fbGetProgress(email, cb) {
  if (!fbOk()) { cb({vw:[], ar:[]}); return; }
  FS.collection('users').doc(email).collection('progress').get()
    .then(function(snap){
      var vw=[], ar=[];
      snap.forEach(function(doc){
        var d=doc.data();
        if (d.type==='video')   vw.push(String(d.id));
        if (d.type==='article') ar.push(String(d.id));
      });
      cb({vw:vw, ar:ar});
    }).catch(function(){ cb({vw:[], ar:[]}); });
}

function fbGetPoints(email, cb) {
  if (!fbOk()) { cb(null); return; }
  FS.collection('users').doc(email).get()
    .then(function(doc){ cb(doc.exists ? (Number(doc.data().points)||0) : 0); })
    .catch(function(){ cb(null); });
}

function fbGetCerts(email, cb) {
  if (!fbOk()) { cb(null); return; }
  FS.collection('certificates')
    .where('email','==',email).get()
    .then(function(snap){
      var certs=[];
      snap.forEach(function(doc){ certs.push(doc.data()); });
      cb(certs);
    }).catch(function(){ cb(null); });
}

function fbIssueCert(email, tier, points, cb) {
  if (!fbOk()) { cb(null); return; }
  // Check for existing cert first
  FS.collection('certificates')
    .where('email','==',email).where('tier','==',tier).get()
    .then(function(snap){
      if (!snap.empty) {
        var existing = snap.docs[0].data();
        existing.alreadyIssued = true;
        cb(existing); return;
      }
      var labels={bronze:'Bronze',silver:'Silver',gold:'Gold',plat:'Platinum'};
      var certId = 'B4C-'+tier.toUpperCase()+'-'+new Date().getFullYear()+'-'+
                   Math.random().toString(36).substring(2,7).toUpperCase();
      var certData = {
        certId:certId, email:email, tier:tier, points:points,
        issuedAt:new Date().toISOString(),
        name:(S.user&&S.user.name)||''
      };
      FS.collection('certificates').doc(certId).set(certData)
        .then(function(){ cb(certData); })
        .catch(function(){ cb(null); });
    }).catch(function(){ cb(null); });
}

function fbGetLeaderboard(cb) {
  if (!fbOk()) { cb(null); return; }
  FS.collection('users').orderBy('points','desc').limit(50).get()
    .then(function(snap){
      var lb=[];
      snap.forEach(function(doc){
        var d=doc.data();
        lb.push({email:d.email||doc.id, name:d.name||'',
                 institution:d.institution||'', cohort:d.cohort||'', points:d.points||0});
      });
      lb.forEach(function(u,i){ u.rank=i+1; });
      cb(lb);
    }).catch(function(){ cb(null); });
}

// [firebase boot moved below - see bottom of CONFIG section]

// Content cache (localStorage for offline fallback)
var DB = { V:[], A:[], Q:[], AT:[] };
// Portal info cache
var PI = {};
// Certificate config cache
var CERT_CFG_DEFAULTS = {
  cert_bronze_pts:     '100',
  cert_silver_pts:     '300',
  cert_gold_pts:       '500',
  cert_plat_pts:       '1000',
  cert_org_name:       'Bridge4Change Foundation',
  cert_signatory_name: 'Programme Director',
  cert_signatory_title:'Bridge4Change Foundation',
  cert_footer_text:    'This certificate is awarded in recognition of outstanding learning achievement.'
};
var CERT_CFG = Object.assign({}, CERT_CFG_DEFAULTS);

// â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function boot(){
  // Priority: localStorage (admin may update it) â†’ hardcoded fallback
  CFG.gas  = ls('gas') || HARDCODED_GAS_URL || '';
  CFG.admU = ls('admU') || 'admin';
  var sp = ls('admP'); if (sp) { CFG.admP=sp; }

  // Load content from localStorage cache (instant display)
  DB.V  = safeJSON(ls('c_v'),  []);
  DB.A  = safeJSON(ls('c_a'),  []);
  DB.Q  = safeJSON(ls('c_q'),  []);
  DB.AT = safeJSON(ls('c_at'), []);
  PI    = safeJSON(ls('c_pi'), Object.assign({}, PI_DEFAULTS)); // portal info cache
  CERT_CFG = safeJSON(ls('cert_cfg'), Object.assign({}, CERT_CFG_DEFAULTS)); // cert config

  var tok = ls('sess_tok');
  var sessAdmin = ls('sess_adm');

  if (sessAdmin === '1') { enterAdmin(); return; }

  if (tok && CFG.gas) {
    // Validate token with server â†’ restore session across devices
    gasGet('VALIDATE_TOKEN', 'token='+encodeURIComponent(tok)).then(function(r){
      if (r && r.success && r.data) {
        S.token = tok;
        S.user  = r.data;
        // Merge cached attempts
        S.user.progress = safeJSON(ls('c_prog_'+r.data.email), {vw:[], ar:[]});
        // Show GAS points initially (instant), Firebase will update them
        updateHeaderUser();
        // Load fresh content from GAS, then show dash
        loadContentFromGAS(function(){
          // Override with Firebase points + progress (authoritative)
          fbSyncUserState(S.user.email, function(){
            updateHeaderUser(); // re-render header with Firebase points
            showPg('pg-dash');
            loadCertConfig(function(){ checkAndIssueTierCerts(S.user.points||0); });
            updateCertCount();
          });
        });
      } else {
        lsR('sess_tok');
        showPg('pg-auth');
      }
    }).catch(function(){ showPg('pg-auth'); });
  } else {
    showPg('pg-auth');
  }
})();

// ============================================================
// STORAGE HELPERS
// ============================================================
function ls(k)    { return localStorage.getItem('b4c_'+k); }
function lsS(k,v) { localStorage.setItem('b4c_'+k, typeof v === 'string' ? v : JSON.stringify(v)); }
function lsR(k)   { localStorage.removeItem('b4c_'+k); }
function safeJSON(s, def) { try { return JSON.parse(s||'null')||def; } catch(e){ return def; } }

// Load + try to init Firebase from saved config on boot
(function(){
  var saved = safeJSON(ls('fb_cfg'), null);
  if (saved && saved.apiKey) fbInit(saved);
})();


// ============================================================
// CONTENT LOAD
// ============================================================
function loadContentFromGAS(cb) {
  if (!CFG.gas) { if (cb) cb(); return; }
  gasGet('GET_CONTENT', 't='+Date.now()).then(function(r){
    if (r && r.success && r.data) {
      if (Array.isArray(r.data.videos))   { DB.V = r.data.videos;   lsS('c_v', DB.V); }
      if (Array.isArray(r.data.articles)) { DB.A = r.data.articles; lsS('c_a', DB.A); }
    }
    return gasGet('GET_QUIZZES', 't='+Date.now());
  }).then(function(r){
    if (r && r.success && Array.isArray(r.data)) { DB.Q = r.data; lsS('c_q', DB.Q); }
    if (cb) cb();
  }).catch(function(e){ console.warn('Content load error:', e); if (cb) cb(); });
}

// ============================================================
// PAGE NAV
// ============================================================
function showPg(id) {
  document.querySelectorAll('.pg').forEach(function(p){ p.classList.remove('on'); });
  document.getElementById(id).classList.add('on');
  if (id==='pg-vids')  { fillThm('vthf', DB.V); renVids(); }
  if (id==='pg-arts')  { fillThm('athf', DB.A); renArts(); }
  if (id==='pg-prog')  renProg();
  if (id==='pg-lb')    loadLb();
  if (id==='pg-dash')  renDash();
  if (id==='pg-about') { renderAboutPage(); loadPortalInfo(renderAboutPage); }
  if (id==='pg-certs') loadMyCerts();
  window.scrollTo(0,0);
}

function fillThm(selId, items) {
  var t=[];
  items.forEach(function(x){ if (x.theme && t.indexOf(x.theme)<0) t.push(x.theme); });
  t.sort();
  var s=g(selId);
  s.innerHTML='<option value="">All Themes</option>'+t.map(function(x){ return '<option>'+esc(x)+'</option>'; }).join('');
}

// ============================================================
// AUTH â€” SIGN IN
// ============================================================
function atab(t) {
  document.querySelectorAll('#atabs .tab').forEach(function(el,i){ el.classList.toggle('on', t==='in'?i===0:i===1); });
  g('fin').classList.toggle('hidden', t!=='in');
  g('fup').classList.toggle('hidden', t!=='up');
}

document.getElementById('fin').addEventListener('submit', function(e) {
  e.preventDefault();
  var email = g('ie').value.trim().toLowerCase();
  var pass  = g('ip').value;
  var err   = g('ie-err'), btn = g('in-btn');
  err.classList.add('hidden');

  if (!CFG.gas) {
    showErr(err, 'âš ï¸ Google Sheets URL not configured. Open the Admin panel â†’ Settings and paste your Google Apps Script URL, then try again.');
    return;
  }

  btn.disabled=true; btn.textContent='Signing inâ€¦';

  gasPost('LOGIN', {email:email, password:pass}).then(function(r){
    btn.disabled=false; btn.textContent='Sign In';
    if (!r || !r.success) {
      var msg = (r && r.message) || 'Login failed. Please try again.';
      if (msg.indexOf('Unknown action') > -1) {
        msg = 'âŒ GAS deployment issue: "'+msg+'". Go to Admin â†’ Settings and re-save your GAS URL, or re-deploy your Google Apps Script.';
      }
      showErr(err, msg);
      return;
    }
    // Store token for cross-device persistence
    S.token = r.data.token;
    S.user  = {
      email:       r.data.email,
      name:        r.data.name,
      institution: r.data.institution,
      cohort:      r.data.cohort,
      points:      r.data.points || 0,
      progress:    safeJSON(ls('c_prog_'+r.data.email), {vw:[], ar:[]})
    };
    lsS('sess_tok', S.token);
    // Load fresh content then go to dashboard
    loadContentFromGAS(function(){
      // Show GAS points first (instant), Firebase will override
      updateHeaderUser();
      // Override with Firebase points + progress (authoritative source)
      fbSyncUserState(S.user.email, function(){
        updateHeaderUser(); // re-render with Firebase points
        showPg('pg-dash');
        loadCertConfig(function(){ checkAndIssueTierCerts(S.user.points||0); });
        updateCertCount();
      });
    });
    loadPortalInfo();
  }).catch(function(e){
    btn.disabled=false; btn.textContent='Sign In';
    showErr(err, 'Connection error. Check your internet and try again.');
  });
});

// â”€â”€ SIGN UP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('fup').addEventListener('submit', function(e) {
  e.preventDefault();
  var name  = g('un').value.trim(), email = g('ue').value.trim().toLowerCase();
  var pass  = g('up-p').value, inst = g('ui').value.trim(), cohort = g('uc').value.trim()||'Not specified';
  var err   = g('up-err'), btn = g('up-btn');

  if (!CFG.gas) {
    showErr(err, 'Please ask the admin to configure the Google Sheets URL first.');
    return;
  }
  if (pass.length < 6) { showErr(err, 'Password must be at least 6 characters.'); return; }

  btn.disabled=true; btn.textContent='Creatingâ€¦';

  gasPost('SIGNUP', {name:name, email:email, password:pass, institution:inst, cohort:cohort}).then(function(r){
    btn.disabled=false; btn.textContent='Create Account';
    if (!r || !r.success) {
      showErr(err, (r && r.message) || 'Sign up failed.');
      return;
    }
    toast('Account created! Please sign in.'); atab('in'); g('ie').value=email;
  }).catch(function(e){
    btn.disabled=false; btn.textContent='Create Account';
    showErr(err, 'Connection error. Please try again.');
  });
});

// â”€â”€ ADMIN LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('fadm').addEventListener('submit', function(e) {
  e.preventDefault();
  var u=g('au').value.trim(), p=g('ap').value.trim(), err=g('adm-err');
  var pMatch = (p === CFG.admP);
  if (u===CFG.admU && pMatch) {
    lsS('sess_adm','1'); lsR('sess_tok'); enterAdmin();
  } else {
    showErr(err,'Invalid admin credentials. Default: admin / admin123');
  }
});

function updateHeaderUser() {
  var u = S.user;
  g('hdr-av').textContent = (u.name||'?')[0].toUpperCase();
  g('hdr-nm').textContent = u.name;
  g('hdr-pts').textContent = (u.points||0)+' pts';
  g('hdr-pts').style.display = 'inline';
  g('hdr-out').onclick = logout;
  g('hdr-r').classList.add('show');
}

function logout() {
  if (!confirm('Logout?')) return;
  if (S.token && CFG.gas) gasPost('LOGOUT', {}, S.token).catch(function(){});
  S.user=null; S.token=null;
  lsR('sess_tok'); lsR('sess_adm');
  g('hdr-r').classList.remove('show'); showPg('pg-auth');
}

function enterAdmin() {
  S.isAdmin=true; S.user=null; S.token=null;
  g('hdr-av').textContent='ğŸ›¡'; g('hdr-nm').textContent='Admin';
  g('hdr-pts').style.display='none';
  g('hdr-out').onclick=admLogout; g('hdr-r').classList.add('show');
  g('st-gas').value = CFG.gas || HARDCODED_GAS_URL || '';
  // Populate Firebase textarea and update badge
  var savedFbCfg = safeJSON(ls('fb_cfg'), null);
  if (savedFbCfg && savedFbCfg.apiKey && g('fb-cfg')) {
    g('fb-cfg').value = JSON.stringify(savedFbCfg, null, 2);
    if (g('fb-migrate-btn')) g('fb-migrate-btn').style.display='';
  }
  updateFbBadge();
  showPg('pg-admin');
  // Load content so admin can see/manage it
  if (CFG.gas) loadContentFromGAS(function(){ renAdmOv(); renAdmVids(); renAdmArts(); renAdmQzs(); });
  else renAdmOv();
  loadPortalInfo();
  loadCertConfig();
}

function admLogout() {
  if (!confirm('Logout?')) return;
  S.isAdmin=false; lsR('sess_adm');
  g('hdr-r').classList.remove('show'); showPg('pg-auth');
}

function doReset() {
  var email=g('rs-e').value.trim().toLowerCase(), p1=g('rs-p1').value, p2=g('rs-p2').value;
  var msg=g('rs-msg');
  if (!email||!p1||!p2) { msg.innerHTML='<div class="alert err">Please fill all fields.</div>'; return; }
  if (p1!==p2) { msg.innerHTML='<div class="alert err">Passwords do not match.</div>'; return; }
  if (p1.length<6) { msg.innerHTML='<div class="alert err">Password too short (min 6).</div>'; return; }
  if (!CFG.gas) { msg.innerHTML='<div class="alert err">GAS URL not configured.</div>'; return; }
  gasPost('PASSWORD_RESET_REQUEST', {email:email, newPassword:p1}).then(function(r){
    if (r && r.success) msg.innerHTML='<div class="alert ok">âœ… '+(r.message||'Password updated! You can now sign in.')+'</div>';
    else msg.innerHTML='<div class="alert err">'+(r&&r.message||'Reset failed.')+'</div>';
  }).catch(function(){ msg.innerHTML='<div class="alert err">Connection error.</div>'; });
}

// ============================================================
// STUDENT DASHBOARD
// ============================================================
function renDash() {
  var u=S.user; if (!u) return;
  var vw=(u.progress&&u.progress.vw)?u.progress.vw:[];
  var ar=(u.progress&&u.progress.ar)?u.progress.ar:[];
  var qc=DB.AT.filter(function(a){ return a.email===u.email; }).length;
  var pts=u.points||0, tot=DB.V.length+DB.A.length;
  var pct=tot>0?Math.round((vw.length+ar.length)/tot*100):0;
  g('dw').textContent='Welcome back, '+u.name+'! ğŸ‘‹';
  g('dpct').textContent=pct+'%'; g('dpb').style.width=pct+'%';
  g('dvc').textContent=DB.V.length+' Videos';
  g('dac').textContent=DB.A.length+' Articles';
  g('dcc').textContent=(vw.length+ar.length)+' Completed';
  g('hdr-pts').textContent=pts+' pts';
  g('dsts').innerHTML=sb(pts,'Points')+sb(vw.length,'Videos Watched')+sb(ar.length,'Articles Read')+sb(qc,'Quizzes Done');
  // Rank â€” use Firebase leaderboard (real-time points) if available
  g('drk').textContent='#â€“';
  if (fbOk()) {
    fbGetLeaderboard(function(lb){
      if (lb && lb.length) {
        var rk = lb.findIndex(function(x){ return x.email===u.email; })+1;
        g('drk').textContent = rk ? '#'+rk : '#â€“';
      } else {
        // Fallback to GAS rank
        gasGet('GET_LEADERBOARD','t='+Date.now()).then(function(r){
          if (r&&r.success&&Array.isArray(r.data)){
            var rk=r.data.findIndex(function(x){ return x.email===u.email; })+1;
            g('drk').textContent=rk?'#'+rk:'#â€“';
          }
        }).catch(function(){});
      }
    });
  } else {
    gasGet('GET_LEADERBOARD','t='+Date.now()).then(function(r){
      if (r&&r.success&&Array.isArray(r.data)){
        var rk=r.data.findIndex(function(x){ return x.email===u.email; })+1;
        g('drk').textContent=rk?'#'+rk:'#â€“';
      }
    }).catch(function(){});
  }
}
function sb(v,l){ return '<div class="stat"><div class="sv">'+v+'</div><div class="sl">'+l+'</div></div>'; }

// ============================================================
// VIDEOS
// ============================================================
function renVids() {
  var thm=g('vthf').value, q=g('vsf').value.toLowerCase();
  var u=S.user, vw=(u&&u.progress&&u.progress.vw)?u.progress.vw:[];
  var list=DB.V.filter(function(v){ return (!thm||v.theme===thm)&&(!q||(v.title||'').toLowerCase().includes(q)||(v.theme||'').toLowerCase().includes(q)); });
  var gr=g('vgrid');
  if (!list.length) {
    gr.innerHTML='<div class="empty"><div class="ei">ğŸ¬</div><p>No videos found.'+(DB.V.length===0&&CFG.gas?' Content is loadingâ€¦':'')+'</p></div>';
    return;
  }
  gr.innerHTML=list.map(function(v){
    var done=vw.indexOf(String(v.id))>=0;
    var qz=DB.Q.find(function(q){ return q.ct==='video'&&String(q.ci)===String(v.id); });
    var qd=qz&&DB.AT.some(function(a){ return a.email===(u&&u.email)&&a.qid===qz.id; });
    return '<div class="cc">'+
      '<span class="ctag">'+(esc(v.theme)||'General')+'</span>'+
      '<div class="ctitle">'+esc(v.title)+'</div>'+
      '<div class="cmeta">'+(v.duration?'<span>â± '+esc(v.duration)+'</span>':'')+
        (done?'<span class="bdg bdg-g">âœ“ Watched</span>':'')+
        (qd?'<span class="bdg bdg-a">âœ“ Quiz Done</span>':'')+
      '</div>'+
      (v.description?'<div class="cdesc">'+esc(v.description)+'</div>':'')+
      '<div class="cacts">'+
        '<a href="'+esc(v.url||'#')+'" target="_blank" rel="noopener" class="btn bp sm" onclick="markW(\''+esc(String(v.id))+'\')">â–¶ Watch</a>'+
        (!done?'<button class="btn bg_ sm" onclick="markW(\''+esc(String(v.id))+'\')">âœ“ Mark Watched</button>':'')+
        (qz&&!qd?'<button class="btn ba sm" onclick="startQz(\''+esc(qz.id)+'\')">ğŸ“ Quiz</button>':'')+
      '</div></div>';
  }).join('');
}

function openVid(id) {
  var v=DB.V.find(function(x){ return String(x.id)===String(id); }); if (!v) return;
  var em=getEmbed(v.url||'');
  g('vm-t').textContent=v.title;
  g('vm-b').innerHTML=em
    ? '<div style="position:relative;padding-top:56.25%"><iframe src="'+em+'" style="position:absolute;top:0;left:0;width:100%;height:100%;border-radius:8px;border:none" allowfullscreen></iframe></div>'
    : '<div style="text-align:center;padding:1.5rem"><p style="color:var(--muted);margin-bottom:.9rem">This video cannot be embedded. Open it directly:</p><a href="'+esc(v.url)+'" target="_blank" class="btn bp">Open Video â†’</a></div>';
  g('vm-mk').onclick=function(){ markW(id); closeVov(); };
  g('vov').classList.remove('hidden');
}
function closeVov() { g('vov').classList.add('hidden'); }

function getEmbed(url) {
  if (!url) return null;
  var m;
  if ((m=url.match(/youtube\.com\/watch\?v=([^&]+)/))) return 'https://www.youtube.com/embed/'+m[1];
  if ((m=url.match(/youtu\.be\/([^?]+)/)))             return 'https://www.youtube.com/embed/'+m[1];
  if ((m=url.match(/vimeo\.com\/(\d+)/)))              return 'https://player.vimeo.com/video/'+m[1];
  if ((m=url.match(/dailymotion\.com\/video\/([^?]+)/))) return 'https://www.dailymotion.com/embed/video/'+m[1];
  return null;
}

function markW(id) {
  var u=S.user; if (!u) return;
  if (!u.progress) u.progress={vw:[],ar:[]};
  var sid = String(id);
  if (u.progress.vw.indexOf(sid)>=0) return; // already marked
  var v=DB.V.find(function(x){ return String(x.id)===sid; });

  // Optimistic UI â€” mark immediately so user sees feedback instantly
  u.progress.vw.push(sid);
  lsS('c_prog_'+u.email, u.progress);
  renVids(); renDash();

  // ALWAYS write to GAS (keeps Google Sheet in sync)
  if (S.token && CFG.gas) {
    gasPost('VIDEO_WATCHED',{videoId:id,videoTitle:v?v.title:'',institution:u.institution,cohort:u.cohort}, S.token)
      .catch(function(e){ console.warn('GAS video sync err',e); });
  }

  if (fbOk()) {
    // Firebase: real-time authoritative points
    fbMarkWatched(u.email, id, v?v.title:'', u.institution, u.cohort, function(result){
      if (result !== 'already' && result !== null) {
        S.user.points = result;
        g('hdr-pts').textContent = result + ' pts';
        checkAndIssueTierCerts(result);
        renDash();
      } else if (result === 'already') {
        // Firebase says already recorded â€” GAS may have added points,
        // so re-fetch points from Firebase to ensure accuracy
        fbGetPoints(u.email, function(pts){
          if (pts !== null) { S.user.points = pts; g('hdr-pts').textContent = pts + ' pts'; renDash(); }
        });
      }
    });
  } else {
    // No Firebase â€” use GAS points (already sent above)
    u.points = (u.points||0)+5;
    g('hdr-pts').textContent = u.points+' pts';
  }
}

// ============================================================
// ARTICLES
// ============================================================
function renArts() {
  var thm=g('athf').value, q=g('asf').value.toLowerCase();
  var u=S.user, ar=(u&&u.progress&&u.progress.ar)?u.progress.ar:[];
  var list=DB.A.filter(function(a){ return (!thm||a.theme===thm)&&(!q||(a.title||'').toLowerCase().includes(q)); });
  var gr=g('agrid');
  if (!list.length) {
    gr.innerHTML='<div class="empty"><div class="ei">ğŸ“š</div><p>No articles found.'+(DB.A.length===0&&CFG.gas?' Content is loadingâ€¦':'')+'</p></div>';
    return;
  }
  gr.innerHTML=list.map(function(a){
    var done=ar.indexOf(String(a.id))>=0;
    var qz=DB.Q.find(function(q){ return q.ct==='article'&&String(q.ci)===String(a.id); });
    var qd=qz&&DB.AT.some(function(at){ return at.email===(u&&u.email)&&at.qid===qz.id; });
    return '<div class="cc">'+
      '<span class="ctag">'+(esc(a.theme)||'General')+'</span>'+
      '<div class="ctitle">'+esc(a.title)+'</div>'+
      '<div class="cmeta">'+(a.duration?'<span>â± '+esc(a.duration)+'</span>':'')+
        (done?'<span class="bdg bdg-g">âœ“ Read</span>':'')+
        (qd?'<span class="bdg bdg-a">âœ“ Quiz Done</span>':'')+
      '</div>'+
      (a.description?'<div class="cdesc">'+esc(a.description)+'</div>':'')+
      '<div class="cacts">'+
        '<a href="'+esc(a.url)+'" target="_blank" class="btn bp sm" onclick="markR(\''+esc(String(a.id))+'\')">ğŸ“– Read</a>'+
        (!done?'<button class="btn bg_ sm" onclick="markR(\''+esc(String(a.id))+'\')">âœ“ Mark Read</button>':'')+
        (qz&&!qd?'<button class="btn ba sm" onclick="startQz(\''+esc(qz.id)+'\')">ğŸ“ Quiz</button>':'')+
      '</div></div>';
  }).join('');
}

function markR(id) {
  var u=S.user; if (!u) return;
  if (!u.progress) u.progress={vw:[],ar:[]};
  var sid = String(id);
  if (u.progress.ar.indexOf(sid)>=0) return; // already marked
  var a=DB.A.find(function(x){ return String(x.id)===sid; });

  // Optimistic UI
  u.progress.ar.push(sid);
  lsS('c_prog_'+u.email, u.progress);
  renArts(); renDash();

  // ALWAYS write to GAS (keeps Google Sheet in sync)
  if (S.token && CFG.gas) {
    gasPost('ARTICLE_READ',{articleId:id,articleTitle:a?a.title:'',institution:u.institution,cohort:u.cohort}, S.token)
      .catch(function(e){ console.warn('GAS article sync err',e); });
  }

  if (fbOk()) {
    // Firebase: real-time authoritative points
    fbMarkRead(u.email, id, a?a.title:'', u.institution, u.cohort, function(result){
      if (result !== 'already' && result !== null) {
        S.user.points = result;
        g('hdr-pts').textContent = result + ' pts';
        checkAndIssueTierCerts(result);
        renDash();
      } else if (result === 'already') {
        fbGetPoints(u.email, function(pts){
          if (pts !== null) { S.user.points = pts; g('hdr-pts').textContent = pts + ' pts'; renDash(); }
        });
      }
    });
  } else {
    u.points = (u.points||0)+5;
    g('hdr-pts').textContent = u.points+' pts';
  }
}

// ============================================================
// PROGRESS
// ============================================================
function renProg() {
  var u=S.user; if (!u) return;
  var vw=(u.progress&&u.progress.vw)?u.progress.vw:[];
  var ar=(u.progress&&u.progress.ar)?u.progress.ar:[];
  var myA=DB.AT.filter(function(a){ return a.email===u.email; });
  var pts=u.points||0, tot=DB.V.length+DB.A.length;
  var pct=tot>0?Math.round((vw.length+ar.length)/tot*100):0;
  g('psts').innerHTML=sb(pts,'Points')+sb(vw.length+'/'+DB.V.length,'Videos')+sb(ar.length+'/'+DB.A.length,'Articles')+sb(myA.length,'Quizzes Done')+sb(pct+'%','Progress');
  var qh=g('qhist');
  qh.innerHTML=myA.length
    ? '<table class="lbt"><thead><tr><th>Date</th><th>Quiz</th><th>Score</th><th>Points</th></tr></thead><tbody>'+
        myA.map(function(a){ return '<tr><td>'+fd(a.date)+'</td><td>'+esc(a.qt)+'</td><td>'+a.sc+'/'+a.tot+'</td><td>+'+a.pe+'</td></tr>'; }).join('')+
      '</tbody></table>'
    : '<p style="color:var(--muted)">No quizzes taken yet.</p>';
  var dc=g('donec');
  var dv=vw.map(function(id){ return DB.V.find(function(v){ return String(v.id)===String(id); }); }).filter(Boolean);
  var da=ar.map(function(id){ return DB.A.find(function(a){ return String(a.id)===String(id); }); }).filter(Boolean);
  if (!dv.length&&!da.length) { dc.innerHTML='<p style="color:var(--muted)">No content completed yet.</p>'; return; }
  dc.innerHTML=dv.map(function(v){ return '<div class="cc"><span class="ctag">ğŸ¬ Video</span><div class="ctitle">'+esc(v.title)+'</div><span class="bdg bdg-g">âœ“ Watched</span></div>'; }).join('')+
    da.map(function(a){ return '<div class="cc"><span class="ctag">ğŸ“š Article</span><div class="ctitle">'+esc(a.title)+'</div><span class="bdg bdg-g">âœ“ Read</span></div>'; }).join('');
}

// ============================================================
// LEADERBOARD
// ============================================================
function loadLb() {
  g('lb-body').innerHTML='<div class="spinner"></div>';
  var u=S.user, medals=['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];

  function renderLb(lb) {
    if (!lb||!lb.length) { g('lb-body').innerHTML='<div class="empty"><div class="ei">ğŸ†</div><p>No students yet.</p></div>'; return; }
    g('lb-body').innerHTML='<table class="lbt"><thead><tr><th>Rank</th><th>Name</th><th>Institution</th><th>Points</th></tr></thead><tbody>'+
      lb.map(function(row,i){ return '<tr style="'+(u&&row.email===u.email?'background:rgba(245,184,0,.08);font-weight:600;':'')+'">'+'<td>'+(medals[i]||'#'+(i+1))+'</td><td>'+esc(row.name)+'</td><td>'+(esc(row.institution)||'â€“')+'</td><td><strong>'+row.points+'</strong></td></tr>'; }).join('')+
    '</tbody></table>';
  }

  if (fbOk()) {
    fbGetLeaderboard(function(lb){ if (lb) renderLb(lb); else loadLbFromGAS(renderLb); });
  } else {
    loadLbFromGAS(renderLb);
  }
}

function loadLbFromGAS(cb) {
  if (!CFG.gas) { cb([]); return; }
  gasGet('GET_LEADERBOARD','t='+Date.now()).then(function(r){
    cb((r&&r.success&&Array.isArray(r.data))?r.data:[]);
  }).catch(function(){ cb([]); });
}


// ============================================================
// QUIZ ENGINE
// ============================================================
var QS={qz:null,cur:0,ans:[],sel:null,multiSel:[]};

function startQz(qid) {
  var qz=DB.Q.find(function(q){ return q.id===qid; }); if (!qz) return;
  var u=S.user;
  var done=DB.AT.some(function(a){ return a.email===u.email&&a.qid===qid; });
  if (done&&!qz.retry) { alreadyDone(qz); return; }
  QS.qz=qz; QS.cur=0; QS.ans=[]; QS.sel=null; QS.multiSel=[];
  g('qm-t').textContent=qz.title;
  g('qov').classList.remove('hidden'); renQz();
}

function renQz() {
  var qz=QS.qz, q=qz.qs[QS.cur];
  var type=q.type||'mcq';
  var pct=Math.round(QS.cur/qz.qs.length*100);
  var typeBadge={
    mcq:  '<span class="qtype-badge qt-mcq">Single Answer</span>',
    multi:'<span class="qtype-badge qt-multi">Multiple Answers</span>',
    long: '<span class="qtype-badge qt-long">Long Answer</span>',
    tf:   '<span class="qtype-badge qt-tf">True / False</span>'
  }[type]||'';

  var bodyHtml=
    '<div class="qinfo"><span>Q '+(QS.cur+1)+' of '+qz.qs.length+'</span><span>'+qz.pts+' pts</span></div>'+
    '<div class="pb-w"><div class="pb-f" style="width:'+pct+'%"></div></div>'+
    '<div style="margin-top:.9rem">'+
      '<div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.35rem">'+
        '<div class="qnum" style="margin:0">Q'+(QS.cur+1)+'</div>'+typeBadge+
      '</div>'+
      '<div class="qtxt">'+esc(q.q)+'</div>';

  if (type==='mcq') {
    bodyHtml+='<div class="qopts" id="qopts">'+
      q.opts.map(function(o,i){ return '<button class="qopt" onclick="pickMcq('+i+')"><span style="font-weight:700;color:var(--muted);margin-right:.5rem">'+['A','B','C','D'][i]+'.</span>'+esc(o)+'</button>'; }).join('')+
    '</div>';
  } else if (type==='tf') {
    bodyHtml+='<div class="qopts" id="qopts" style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem;margin-top:.5rem">'+
      '<button class="qopt" id="tf-t" onclick="pickMcq(0)" style="font-size:1.1rem;font-weight:700;padding:1.2rem;justify-content:center;border-radius:12px">âœ… True</button>'+
      '<button class="qopt" id="tf-f" onclick="pickMcq(1)" style="font-size:1.1rem;font-weight:700;padding:1.2rem;justify-content:center;border-radius:12px">âŒ False</button>'+
    '</div>';
  } else if (type==='multi') {
    bodyHtml+='<div class="multi-note">â˜‘ï¸ Select ALL correct answers, then click Submit</div>'+
      '<div class="qopts" id="qopts">'+
      q.opts.map(function(o,i){ return '<button class="qopt" onclick="pickMulti('+i+',this)"><span style="font-weight:700;color:var(--muted);margin-right:.5rem">'+['A','B','C','D'][i]+'.</span>'+esc(o)+'</button>'; }).join('')+
    '</div>';
  } else {
    bodyHtml+='<div class="long-note">âœï¸ This is an open-ended question. Type your answer below. You will receive full points for attempting it.</div>'+
      '<textarea class="long-ans" id="long-ans-input" placeholder="Type your answer here\u2026" oninput="onLongAnsInput()"></textarea>';
  }

  bodyHtml+=
    '<div id="qfb" class="hidden"></div>'+
    '<div style="display:flex;justify-content:space-between;margin-top:.9rem">'+
      '<button class="btn bg_ sm" onclick="closeQz()">Exit</button>'+
      '<button class="btn bp sm" id="qnxt" onclick="subA()" '+((type==='mcq'||type==='multi'||type==='tf')?'disabled':'')+'>'+
        (QS.cur<qz.qs.length-1?'Next â†’':'Submit Quiz')+
      '</button>'+
    '</div>'+
  '</div>';

  g('qm-b').innerHTML=bodyHtml;
  if (type==='multi') QS.multiSel=[];
}

function pickMcq(i) {
  if (document.querySelector('.qopt.cor')||document.querySelector('.qopt.wrg')) return;
  QS.sel=i;
  document.querySelectorAll('#qopts .qopt').forEach(function(el,idx){ el.classList.toggle('sel',idx===i); });
  g('qnxt').disabled=false;
}

function pickMulti(i, btn) {
  if (btn.classList.contains('cor')||btn.classList.contains('wrg')) return;
  if (!QS.multiSel) QS.multiSel=[];
  var idx=QS.multiSel.indexOf(i);
  if (idx>=0) { QS.multiSel.splice(idx,1); btn.classList.remove('sel'); }
  else        { QS.multiSel.push(i);       btn.classList.add('sel'); }
  g('qnxt').disabled=QS.multiSel.length===0;
}

function onLongAnsInput() {
  var el=g('long-ans-input'), nxt=g('qnxt');
  if (el && nxt) nxt.disabled=!el.value.trim();
}

function subA() {
  var q=QS.qz.qs[QS.cur];
  var type=q.type||'mcq';
  var fb=g('qfb'), nxt=g('qnxt');
  var ok=false;

  if (type==='mcq'||type==='tf') {
    if (QS.sel===null) return;
    QS.ans[QS.cur]={type:type, sel:QS.sel};
    ok=(QS.sel===q.cor);
    document.querySelectorAll('#qopts .qopt').forEach(function(el,i){
      el.classList.add('dis');
      if (i===q.cor) el.classList.add('cor');
      else if (i===QS.sel&&!ok) el.classList.add('wrg');
    });
    fb.className='qfb '+(ok?'ok':'no');
    fb.textContent=ok?'âœ… Correct!':'âŒ Incorrect. Answer: '+(type==='tf'?['True','False'][q.cor]:q.opts[q.cor]);
    fb.classList.remove('hidden');
    QS.sel=null;

  } else if (type==='multi') {
    var sel=QS.multiSel||[];
    var cors=q.cors||[];
    var allRight=cors.length===sel.length&&cors.every(function(c){ return sel.indexOf(c)>=0; });
    QS.ans[QS.cur]={type:'multi',sel:sel.slice()};
    ok=allRight;
    document.querySelectorAll('#qopts .qopt').forEach(function(el,i){
      el.classList.add('dis');
      if (cors.indexOf(i)>=0) el.classList.add('cor');
      else if (sel.indexOf(i)>=0&&cors.indexOf(i)<0) el.classList.add('wrg');
    });
    fb.className='qfb '+(ok?'ok':'no');
    fb.textContent=ok?'âœ… All correct!':'âŒ Not quite. Correct: '+cors.map(function(c){ return ['A','B','C','D'][c]; }).join(', ');
    fb.classList.remove('hidden');
    QS.multiSel=[];

  } else { // long
    var ans=g('long-ans-input');
    if (!ans||!ans.value.trim()) return;
    QS.ans[QS.cur]={type:'long', text:ans.value.trim()};
    ok=true;
    fb.className='qfb ok';
    fb.textContent='âœ… Answer recorded! Full marks awarded for attempting.';
    fb.classList.remove('hidden');
    ans.disabled=true;
  }

  nxt.disabled=false;
  nxt.textContent=QS.cur<QS.qz.qs.length-1?'Next â†’':'Submit Quiz';
  nxt.onclick=function(){
    if (QS.cur<QS.qz.qs.length-1) { QS.cur++; QS.sel=null; renQz(); }
    else finishQz();
  };
}

function finishQz() {
  var qz=QS.qz, u=S.user;
  var cor=0, tot=0, longCount=0, longSummary='';

  qz.qs.forEach(function(q,i){
    var a=QS.ans[i]; if (!a) return;
    if (q.type==='long') { cor+=1; tot+=1; longCount++; longSummary+='<div style="margin:.35rem 0;padding:.4rem .6rem;background:var(--bg);border-radius:6px;font-size:.79rem"><strong>Q'+(i+1)+':</strong> '+esc(a.text||'')+'</div>'; }
    else if (q.type==='mcq'||q.type==='tf') { tot+=1; if (a.sel===q.cor) cor+=1; }
    else if (q.type==='multi') { tot+=1; var cors=q.cors||[],sel=a.sel||[]; if (cors.length===sel.length&&cors.every(function(c){ return sel.indexOf(c)>=0; })) cor+=1; }
  });

  var pct=tot>0?Math.round(cor/tot*100):100;
  var earnedPts=cor*qz.pts;

  DB.AT.push({email:u.email,qid:qz.id,qt:qz.title,sc:cor,tot:tot,pe:earnedPts,
    longAnswers:QS.ans.map(function(a,i){ return (qz.qs[i].type==='long')?(a&&a.text||''):null; }),
    date:new Date().toISOString()});
  lsS('c_at', DB.AT);
  u.points=(u.points||0)+earnedPts;
  g('hdr-pts').textContent=u.points+' pts';

  // ALWAYS write quiz result to GAS (keeps Google Sheet in sync)
  if (S.token && CFG.gas) {
    gasPost('QUIZ_COMPLETED',{
      quizId:qz.id, quizTitle:qz.title, score:cor, total:tot, pointsEarned:earnedPts,
      longAnswers:QS.ans.map(function(a,i){ return (qz.qs[i]&&qz.qs[i].type==='long')?(a&&a.text||''):null; })
    }, S.token).catch(function(e){ console.warn('GAS quiz sync err',e); });
  }

  if (fbOk()) {
    // Firebase: authoritative points (atomic transaction)
    fbRecordQuiz(u.email, qz.id, qz.title, cor, tot, earnedPts, function(newPts){
      if (newPts !== null) {
        S.user.points = newPts;
        u.points = newPts;
        g('hdr-pts').textContent = newPts + ' pts';
      }
      checkAndIssueTierCerts(u.points);
    });
  } else {
    checkAndIssueTierCerts(u.points);
  }

  g('qm-b').innerHTML=
    '<div class="qres">'+
      '<div style="font-size:2.2rem;margin-bottom:.4rem">'+(pct>=70?'&#127881;':'&#128218;')+'</div>'+
      '<div class="qsc">'+pct+'%</div>'+
      '<p style="color:var(--muted);margin:.3rem 0">'+cor+' / '+tot+' questions correct</p>'+
      (longCount?'<p style="font-size:.79rem;color:var(--purple);margin:.25rem 0">'+longCount+' long answer(s) auto-awarded full marks</p>':'')+
      '<div style="font-size:1.3rem;font-weight:700;color:var(--accent);margin:.75rem 0">+'+earnedPts+' points!</div>'+
      '<p style="color:var(--muted);font-size:.8rem;margin-bottom:.5rem">Total: <strong>'+u.points+' pts</strong> &mdash; Keep learning to unlock tier certificates!</p>'+
      (longSummary?'<div style="margin-top:.75rem;text-align:left"><small style="color:var(--muted);font-weight:600">YOUR LONG ANSWERS:</small>'+longSummary+'</div>':'')+
      '<div style="display:flex;gap:.5rem;justify-content:center;margin-top:1rem;flex-wrap:wrap">'+
        '<button class="btn bp" onclick="closeQz()">Done</button>'+
        '<button class="btn bg_" onclick="closeQz();showPg(&quot;pg-certs&quot;)">&#127885; My Certificates</button>'+
      '</div>'+
    '</div>';
}


function alreadyDone(qz) {
  var att=DB.AT.find(function(a){ return a.email===S.user.email&&a.qid===qz.id; });
  g('qm-t').textContent=qz.title;
  g('qm-b').innerHTML=
    '<div class="qres">'+
      '<div style="font-size:2.2rem">âœ…</div>'+
      '<h3 style="color:var(--primary);margin:.65rem 0 .3rem">Already Completed!</h3>'+
      (att?'<p style="color:var(--muted)">Score: '+att.sc+'/'+att.tot+' Â· Points: '+att.pe+'</p>':'')+
      '<p style="color:var(--muted);font-size:.8rem;margin-top:.3rem">Re-attempts are disabled.</p>'+
      '<button class="btn bg_" style="margin-top:1.1rem" onclick="closeQz()">Close</button>'+
    '</div>';
  g('qov').classList.remove('hidden');
}

function closeQz() {
  g('qov').classList.add('hidden');
  QS.qz=null; QS.cur=0; QS.ans=[]; QS.sel=null;
  renVids(); renArts();
}

// ============================================================
// ADMIN NAV
// ============================================================
function gadm(el, sec) {
  document.querySelectorAll('.sb-ni').forEach(function(n){ n.classList.remove('on'); });
  el.classList.add('on');
  document.querySelectorAll('.as').forEach(function(s){ s.classList.remove('on'); });
  g(sec).classList.add('on');
  if (sec==='as-ov') renAdmOv();
  if (sec==='as-us') { loadAdmStudents(); }
  if (sec==='as-vd') renAdmVids();
  if (sec==='as-ar') renAdmArts();
  if (sec==='as-qz') { refDrop(); renAdmQzs(); }
  if (sec==='as-at') renAdmAtts();
  if (sec==='as-lb') loadAdmLb();
  if (sec==='as-pi') loadAdmPI();
  if (sec==='as-cert-cfg') loadCertCfg();
}

// ============================================================
// ADMIN OVERVIEW
// ============================================================
var admStudents = [];

function renAdmOv() {
  g('adm-sts').innerHTML=sb(admStudents.length,'Students')+sb(DB.V.length,'Videos')+sb(DB.A.length,'Articles')+sb(DB.Q.length,'Quizzes')+sb(DB.AT.length,'Local Attempts');
  var lb=admStudents.slice().sort(function(a,b){ return b.points-a.points; }).slice(0,5);
  g('top5').innerHTML=lb.length
    ? lb.map(function(u,i){ return '<div style="display:flex;justify-content:space-between;padding:.3rem 0;border-bottom:1px solid var(--border)"><span>#'+(i+1)+' '+esc(u.name)+'</span><strong>'+u.points+' pts</strong></div>'; }).join('')
    : '<p style="color:var(--muted);font-size:.83rem">Loadingâ€¦</p>';
  g('recact').innerHTML='<p style="color:var(--muted);font-size:.83rem">Activity logged in Google Sheet.</p>';
}

// â”€â”€ Admin Students â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadAdmStudents() {
  if (!CFG.gas) { renUsers(); return; }
  g('u-loading').classList.remove('hidden');
  gasGet('GET_LEADERBOARD','t='+Date.now()).then(function(r){
    g('u-loading').classList.add('hidden');
    if (r&&r.success&&Array.isArray(r.data)) {
      admStudents = r.data;
      renUsers(); renAdmOv();
    }
  }).catch(function(){ g('u-loading').classList.add('hidden'); });
}

function renUsers() {
  var q=(g('usrch').value||'').toLowerCase();
  var list=admStudents.filter(function(u){ return !q||(u.name||'').toLowerCase().includes(q)||(u.email||'').toLowerCase().includes(q); });
  g('u-tb').innerHTML=list.length
    ? list.map(function(u){ return '<tr>'+
        '<td>'+esc(u.name)+'</td><td>'+esc(u.email)+'</td><td>'+(esc(u.institution)||'â€“')+'</td><td>'+(esc(u.cohort)||'â€“')+'</td>'+
        '<td><strong>'+(u.points||0)+'</strong></td>'+
        '<td>â€“</td>'+ // joined date not available from leaderboard
        '<td><div class="tacts"><button class="btn bg_ sm" onclick="openAdj(\''+esc(u.email)+'\',\''+esc(u.name)+'\')">âš¡ Points</button></div></td>'+
      '</tr>'; }).join('')
    : '<tr><td colspan="7" style="text-align:center;color:var(--muted)">No students found. Click Refresh.</td></tr>';
}

// â”€â”€ Admin Videos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveVid() {
  var id=g('vf-id').value.trim(), ti=g('vf-ti').value.trim(), th=g('vf-th').value.trim();
  var ur=g('vf-ur').value.trim(), du=g('vf-du').value.trim(), de=g('vf-de').value.trim();
  if (!ti) { alert('Title is required.'); return; }
  if (!ur) { alert('Video URL is required.'); return; }
  if (!CFG.gas) { alert('Please save GAS URL in Settings first.'); return; }

  gasPost('SAVE_VIDEO', {id:id,title:ti,theme:th,url:ur,duration:du,description:de}).then(function(r){
    if (!r||!r.success) { alert('Save failed: '+(r&&r.message||'unknown error')); return; }
    toast('Video saved to Google Sheets!');
    if (r.data && r.data.id && !id) {
      // Insert locally with new ID
      DB.V.push({id:r.data.id, title:ti, theme:th, url:ur, duration:du, description:de});
    } else if (id) {
      var i=DB.V.findIndex(function(v){ return String(v.id)===id; });
      if (i>=0) DB.V[i]={id:id,title:ti,theme:th,url:ur,duration:du,description:de};
    }
    lsS('c_v', DB.V);
    clrVid(); renAdmVids();
  }).catch(function(e){ alert('Error: '+e); });
}
function editVid(id) {
  var v=DB.V.find(function(x){ return String(x.id)===String(id); }); if (!v) return;
  g('vf-id').value=v.id; g('vf-ti').value=v.title; g('vf-th').value=v.theme||'';
  g('vf-ur').value=v.url||''; g('vf-du').value=v.duration||''; g('vf-de').value=v.description||'';
  g('vf-t').textContent='âœï¸ Edit Video';
  g('vf-ti').scrollIntoView({behavior:'smooth',block:'center'});
}
function delVid(id) {
  openCo('Delete Video','Delete this video? This removes it from Google Sheets.',function(){
    gasPost('DELETE_CONTENT',{id:String(id)}).then(function(r){
      DB.V=DB.V.filter(function(v){ return String(v.id)!==String(id); });
      lsS('c_v', DB.V); renAdmVids(); toast(r&&r.success?'Deleted!':'Deleted locally (sheet sync may lag).');
    }).catch(function(){ DB.V=DB.V.filter(function(v){ return String(v.id)!==String(id); }); lsS('c_v',DB.V); renAdmVids(); });
  });
}
function clrVid() {
  g('vf-id').value='';
  ['vf-ti','vf-th','vf-ur','vf-du','vf-de'].forEach(function(x){ g(x).value=''; });
  g('vf-t').textContent='â• Add New Video';
}
function renAdmVids() {
  g('vf-tb').innerHTML=DB.V.length
    ? DB.V.map(function(v){
        var hq=DB.Q.some(function(q){ return q.ct==='video'&&String(q.ci)===String(v.id); });
        return '<tr><td>'+esc(v.title)+'</td><td>'+(esc(v.theme)||'â€“')+'</td><td>'+(esc(v.duration)||'â€“')+'</td>'+
          '<td>'+(hq?'<span class="chip cg">âœ“ Yes</span>':'<span class="chip cr">No</span>')+'</td>'+
          '<td><div class="tacts"><button class="btn bg_ sm" onclick="editVid(\''+esc(String(v.id))+'\')">âœï¸ Edit</button><button class="btn bd sm" onclick="delVid(\''+esc(String(v.id))+'\')">Delete</button></div></td></tr>';
      }).join('')
    : '<tr><td colspan="5" style="text-align:center;color:var(--muted)">No videos yet. Add one above.</td></tr>';
}

// â”€â”€ Admin Articles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveArt() {
  var id=g('af-id').value.trim(), ti=g('af-ti').value.trim(), th=g('af-th').value.trim();
  var ur=g('af-ur').value.trim(), du=g('af-du').value.trim(), de=g('af-de').value.trim();
  if (!ti) { alert('Title is required.'); return; }
  if (!ur) { alert('Article URL is required.'); return; }
  if (!CFG.gas) { alert('Please save GAS URL in Settings first.'); return; }
  gasPost('SAVE_ARTICLE', {id:id,title:ti,theme:th,url:ur,duration:du,description:de}).then(function(r){
    if (!r||!r.success) { alert('Save failed: '+(r&&r.message||'unknown')); return; }
    toast('Article saved to Google Sheets!');
    if (r.data && r.data.id && !id) DB.A.push({id:r.data.id,title:ti,theme:th,url:ur,duration:du,description:de});
    else if (id) { var i=DB.A.findIndex(function(a){ return String(a.id)===id; }); if (i>=0) DB.A[i]={id:id,title:ti,theme:th,url:ur,duration:du,description:de}; }
    lsS('c_a', DB.A);
    clrArt(); renAdmArts();
  }).catch(function(e){ alert('Error: '+e); });
}
function editArt(id) {
  var a=DB.A.find(function(x){ return String(x.id)===String(id); }); if (!a) return;
  g('af-id').value=a.id; g('af-ti').value=a.title; g('af-th').value=a.theme||'';
  g('af-ur').value=a.url||''; g('af-du').value=a.duration||''; g('af-de').value=a.description||'';
  g('af-t').textContent='âœï¸ Edit Article';
  g('af-ti').scrollIntoView({behavior:'smooth',block:'center'});
}
function delArt(id) {
  openCo('Delete Article','Delete this article?',function(){
    gasPost('DELETE_CONTENT',{id:String(id)}).then(function(r){
      DB.A=DB.A.filter(function(a){ return String(a.id)!==String(id); });
      lsS('c_a', DB.A); renAdmArts(); toast(r&&r.success?'Deleted!':'Deleted locally.');
    }).catch(function(){ DB.A=DB.A.filter(function(a){ return String(a.id)!==String(id); }); lsS('c_a',DB.A); renAdmArts(); });
  });
}
function clrArt() {
  g('af-id').value='';
  ['af-ti','af-th','af-ur','af-du','af-de'].forEach(function(x){ g(x).value=''; });
  g('af-t').textContent='â• Add New Article';
}
function renAdmArts() {
  g('af-tb').innerHTML=DB.A.length
    ? DB.A.map(function(a){
        var hq=DB.Q.some(function(q){ return q.ct==='article'&&String(q.ci)===String(a.id); });
        return '<tr><td>'+esc(a.title)+'</td><td>'+(esc(a.theme)||'â€“')+'</td><td>'+(esc(a.duration)||'â€“')+'</td>'+
          '<td>'+(hq?'<span class="chip cg">âœ“ Yes</span>':'<span class="chip cr">No</span>')+'</td>'+
          '<td><div class="tacts"><button class="btn bg_ sm" onclick="editArt(\''+esc(String(a.id))+'\')">âœï¸ Edit</button><button class="btn bd sm" onclick="delArt(\''+esc(String(a.id))+'\')">Delete</button></div></td></tr>';
      }).join('')
    : '<tr><td colspan="5" style="text-align:center;color:var(--muted)">No articles yet. Add one above.</td></tr>';
}

// â”€â”€ Admin Quizzes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var qCnt=0;

function refDrop() {
  var ct=g('qf-ct').value, lw=g('qf-lw'), sel=g('qf-ci');
  if (ct==='standalone') { lw.style.display='none'; return; }
  lw.style.display='';
  var items=ct==='video'?DB.V:DB.A;
  sel.innerHTML=items.length
    ? items.map(function(x){ return '<option value="'+esc(String(x.id))+'">'+esc(x.title)+'</option>'; }).join('')
    : '<option value="">â€“ No '+ct+'s added yet â€“</option>';
}

function addQ(qd, forcedType) {
  qCnt++;
  var n=qCnt, type=forcedType||(qd&&qd.type)||'mcq', L=['A','B','C','D'];
  var typeBadges={mcq:'<span class="qtype-badge qt-mcq">Single Answer (MCQ)</span>',multi:'<span class="qtype-badge qt-multi">Multiple Correct Answers</span>',long:'<span class="qtype-badge qt-long">Long Answer</span>',tf:'<span class="qtype-badge qt-tf">True / False</span>'};
  var optsHtml='';
  if (type==='mcq') {
    optsHtml='<div class="fg"><label>Options <span style="font-weight:400;color:var(--muted);font-size:.76rem">â€” click â—‹ to mark the ONE correct answer</span></label><p class="ohint">Click the circle on the LEFT of the correct answer</p>';
    for (var i=0;i<4;i++) { var val=(qd&&qd.opts&&qd.opts[i])||'',chk=(qd&&qd.cor===i)?'checked':''; optsHtml+='<div class="orow"><input type="radio" name="qr-'+n+'" value="'+i+'" '+chk+'><span class="ol">'+L[i]+'.</span><input type="text" id="op-'+n+'-'+i+'" placeholder="Option '+L[i]+'..." value="'+esc(val)+'"></div>'; }
    optsHtml+='</div>';
  } else if (type==='tf') {
    var tChk=(qd&&qd.cor===0)?'checked':'', fChk=(qd&&qd.cor===1)?'checked':'';
    optsHtml='<div class="fg"><label>Correct Answer</label><div style="display:grid;grid-template-columns:1fr 1fr;gap:.65rem;margin-top:.3rem"><label style="display:flex;align-items:center;gap:.6rem;padding:.85rem 1rem;border:2px solid var(--border);border-radius:10px;cursor:pointer;font-weight:600"><input type="radio" name="qr-'+n+'" value="0" '+tChk+' style="width:auto;min-width:16px;accent-color:#059669"> âœ… True</label><label style="display:flex;align-items:center;gap:.6rem;padding:.85rem 1rem;border:2px solid var(--border);border-radius:10px;cursor:pointer;font-weight:600"><input type="radio" name="qr-'+n+'" value="1" '+fChk+' style="width:auto;min-width:16px;accent-color:#dc2626"> âŒ False</label></div></div>';
  } else if (type==='multi') {
    var cors=Array.isArray(qd&&qd.cors)?qd.cors:[];
    optsHtml='<div class="fg"><label>Options <span style="font-weight:400;color:var(--muted);font-size:.76rem">â€” tick ALL correct answers</span></label><p class="ohint" style="color:#854d0e;">Tick all checkboxes that are correct</p>';
    for (var i=0;i<4;i++) { var val=(qd&&qd.opts&&qd.opts[i])||'',chk=(cors.indexOf(i)>=0)?'checked':''; optsHtml+='<div class="orow"><input type="checkbox" name="qr-'+n+'" value="'+i+'" '+chk+'><span class="ol">'+L[i]+'.</span><input type="text" id="op-'+n+'-'+i+'" placeholder="Option '+L[i]+'..." value="'+esc(val)+'"></div>'; }
    optsHtml+='</div>';
  } else {
    optsHtml='<div class="long-note">Students type a free-text response. They receive full points for attempting.</div>';
  }
  var wrap=g('qf-qw'), div=document.createElement('div');
  div.className='qbb'; div.id='qb-'+n;
  div.innerHTML='<div class="qbb-hdr"><div style="display:flex;align-items:center;gap:.5rem"><strong style="color:var(--primary)">Q'+n+'</strong>'+(typeBadges[type]||'')+'</div><button type="button" class="btn bd sm" onclick="rmQ('+n+')">Remove</button></div>'+
    '<input type="hidden" id="qtype-'+n+'" value="'+type+'">'+
    '<div class="fg"><label>Question Text *</label><textarea id="qt-'+n+'" rows="2" placeholder="Type your question here...">'+(qd&&qd.q?esc(qd.q):'')+'</textarea></div>'+optsHtml;
  wrap.appendChild(div);
}

function rmQ(n) { var el=g('qb-'+n); if (el) el.remove(); }

function saveQuiz() {
  var id=g('qf-id').value||('qz-'+Date.now());
  var ti=g('qf-nm').value.trim(), pts=parseInt(g('qf-pt').value)||10;
  var ct=g('qf-ct').value, ci=ct==='standalone'?'0':g('qf-ci').value;
  var retry=g('qf-re').checked;
  if (!ti) { alert('Please enter a Quiz Title.'); return; }
  var blocks=document.querySelectorAll('.qbb');
  if (!blocks.length) { alert('Please add at least one question.'); return; }
  var qs=[], err=null;
  for (var bi=0;bi<blocks.length;bi++) {
    if (err) break;
    var n=blocks[bi].id.replace('qb-','');
    var type=(g('qtype-'+n)||{value:'mcq'}).value;
    var qt=(g('qt-'+n)||{value:''}).value.trim();
    if (!qt) { err='Q'+(bi+1)+': Please enter the question text.'; break; }
    if (type==='long') { qs.push({type:'long',q:qt}); }
    else if (type==='tf') {
      var corEl=document.querySelector('input[name="qr-'+n+'"]:checked');
      if (!corEl) { err='Q'+(bi+1)+': Please select True or False.'; break; }
      qs.push({type:'tf',q:qt,cor:parseInt(corEl.value)});
    } else if (type==='mcq') {
      var opts=[]; for (var oi=0;oi<4;oi++) { var oel=g('op-'+n+'-'+oi); opts.push(oel?oel.value.trim():''); }
      for (var oi2=0;oi2<4;oi2++) { if (!opts[oi2]) { err='Q'+(bi+1)+': Option '+['A','B','C','D'][oi2]+' is empty.'; break; } }
      if (err) break;
      var corEl=document.querySelector('input[name="qr-'+n+'"]:checked');
      if (!corEl) { err='Q'+(bi+1)+': Please select the correct answer.'; break; }
      qs.push({type:'mcq',q:qt,opts:opts,cor:parseInt(corEl.value)});
    } else if (type==='multi') {
      var opts=[]; for (var oi=0;oi<4;oi++) { var oel=g('op-'+n+'-'+oi); opts.push(oel?oel.value.trim():''); }
      for (var oi2=0;oi2<4;oi2++) { if (!opts[oi2]) { err='Q'+(bi+1)+': Option '+['A','B','C','D'][oi2]+' is empty.'; break; } }
      if (err) break;
      var corEls=document.querySelectorAll('input[name="qr-'+n+'"]:checked');
      if (!corEls.length) { err='Q'+(bi+1)+': Please tick at least one correct answer.'; break; }
      var cors=[]; corEls.forEach(function(el){ cors.push(parseInt(el.value)); });
      qs.push({type:'multi',q:qt,opts:opts,cors:cors});
    }
  }
  if (err) { alert(err); return; }
  if (!CFG.gas) { alert('Please save GAS URL in Settings first.'); return; }
  var qobj={id:id,title:ti,ct:ct,ci:ci,pts:pts,retry:retry,qs:qs};
  gasPost('SAVE_QUIZ', qobj).then(function(r){
    if (!r||!r.success) { alert('Save failed: '+(r&&r.message||'unknown')); return; }
    toast('Quiz "'+ti+'" saved to Google Sheets!');
    if (r.data && r.data.id) qobj.id = r.data.id;
    var ei=DB.Q.findIndex(function(q){ return q.id===qobj.id; });
    if (ei>=0) DB.Q[ei]=qobj; else DB.Q.push(qobj);
    lsS('c_q', DB.Q);
    clrQz(); renAdmQzs();
  }).catch(function(e){ alert('Error: '+e); });
}

function editQuiz(id) {
  var q=DB.Q.find(function(x){ return x.id===id; }); if (!q) return;
  document.querySelectorAll('.as').forEach(function(s){ s.classList.remove('on'); });
  g('as-qz').classList.add('on');
  document.querySelectorAll('.sb-ni').forEach(function(n){ n.classList.toggle('on',n.getAttribute('data-s')==='as-qz'); });
  g('qf-id').value=q.id; g('qf-nm').value=q.title; g('qf-pt').value=q.pts;
  g('qf-ct').value=q.ct; g('qf-re').checked=q.retry;
  refDrop();
  if (q.ct!=='standalone') {
    var sel=g('qf-ci');
    for (var i=0;i<sel.options.length;i++) { if (String(sel.options[i].value)===String(q.ci)) { sel.selectedIndex=i; break; } }
  }
  g('qf-qw').innerHTML=''; qCnt=0;
  (q.qs||[]).forEach(function(qd){ addQ(qd, qd.type||'mcq'); });
  g('qf-nm').scrollIntoView({behavior:'smooth',block:'center'});
}

function delQuiz(id) {
  openCo('Delete Quiz','Delete this quiz?',function(){
    gasPost('DELETE_QUIZ',{id:id}).then(function(r){
      DB.Q=DB.Q.filter(function(q){ return q.id!==id; }); lsS('c_q',DB.Q); renAdmQzs();
    }).catch(function(){ DB.Q=DB.Q.filter(function(q){ return q.id!==id; }); lsS('c_q',DB.Q); renAdmQzs(); });
  });
}

function clrQz() {
  g('qf-id').value=''; g('qf-nm').value=''; g('qf-pt').value='10';
  g('qf-re').checked=false;
  g('qf-qw').innerHTML='<p class="ohint" style="margin:0">Click one of the buttons above to add a question.</p>';
  g('qf-t').textContent='Create New Quiz'; qCnt=0; refDrop();
}

function renAdmQzs() {
  g('qf-tb').innerHTML=DB.Q.length
    ? DB.Q.map(function(q){
        var lk='Standalone';
        if (q.ct==='video')   { var v=DB.V.find(function(x){ return String(x.id)===String(q.ci); }); lk=v?esc(v.title.substring(0,26)):'Unknown'; }
        if (q.ct==='article') { var a=DB.A.find(function(x){ return String(x.id)===String(q.ci); }); lk=a?esc(a.title.substring(0,26)):'Unknown'; }
        var types={mcq:0,multi:0,long:0,tf:0};
        (q.qs||[]).forEach(function(qq){ var t=qq.type||'mcq'; types[t]=(types[t]||0)+1; });
        var ts='';
        if (types.mcq)   ts+='<span class="qtype-badge qt-mcq" style="font-size:.62rem">'+types.mcq+' MCQ</span> ';
        if (types.tf)    ts+='<span class="qtype-badge qt-tf" style="font-size:.62rem">'+types.tf+' T/F</span> ';
        if (types.multi) ts+='<span class="qtype-badge qt-multi" style="font-size:.62rem">'+types.multi+' Multi</span> ';
        if (types.long)  ts+='<span class="qtype-badge qt-long" style="font-size:.62rem">'+types.long+' Long</span> ';
        return '<tr><td>'+esc(q.title)+'</td>'+
          '<td>'+lk+' <span class="chip cb_" style="font-size:.64rem">'+esc(q.ct)+'</span></td>'+
          '<td>'+q.qs.length+'<br><small>'+ts+'</small></td>'+
          '<td>'+q.pts+'</td>'+
          '<td>'+(q.retry?'<span class="chip cg">Yes</span>':'<span class="chip cr">No</span>')+'</td>'+
          '<td><div class="tacts"><button class="btn bg_ sm" onclick="editQuiz(\''+esc(q.id)+'\')">Edit</button><button class="btn bd sm" onclick="delQuiz(\''+esc(q.id)+'\')">Delete</button></div></td></tr>';
      }).join('')
    : '<tr><td colspan="6" style="text-align:center;color:var(--muted)">No quizzes yet. Create one above.</td></tr>';
}

// â”€â”€ Admin Attempts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renAdmAtts() {
  g('at-tb').innerHTML=DB.AT.length
    ? DB.AT.slice().reverse().map(function(a){ return '<tr><td>'+fd(a.date)+'</td><td>'+esc(a.email)+'</td><td>'+esc(a.qt)+'</td><td>'+a.sc+'/'+a.tot+' ('+Math.round(a.sc/a.tot*100)+'%)</td><td><strong>+'+a.pe+'</strong></td></tr>'; }).join('')
    : '<tr><td colspan="5" style="text-align:center;color:var(--muted)">No attempts recorded locally.</td></tr>';
}

// â”€â”€ Admin Leaderboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadAdmLb() {
  if (!CFG.gas) { renAdmLb([]); return; }
  gasGet('GET_LEADERBOARD','t='+Date.now()).then(function(r){
    renAdmLb((r&&r.success&&r.data)||[]);
  }).catch(function(){ renAdmLb([]); });
}
function renAdmLb(lb) {
  g('lb-tb').innerHTML=(lb&&lb.length)
    ? lb.map(function(u,i){ return '<tr><td>#'+(i+1)+'</td><td>'+esc(u.name)+'</td><td>'+esc(u.email)+'</td><td><strong>'+u.points+'</strong></td>'+
        '<td><button class="btn bg_ sm" onclick="openAdj(\''+esc(u.email)+'\',\''+esc(u.name)+'\')">âš¡ Adjust</button></td></tr>'; }).join('')
    : '<tr><td colspan="5" style="text-align:center;color:var(--muted)">No students yet.</td></tr>';
}
function confReset() {
  openCo('Reset All Points','Set ALL student points to 0? Cannot be undone.',function(){
    if (!CFG.gas) { alert('GAS URL not configured.'); return; }
    gasPost('RESET_LEADERBOARD',{}).then(function(r){
      toast(r&&r.success?'All points reset.':'Reset may have failed. Check Sheet.');
      loadAdmLb();
    }).catch(function(){ alert('Reset failed.'); });
  });
}

// â”€â”€ Adjust Points â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var adjT=null;
function openAdj(email,name) {
  adjT=email; g('ao-nm').textContent='Adjusting: '+name;
  g('ao-v').value=''; g('ao-r').value='';
  g('aov').classList.remove('hidden');
}
function closeAo() { g('aov').classList.add('hidden'); adjT=null; }
function submitAdj() {
  var pts=parseInt(g('ao-v').value)||0, reason=g('ao-r').value.trim();
  if (!adjT||!CFG.gas) return;
  gasPost('ADJUST_POINTS',{email:adjT,adjustment:pts,reason:reason}).then(function(r){
    closeAo(); toast(r&&r.success?'Points adjusted.':'Adjustment failed.'); loadAdmLb();
  }).catch(function(){ closeAo(); alert('Error adjusting points.'); });
}

// ============================================================
// SETTINGS
// ============================================================
function saveGas() {
  var url=g('st-gas').value.trim();
  if (url && !url.startsWith('https://script.google.com')) {
    alert('That does not look like a Google Apps Script URL. Please check.');
    return;
  }
  CFG.gas=url || HARDCODED_GAS_URL; lsS('gas', CFG.gas); toast('Google Sheets URL saved!');
}
function testGas() {
  if (!CFG.gas) { alert('Please save a URL first.'); return; }
  gasGet('', 't='+Date.now()).then(function(r){
    alert(r ? 'âœ… Connected! Response: '+(r.message||JSON.stringify(r)) : 'âŒ Got empty response.');
  }).catch(function(e){ alert('âŒ Connection failed: '+e); });
}
function saveAdmCreds() {
  var u=g('st-au').value.trim(), p=g('st-ap').value.trim();
  if (!u) { alert('Username required.'); return; }
  CFG.admU=u; lsS('admU',u);
  if (p) { CFG.admP=p; lsS('admP',p); }
  toast('Admin credentials updated!');
}
function resetAdmCreds() {
  lsR('admU'); lsR('admP');
  CFG.admU='admin'; CFG.admP='admin123';
  alert('Admin credentials reset!\nUsername: admin\nPassword: admin123');
}
function clrLocalCache() {
  openCo('Clear Local Cache','Delete locally cached content and attempts? Google Sheet data is not affected.',function(){
    ['c_v','c_a','c_q','c_at'].forEach(function(k){ lsR(k); });
    DB.V=[]; DB.A=[]; DB.Q=[]; DB.AT=[];
    toast('Cache cleared. Reloadingâ€¦'); setTimeout(function(){ location.reload(); }, 1500);
  });
}

// ============================================================
// PORTAL INFO â€” About Page
// ============================================================

function loadPortalInfo(cb) {
  // Use local cache instantly, then refresh from server
  var cached = safeJSON(ls('c_pi'), null);
  if (cached) { PI = cached; if (cb) cb(); }

  if (!CFG.gas) { if (!cached) { PI = Object.assign({}, PI_DEFAULTS); if (cb) cb(); } return; }

  gasGet('GET_PORTAL_INFO', 't='+Date.now()).then(function(r){
    if (r && r.success && r.data) {
      PI = r.data;
      lsS('c_pi', PI);
      if (cb) cb();
      // If about page is currently visible, re-render
      if (document.getElementById('pg-about').classList.contains('on')) renderAboutPage();
    } else {
      if (!cached) { PI = Object.assign({}, PI_DEFAULTS); if (cb) cb(); }
    }
  }).catch(function(){
    if (!cached) { PI = Object.assign({}, PI_DEFAULTS); if (cb) cb(); }
  });
}

function renderAboutPage() {
  var p = PI;
  function pj(key) { try { return JSON.parse(p[key] || '[]'); } catch(e){ return []; } }

  // Hero
  g('ab-hero-title').textContent  = p.hero_title    || PI_DEFAULTS.hero_title;
  g('ab-tagline').textContent     = p.hero_tagline   || PI_DEFAULTS.hero_tagline;
  g('ab-hero-desc').textContent   = p.hero_description || PI_DEFAULTS.hero_description;

  // About
  g('ab-about-title').textContent = p.about_title   || PI_DEFAULTS.about_title;
  g('ab-about-text').textContent  = p.about_text    || PI_DEFAULTS.about_text;

  // Features
  var feats = pj('features');
  if (!feats.length) feats = pj.call({PI_DEFAULTS}, PI_DEFAULTS.features) || JSON.parse(PI_DEFAULTS.features);
  g('ab-features').innerHTML = feats.map(function(f){
    var bg = f.color ? hexToRgba(f.color, 0.12) : 'rgba(44,74,94,.08)';
    return '<div class="feat-card">'+
      '<div class="feat-icon" style="background:'+bg+';color:'+f.color+'">'+esc(f.icon)+'</div>'+
      '<div class="feat-body"><h4>'+esc(f.title)+'</h4><p>'+esc(f.text)+'</p></div>'+
    '</div>';
  }).join('') || '<p style="color:var(--muted)">No features configured.</p>';

  // How It Works
  var hiws = pj('how_it_works');
  if (!hiws.length) hiws = JSON.parse(PI_DEFAULTS.how_it_works);
  g('ab-hiw').innerHTML = hiws.map(function(h, i){
    return '<div class="hiw-card">'+
      '<div class="hiw-num">'+(i+1)+'</div>'+
      '<div class="hiw-icon">'+esc(h.icon)+'</div>'+
      '<h4>'+esc(h.title)+'</h4>'+
      '<p>'+esc(h.text)+'</p>'+
    '</div>';
  }).join('') || '<p style="color:var(--muted)">No steps configured.</p>';

  // SOP
  g('ab-sop-title').textContent = p.sop_title    || PI_DEFAULTS.sop_title;
  g('ab-sop-sub').textContent   = p.sop_subtitle || PI_DEFAULTS.sop_subtitle;
  var sops = pj('sop_steps');
  if (!sops.length) sops = JSON.parse(PI_DEFAULTS.sop_steps);
  g('ab-sop').innerHTML = sops.map(function(s){
    return '<div class="sop-card">'+
      '<div class="sop-num">'+esc(s.step)+'</div>'+
      '<div class="sop-body"><h4>'+esc(s.title)+'</h4><p>'+esc(s.text)+'</p></div>'+
    '</div>';
  }).join('') || '<p style="color:var(--muted)">No SOP steps configured.</p>';

  // Points
  var pts = pj('points_guide');
  if (!pts.length) pts = JSON.parse(PI_DEFAULTS.points_guide);
  g('ab-pts').innerHTML = pts.map(function(row){
    return '<tr><td>'+esc(row.action)+'</td><td><span class="pts-badge">'+esc(row.points)+'</span></td></tr>';
  }).join('') || '<tr><td colspan="2" style="color:var(--muted)">No data.</td></tr>';

  // Contact / Footer
  g('ab-contact').textContent = p.contact_text || PI_DEFAULTS.contact_text;
  g('ab-footer').textContent  = p.footer_note  || PI_DEFAULTS.footer_note;
}

function hexToRgba(hex, alpha) {
  try {
    var r=parseInt(hex.slice(1,3),16), bl=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16);
    return 'rgba('+r+','+bl+','+b+','+alpha+')';
  } catch(e){ return 'rgba(44,74,94,0.1)'; }
}

// â”€â”€ Admin Portal Info Editor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function piTab(el, sec) {
  document.querySelectorAll('.iet').forEach(function(t){ t.classList.remove('on'); });
  document.querySelectorAll('.ie-section').forEach(function(s){ s.classList.remove('on'); });
  el.classList.add('on');
  g(sec).classList.add('on');
}

function loadAdmPI() {
  loadPortalInfo(function(){
    // Populate Hero
    g('pi-hero-title').value   = PI.hero_title    || '';
    g('pi-hero-tagline').value = PI.hero_tagline   || '';
    g('pi-hero-desc').value    = PI.hero_description || '';

    // Populate About
    g('pi-about-title').value = PI.about_title  || '';
    g('pi-about-text').value  = PI.about_text   || '';

    // Populate Features
    piRenderFeatEditor(safeJSON(PI.features, JSON.parse(PI_DEFAULTS.features)));

    // Populate How It Works
    piRenderHiwEditor(safeJSON(PI.how_it_works, JSON.parse(PI_DEFAULTS.how_it_works)));

    // Populate SOP
    g('pi-sop-title').value = PI.sop_title    || '';
    g('pi-sop-sub').value   = PI.sop_subtitle || '';
    piRenderSopEditor(safeJSON(PI.sop_steps, JSON.parse(PI_DEFAULTS.sop_steps)));

    // Populate Points
    piRenderPtsEditor(safeJSON(PI.points_guide, JSON.parse(PI_DEFAULTS.points_guide)));

    // Populate Contact
    g('pi-contact-text').value = PI.contact_text || '';
    g('pi-footer-note').value  = PI.footer_note  || '';
  });
}

// Features editor
function piRenderFeatEditor(feats) {
  g('pi-feat-list').innerHTML = '';
  (feats||[]).forEach(function(f,i){ piFeatAddRow(f,i); });
}
function piFeatAdd() {
  var cur = piFeatCollect();
  piFeatAddRow({icon:'ğŸŒŸ',title:'',text:'',color:'#2C4A5E'}, cur.length);
}
function piFeatAddRow(f, i) {
  var div=document.createElement('div'); div.className='step-ed'; div.id='feat-ed-'+i;
  div.innerHTML=
    '<div class="step-ed-hdr"><span class="step-ed-num">Card '+(i+1)+'</span><button class="btn bd sm" onclick="piRemove(\'feat-ed-'+i+'\')">Remove</button></div>'+
    '<div class="form-row">'+
      '<div class="fg"><label>Icon (emoji)</label><input type="text" id="feat-ic-'+i+'" value="'+esc(f.icon||'')+'" placeholder="ğŸŒ" style="font-size:1.3rem;max-width:80px"></div>'+
      '<div class="fg"><label>Accent Color</label><input type="color" id="feat-cl-'+i+'" value="'+(f.color||'#2C4A5E')+'" style="height:42px;padding:.2rem .4rem;"></div>'+
    '</div>'+
    '<div class="fg"><label>Title</label><input type="text" id="feat-ti-'+i+'" value="'+esc(f.title||'')+'" placeholder="Feature name"></div>'+
    '<div class="fg"><label>Description</label><textarea id="feat-tx-'+i+'" rows="2" placeholder="Brief descriptionâ€¦">'+esc(f.text||'')+'</textarea></div>';
  g('pi-feat-list').appendChild(div);
}
function piFeatCollect() {
  var list=[]; var eds=g('pi-feat-list').querySelectorAll('.step-ed');
  eds.forEach(function(ed,i){
    var n=ed.id.replace('feat-ed-','');
    list.push({icon:(g('feat-ic-'+n)||{value:''}).value, title:(g('feat-ti-'+n)||{value:''}).value, text:(g('feat-tx-'+n)||{value:''}).value, color:(g('feat-cl-'+n)||{value:'#2C4A5E'}).value});
  }); return list;
}

// How It Works editor
function piRenderHiwEditor(steps) {
  g('pi-hiw-list').innerHTML='';
  (steps||[]).forEach(function(s,i){ piHiwAddRow(s,i); });
}
function piHiwAdd() { piHiwAddRow({icon:'ğŸ“Œ',title:'',text:''}, g('pi-hiw-list').querySelectorAll('.step-ed').length); }
function piHiwAddRow(s,i) {
  var div=document.createElement('div'); div.className='step-ed'; div.id='hiw-ed-'+i;
  div.innerHTML=
    '<div class="step-ed-hdr"><span class="step-ed-num">Step '+(i+1)+'</span><button class="btn bd sm" onclick="piRemove(\'hiw-ed-'+i+'\')">Remove</button></div>'+
    '<div class="form-row">'+
      '<div class="fg"><label>Icon (emoji)</label><input type="text" id="hiw-ic-'+i+'" value="'+esc(s.icon||'')+'" placeholder="ğŸ“Œ" style="font-size:1.3rem;max-width:80px"></div>'+
      '<div class="fg"><label>Step Title</label><input type="text" id="hiw-ti-'+i+'" value="'+esc(s.title||'')+'" placeholder="Step title"></div>'+
    '</div>'+
    '<div class="fg"><label>Description</label><textarea id="hiw-tx-'+i+'" rows="2" placeholder="What happens in this stepâ€¦">'+esc(s.text||'')+'</textarea></div>';
  g('pi-hiw-list').appendChild(div);
}
function piHiwCollect() {
  var list=[]; g('pi-hiw-list').querySelectorAll('.step-ed').forEach(function(ed){
    var n=ed.id.replace('hiw-ed-','');
    list.push({icon:(g('hiw-ic-'+n)||{value:''}).value,title:(g('hiw-ti-'+n)||{value:''}).value,text:(g('hiw-tx-'+n)||{value:''}).value});
  }); return list;
}

// SOP editor
function piRenderSopEditor(steps) {
  g('pi-sop-list').innerHTML='';
  (steps||[]).forEach(function(s,i){ piSopAddRow(s,i); });
}
function piSopAdd() { var n=g('pi-sop-list').querySelectorAll('.step-ed').length; piSopAddRow({step:String(n+1).padStart(2,'0'),title:'',text:''},n); }
function piSopAddRow(s,i) {
  var div=document.createElement('div'); div.className='step-ed'; div.id='sop-ed-'+i;
  div.innerHTML=
    '<div class="step-ed-hdr"><span class="step-ed-num">SOP Step '+(i+1)+'</span><button class="btn bd sm" onclick="piRemove(\'sop-ed-'+i+'\')">Remove</button></div>'+
    '<div class="form-row">'+
      '<div class="fg"><label>Step No. (e.g. 01)</label><input type="text" id="sop-st-'+i+'" value="'+esc(s.step||String(i+1))+'" placeholder="01" style="max-width:80px"></div>'+
      '<div class="fg"><label>Title</label><input type="text" id="sop-ti-'+i+'" value="'+esc(s.title||'')+'" placeholder="Step title"></div>'+
    '</div>'+
    '<div class="fg"><label>Instructions</label><textarea id="sop-tx-'+i+'" rows="2" placeholder="What should the student do?">'+esc(s.text||'')+'</textarea></div>';
  g('pi-sop-list').appendChild(div);
}
function piSopCollect() {
  var list=[]; g('pi-sop-list').querySelectorAll('.step-ed').forEach(function(ed){
    var n=ed.id.replace('sop-ed-','');
    list.push({step:(g('sop-st-'+n)||{value:''}).value,title:(g('sop-ti-'+n)||{value:''}).value,text:(g('sop-tx-'+n)||{value:''}).value});
  }); return list;
}

// Points editor
function piRenderPtsEditor(rows) {
  g('pi-pts-list').innerHTML='';
  (rows||[]).forEach(function(r,i){ piPtsAddRow(r,i); });
}
function piPtsAdd() { piPtsAddRow({action:'',points:''},g('pi-pts-list').querySelectorAll('.step-ed').length); }
function piPtsAddRow(r,i) {
  var div=document.createElement('div'); div.className='step-ed'; div.id='pts-ed-'+i;
  div.innerHTML=
    '<div class="step-ed-hdr"><span class="step-ed-num">Row '+(i+1)+'</span><button class="btn bd sm" onclick="piRemove(\'pts-ed-'+i+'\')">Remove</button></div>'+
    '<div class="form-row">'+
      '<div class="fg"><label>Activity</label><input type="text" id="pts-ac-'+i+'" value="'+esc(r.action||'')+'" placeholder="Watch a video"></div>'+
      '<div class="fg"><label>Points Label</label><input type="text" id="pts-pt-'+i+'" value="'+esc(r.points||'')+'" placeholder="+5 pts"></div>'+
    '</div>';
  g('pi-pts-list').appendChild(div);
}
function piPtsCollect() {
  var list=[]; g('pi-pts-list').querySelectorAll('.step-ed').forEach(function(ed){
    var n=ed.id.replace('pts-ed-','');
    list.push({action:(g('pts-ac-'+n)||{value:''}).value,points:(g('pts-pt-'+n)||{value:''}).value});
  }); return list;
}

function piRemove(id) { var el=g(id); if (el) el.remove(); }

// Master save dispatcher
function piSave(section) {
  if (!CFG.gas) { alert('GAS URL not configured in Settings.'); return; }
  var payload = {};
  switch(section) {
    case 'hero':
      payload = { hero_title: g('pi-hero-title').value, hero_tagline: g('pi-hero-tagline').value, hero_description: g('pi-hero-desc').value };
      break;
    case 'about':
      payload = { about_title: g('pi-about-title').value, about_text: g('pi-about-text').value };
      break;
    case 'features':
      payload = { features: JSON.stringify(piFeatCollect()) };
      break;
    case 'hiw':
      payload = { how_it_works: JSON.stringify(piHiwCollect()) };
      break;
    case 'sop':
      payload = { sop_title: g('pi-sop-title').value, sop_subtitle: g('pi-sop-sub').value, sop_steps: JSON.stringify(piSopCollect()) };
      break;
    case 'pts':
      payload = { points_guide: JSON.stringify(piPtsCollect()) };
      break;
    case 'contact':
      payload = { contact_text: g('pi-contact-text').value, footer_note: g('pi-footer-note').value };
      break;
  }
  gasPost('SAVE_PORTAL_INFO', payload).then(function(r){
    if (r && r.success) {
      // Merge into local PI cache
      Object.assign(PI, payload);
      lsS('c_pi', PI);
      toast('Portal info saved! âœ…');
    } else {
      alert('Save failed: '+(r&&r.message||'unknown error'));
    }
  }).catch(function(e){ alert('Error: '+e); });
}

function previewAbout() {
  // Save current state to PI and open About page
  Object.assign(PI, {
    hero_title: g('pi-hero-title').value,
    hero_tagline: g('pi-hero-tagline').value,
    hero_description: g('pi-hero-desc').value,
    about_title: g('pi-about-title').value,
    about_text: g('pi-about-text').value,
    features: JSON.stringify(piFeatCollect()),
    how_it_works: JSON.stringify(piHiwCollect()),
    sop_title: g('pi-sop-title').value,
    sop_subtitle: g('pi-sop-sub').value,
    sop_steps: JSON.stringify(piSopCollect()),
    points_guide: JSON.stringify(piPtsCollect()),
    contact_text: g('pi-contact-text').value,
    footer_note: g('pi-footer-note').value
  });
  renderAboutPage();
  document.querySelectorAll('.pg').forEach(function(p){ p.classList.remove('on'); });
  g('pg-about').classList.add('on');
  window.scrollTo(0,0);
}


// ============================================================
// CERTIFICATES - Point-based tier system
// Tiers: Bronze (100+) Silver (300+) Gold (500+) Platinum (1000+)
// ============================================================

var CERT_TIERS = [
  { id:'bronze', label:'Bronze',   icon:'\u{1F949}', minKey:'cert_bronze_pts', defaultPts:100,  cls:'bronze' },
  { id:'silver', label:'Silver',   icon:'\u{1F948}', minKey:'cert_silver_pts', defaultPts:300,  cls:'silver' },
  { id:'gold',   label:'Gold',     icon:'\u{1F947}', minKey:'cert_gold_pts',   defaultPts:500,  cls:'gold'   },
  { id:'plat',   label:'Platinum', icon:'\u{1F48E}', minKey:'cert_plat_pts',   defaultPts:1000, cls:'plat'   }
];

var LOGO_URI = 'data:image/png;base64,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';

function tierPts(id) {
  var t = CERT_TIERS.find(function(x){ return x.id===id; });
  if (!t) return 9999;
  return parseInt(CERT_CFG[t.minKey] || t.defaultPts) || t.defaultPts;
}

function loadCertConfig(cb) {
  var cached = safeJSON(ls('cert_cfg'), null);
  if (cached) { CERT_CFG = cached; if (cb) cb(); }
  if (!CFG.gas) { if (!cached){ CERT_CFG=Object.assign({},CERT_CFG_DEFAULTS); if(cb)cb(); } return; }
  gasGet('GET_CERT_CONFIG','t='+Date.now()).then(function(r){
    if (r&&r.success&&r.data){ CERT_CFG=r.data; lsS('cert_cfg',CERT_CFG); if(cb)cb(); }
    else if (!cached){ CERT_CFG=Object.assign({},CERT_CFG_DEFAULTS); if(cb)cb(); }
  }).catch(function(){ if(!cached){ CERT_CFG=Object.assign({},CERT_CFG_DEFAULTS); if(cb)cb(); } });
}

function checkAndIssueTierCerts(newPoints) {
  if (!S.user) return;
  var qualifying = CERT_TIERS.filter(function(t){ return newPoints >= tierPts(t.id); });
  if (!qualifying.length) return;

  // Issue tiers sequentially to avoid race conditions
  function issueNext(toIssue, idx) {
    if (idx >= toIssue.length) { updateCertCount(); return; }
    var tier = toIssue[idx];
    var next = function(){ issueNext(toIssue, idx+1); };
    if (fbOk()) {
      fbIssueCert(S.user.email, tier.id, newPoints, function(certData){
        if (certData && !certData.alreadyIssued) showTierUnlockToast(tier, certData);
        next();
      });
    } else if (S.token && CFG.gas) {
      gasPost('ISSUE_CERTIFICATE',{tier:tier.id,points:newPoints},S.token)
        .then(function(res){
          if (res&&res.success&&res.data&&!res.data.alreadyIssued) showTierUnlockToast(tier,res.data);
          next();
        }).catch(next);
    } else next();
  }

  function withIssuedList(cb) {
    if (fbOk()) {
      fbGetCerts(S.user.email, function(certs){ cb(certs||[]); });
    } else if (CFG.gas) {
      gasGet('GET_CERTIFICATES','email='+encodeURIComponent(S.user.email)+'&t='+Date.now())
        .then(function(r){ cb((r&&r.success&&Array.isArray(r.data))?r.data:[]); })
        .catch(function(){ cb([]); });
    } else cb([]);
  }

  withIssuedList(function(issued){
    var issuedTiers = issued.map(function(c){ return c.tier; });
    var toIssue = qualifying.filter(function(t){ return issuedTiers.indexOf(t.id)<0; });
    if (toIssue.length) issueNext(toIssue, 0);
  });
}

function showTierUnlockToast(tier, certData) {
  var colors={bronze:'#CD7F32',silver:'#A8A9AD',gold:'#F5B800',plat:'#5C6BC0'};
  var t=document.createElement('div');
  t.style.cssText='position:fixed;bottom:1.5rem;left:50%;transform:translateX(-50%);background:#fff;border:2.5px solid '+colors[tier.id]+';border-radius:14px;padding:1rem 1.5rem;z-index:3000;box-shadow:0 8px 32px rgba(0,0,0,.18);text-align:center;min-width:260px;font-family:\'DM Sans\',sans-serif;';
  t.innerHTML='<div style="font-size:2rem">'+tier.icon+'</div>'+
    '<div style="font-weight:700;color:#1a2f3d;margin:.2rem 0">'+tier.label+' Certificate Unlocked!</div>'+
    '<div style="font-size:.8rem;color:#6B7B8A;margin-bottom:.7rem">You earned the '+tier.label+' tier!</div>'+
    '<button onclick="showCertificate('+JSON.stringify(certData)+');this.closest(\'div\').remove();" style="background:#2C4A5E;color:#fff;border:none;padding:.4rem 1rem;border-radius:8px;font-size:.82rem;cursor:pointer;font-family:inherit;font-weight:600">View Certificate</button>';
  document.body.appendChild(t);
  setTimeout(function(){ if(t.parentNode) t.remove(); },8000);
}

function loadMyCertsAndView(tierId) {
  // Scroll to cert list and highlight the cert of that tier after loading
  loadMyCerts();
  // After certs load, find and show the cert for this tier
  setTimeout(function(){
    var cards = document.querySelectorAll('.cert-card.'+tierId);
    if (cards.length > 0) cards[0].scrollIntoView({behavior:'smooth',block:'center'});
  }, 800);
}

function loadMyCerts() {
  var u=S.user; if (!u) return;
  var pts=u.points||0;
  var mc=g('cert-milestones');
  if (mc) {
    mc.innerHTML=CERT_TIERS.map(function(t){
      var needed=tierPts(t.id); var earned=pts>=needed;
      var statusLabel=earned?'&#10003; Unlocked':'&#128274; '+needed+' pts needed';
      return '<div class="cm '+t.cls+(earned?' cm-earned':' cm-locked')+'"'+
        (earned?' onclick="loadMyCertsAndView(\'' +t.id+ '\')" style="cursor:pointer"':'')+'>'+
        '<div class="cm-badge">'+t.icon+'</div>'+
        '<div class="cm-tier">'+t.label+'</div>'+
        '<div class="cm-pts">'+needed+'+ points</div>'+
        '<span class="cm-status">'+statusLabel+'</span>'+
        (earned?'<div style="font-size:.68rem;color:var(--muted);margin-top:.3rem">Tap to view</div>':'')+
      '</div>';
    }).join('');
  }
  var pb=g('cert-tier-bars');
  if (pb) {
    pb.innerHTML=CERT_TIERS.map(function(t){
      var needed=tierPts(t.id); var pct=Math.min(100,Math.round(pts/needed*100));
      return '<div class="tier-row">'+
        '<div class="tier-row-icon">'+t.icon+'</div>'+
        '<div class="tier-row-label">'+t.label+'</div>'+
        '<div class="tier-row-bar"><div class="tier-row-fill '+t.cls+'" style="width:'+pct+'%"></div></div>'+
        '<div class="tier-row-pts">'+pts+' / '+needed+'</div>'+
      '</div>';
    }).join('');
  }
  var el=g('cert-pg-list');
  el.innerHTML='<div class="spinner"></div>';

  function renderCerts(certs) {
    if (g('dct')) g('dct').textContent=(certs.length||0)+' Earned';
    var issuedTiers = certs.map(function(c){ return c.tier; });
    var needsIssue = !loadMyCerts._busy && CERT_TIERS.some(function(t){
      return pts >= tierPts(t.id) && issuedTiers.indexOf(t.id) < 0;
    });
    if (needsIssue) {
      loadMyCerts._busy = true;
      el.innerHTML='<div class="spinner" style="margin:2rem auto"></div>'+
        '<p style="text-align:center;color:var(--muted);font-size:.85rem;margin-top:.5rem">â³ Issuing your certificateâ€¦</p>';
      checkAndIssueTierCerts(pts);
      setTimeout(function(){ loadMyCerts._busy=false; loadMyCerts(); }, 3000);
      return;
    }
    loadMyCerts._busy = false;
    if (!certs.length) {
      var nextTier = CERT_TIERS.find(function(t){ return pts < tierPts(t.id); });
      var nextMsg = nextTier ? 'Reach <strong>'+tierPts(nextTier.id)+' points</strong> to earn your '+nextTier.label+' certificate!' : '';
      el.innerHTML='<h3 style="font-family:\'Crimson Pro\',serif;color:var(--primary);margin-bottom:.5rem">Your Certificates</h3>'+
        '<div class="empty"><div class="ei">&#127885;</div><p>No certificates yet! You have <strong>'+pts+' points</strong>. '+nextMsg+'</p></div>';
      return;
    }
    el.innerHTML='<h3 style="font-family:\'Crimson Pro\',serif;color:var(--primary);margin-bottom:.8rem">Your Earned Certificates</h3>'+
      '<div class="cert-grid">'+certs.map(function(c){
        var tier=CERT_TIERS.find(function(x){ return x.id===c.tier; })||CERT_TIERS[0];
        var date=c.issuedAt?new Date(c.issuedAt).toLocaleDateString('en-GB',{day:'numeric',month:'long',year:'numeric'}):'';
        return '<div class="cert-card '+tier.cls+'">'+
          '<div class="cert-card-badge">'+tier.icon+'</div>'+
          '<div class="cert-card-tier">'+tier.label+' Certificate</div>'+
          '<div class="cert-card-id">'+esc(c.certId)+'</div>'+
          '<div class="cert-card-pts">&#127919; '+c.points+' points</div>'+
          '<div class="cert-card-date">&#128197; '+date+'</div>'+
          '<div class="cert-card-acts">'+
            '<button class="btn sm bp" onclick=\'showCertificate('+JSON.stringify(c)+')\'>ğŸ… View &amp; Download</button>'+
          '</div>'+
        '</div>';
      }).join('')+'</div>';
  }

  if (fbOk()) {
    fbGetCerts(u.email, function(certs){ renderCerts(certs||[]); });
  } else if (CFG.gas) {
    gasGet('GET_CERTIFICATES','email='+encodeURIComponent(u.email)+'&t='+Date.now()).then(function(r){
      renderCerts((r&&r.success&&Array.isArray(r.data))?r.data:[]);
    }).catch(function(){ el.innerHTML='<div class="empty"><p style="color:var(--red)">Connection error loading certificates.</p></div>'; });
  } else {
    el.innerHTML='<div class="empty"><div class="ei">&#127885;</div><p>Configure Google Sheets in admin settings.</p></div>';
  }
}

function showCertificate(cert) {
  var cfg=CERT_CFG, u=S.user||{};
  var name=(cert._previewName)||u.name||cert.email||'Learner';
  var t=CERT_TIERS.find(function(x){ return x.id===cert.tier; })||CERT_TIERS[1];
  var cls=t.cls;
  var issuedDate=cert.issuedAt?new Date(cert.issuedAt).toLocaleDateString('en-GB',{day:'numeric',month:'long',year:'numeric'}):new Date().toLocaleDateString('en-GB',{day:'numeric',month:'long',year:'numeric'});
  var orgName=(cfg.cert_org_name||'Bridge4Change Foundation');
  var sigName=(cfg.cert_signatory_name||'Programme Director');
  var sigTitle=(cfg.cert_signatory_title||orgName);
  var footerTxt=(cfg.cert_footer_text||'This certificate is awarded in recognition of outstanding learning achievement.');
  var certId=cert.certId||'B4C-PREVIEW';
  var pts=cert.points||'--';
  var tierDesc={bronze:'for achieving 100+ learning points',silver:'for achieving 300+ learning points',gold:'for achieving 500+ learning points',plat:'for achieving 1000+ learning points'}[cls]||'for outstanding achievement';
  var html=
    '<div class="certificate">'+
      '<div class="cert-tier-strip '+cls+'"></div>'+
      '<div class="cert-hdr">'+
        '<img class="cert-hdr-logo" src="'+LOGO_URI+'" alt="Bridge4Change Logo">'+
        '<div class="cert-hdr-right"><div class="cert-hdr-org">'+esc(orgName)+'</div><div class="cert-hdr-sub">Learning &amp; Development</div></div>'+
      '</div>'+
      '<div class="cert-body">'+
        '<div class="cert-tier-badge-wrap"><div class="cert-tier-icon">'+t.icon+'</div><span class="cert-tier-label '+cls+'">'+t.label+' Certificate</span></div>'+
        '<div class="cert-title-txt">Certificate of Achievement</div>'+
        '<div class="cert-sub-txt">This is to certify that</div>'+
        '<div class="cert-divider"><div class="cert-divider-line '+cls+'"></div><div class="cert-divider-dot '+cls+'"></div><div class="cert-divider-line '+cls+'"></div></div>'+
        '<div class="cert-name">'+esc(name)+'</div>'+
        '<span class="cert-name-line '+cls+'"></span>'+
        '<div class="cert-pts-txt">has earned</div>'+
        '<div style="margin:.2rem 0 .3rem"><span class="cert-pts-pill '+cls+'">'+pts+' Points</span></div>'+
        '<div class="cert-sub-txt" style="margin-top:.2rem">'+tierDesc+'</div>'+
        '<div class="cert-sub-txt" style="margin-top:.35rem;font-size:.68rem">Date of Issue: '+issuedDate+'</div>'+
      '</div>'+
      '<div class="cert-ftr">'+
        '<div class="cert-ftr-issued">'+esc(footerTxt)+'</div>'+
        '<div class="cert-id-pill">'+esc(certId)+'</div>'+
      '</div>'+
      '<div class="cert-meta"><span>'+esc(orgName)+'</span><span>'+issuedDate+'</span></div>'+
      '<div class="cert-tier-strip '+cls+'"></div>'+
    '</div>';
  if (g('cert-ov-title')) g('cert-ov-title').textContent=t.icon+' '+t.label+' Certificate';
  g('cert-canvas-wrap').innerHTML=html;
  g('cert-ov').classList.remove('hidden');
  document.body.style.overflow='hidden';
}

function closeCertOv() { g('cert-ov').classList.add('hidden'); document.body.style.overflow=''; }
function printCert() { window.print(); }

function downloadCert() {
  var wrap = g('cert-canvas-wrap');
  var cert = wrap.querySelector('.certificate');
  if (!cert) return;

  var btn = g('dl-cert-btn');
  var origText = btn.textContent;
  btn.textContent = 'â³ Generatingâ€¦';
  btn.disabled = true;

  // Determine filename from tier
  var titleEl = g('cert-ov-title');
  var tierName = titleEl ? titleEl.textContent.replace(/[^a-zA-Z0-9 ]/g,'').trim().replace(/\s+/g,'-') : 'Certificate';
  var userName = (S.user && S.user.name) ? S.user.name.replace(/[^a-zA-Z0-9 ]/g,'').trim().replace(/\s+/g,'-') : 'Learner';
  var filename  = 'B4C-Certificate-' + tierName + '-' + userName + '.png';

  html2canvas(cert, {
    scale:       3,          // High-res (3Ã— for crisp output)
    useCORS:     true,
    allowTaint:  true,
    backgroundColor: '#ffffff',
    logging:     false,
    onclone: function(doc) {
      // Make sure the cloned cert is fully visible
      var cloned = doc.querySelector('.certificate');
      if (cloned) { cloned.style.maxWidth = 'none'; cloned.style.width = '740px'; }
    }
  }).then(function(canvas) {
    var link = document.createElement('a');
    link.download = filename;
    link.href = canvas.toDataURL('image/png', 1.0);
    link.click();
    btn.textContent = 'âœ“ Downloaded!';
    btn.disabled = false;
    setTimeout(function(){ btn.textContent = origText; }, 2500);
  }).catch(function(err) {
    console.warn('Download error:', err);
    btn.textContent = 'âœ— Failed â€“ try Print';
    btn.disabled = false;
    setTimeout(function(){ btn.textContent = origText; }, 3000);
  });
}

function updateCertCount() {
  if (!S.user) return;
  if (fbOk()) {
    fbGetCerts(S.user.email, function(certs){
      if (certs&&g('dct')) g('dct').textContent=certs.length+' Earned';
    });
  } else if (CFG.gas) {
    gasGet('GET_CERTIFICATES','email='+encodeURIComponent(S.user.email)+'&t='+Date.now()).then(function(r){
      if (r&&r.success&&Array.isArray(r.data)&&g('dct')) g('dct').textContent=r.data.length+' Earned';
    }).catch(function(){});
  }
}

function loadCertCfg() {
  loadCertConfig(function(){
    var c=CERT_CFG;
    g('cert-bronze-pts').value =c.cert_bronze_pts||'100';
    g('cert-silver-pts').value =c.cert_silver_pts||'300';
    g('cert-gold-pts').value   =c.cert_gold_pts||'500';
    g('cert-plat-pts').value   =c.cert_plat_pts||'1000';
    g('cert-org').value        =c.cert_org_name||'';
    g('cert-sign-name').value  =c.cert_signatory_name||'';
    g('cert-sign-title').value =c.cert_signatory_title||'';
    g('cert-footer-txt').value =c.cert_footer_text||'';
  });
}

function saveCertCfg() {
  if (!CFG.gas) { alert('GAS URL not configured in Settings.'); return; }
  var cfg={cert_bronze_pts:g('cert-bronze-pts').value,cert_silver_pts:g('cert-silver-pts').value,cert_gold_pts:g('cert-gold-pts').value,cert_plat_pts:g('cert-plat-pts').value,cert_org_name:g('cert-org').value,cert_signatory_name:g('cert-sign-name').value,cert_signatory_title:g('cert-sign-title').value,cert_footer_text:g('cert-footer-txt').value};
  gasPost('SAVE_CERT_CONFIG',cfg).then(function(r){
    if (r&&r.success){ Object.assign(CERT_CFG,cfg); lsS('cert_cfg',CERT_CFG); toast('Certificate settings saved!'); }
    else { alert('Save failed: '+(r&&r.message||'unknown')); }
  }).catch(function(e){ alert('Error: '+e); });
}

function previewSampleCert(tierId) {
  tierId=tierId||'gold';
  showCertificate({ certId:'B4C-PREVIEW-SAMPLE', tier:tierId, points:tierPts(tierId), issuedAt:new Date().toISOString(), _previewName:'Sample Learner' });
}

// Sync user's progress and points from Firebase on login/boot
function fbSyncUserState(email, cb) {
  if (!fbOk()) { if(cb) cb(); return; }
  fbGetProgress(email, function(prog){
    S.user.progress = prog;
    lsS('c_prog_'+email, prog);
    fbGetPoints(email, function(pts){
      if (pts !== null) {
        S.user.points = pts;
        // Update header and dashboard with Firebase points immediately
        if (g('hdr-pts')) g('hdr-pts').textContent = pts + ' pts';
        // Also sync points back to GAS so Google Sheet stays current
        if (S.token && CFG.gas && pts > 0) {
          // Use ADJUST_POINTS to force-sync Firebase points into GAS Users sheet
          // Only do this on login/boot, not on every action
          fbSyncUserState._lastSync = fbSyncUserState._lastSync || 0;
          var now = Date.now();
          if (now - fbSyncUserState._lastSync > 60000) { // max once per minute
            fbSyncUserState._lastSync = now;
            // Get GAS points first, only update if Firebase has more
            gasGet('VALIDATE_TOKEN','token='+encodeURIComponent(S.token)).then(function(r){
              var gasPoints = (r && r.success && r.data) ? (Number(r.data.points)||0) : 0;
              if (pts > gasPoints) {
                var diff = pts - gasPoints;
                gasPost('ADJUST_POINTS',{email:email, adjustment:diff, reason:'Firebase sync'})
                  .catch(function(e){ console.warn('GAS points sync err:',e); });
              }
            }).catch(function(){});
          }
        }
      }
      if(cb) cb();
    });
  });
}

// â”€â”€ ADMIN: FIREBASE SETUP FUNCTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateFbBadge() {
  var b=g('fb-badge'); if(!b) return;
  if (fbOk()) { b.textContent='&#127981; Connected'; b.style.background='#dcfce7'; b.style.color='#166534'; }
  else         { b.textContent='Not connected';  b.style.background='#fee2e2'; b.style.color='#991b1b'; }
}

function saveFbCfg() {
  var raw=(g('fb-cfg').value||'').trim();
  var msg=g('fb-msg');
  if (!raw) { msg.innerHTML='<div class="alert err">Please paste your Firebase config.</div>'; return; }
  // Clean up: accept raw JS object notation or JSON
  var cleaned=raw
    .replace(/^[\s\S]*?{/, '{')
    .replace(/}[\s\S]*$/, '}')
    .replace(/([{,\n\r]\s*)([a-zA-Z_][a-zA-Z0-9_]*)\s*:/g, '$1"$2":')
    .replace(/'/g, '"')
    .replace(/,\s*}/g, '}');
  var cfg;
  try { cfg=JSON.parse(cleaned); }
  catch(e) { msg.innerHTML='<div class="alert err">Could not parse config. Copy it exactly from Firebase Console.</div>'; return; }
  if (!cfg.apiKey||!cfg.projectId) { msg.innerHTML='<div class="alert err">Config missing apiKey or projectId.</div>'; return; }
  msg.innerHTML='<div class="alert info">Connectingâ€¦</div>';
  if (FB_APP) {
    // Already initialised â€” just save
    lsS('fb_cfg', cfg);
    msg.innerHTML='<div class="alert ok">âœ… Config saved. Reload the page to apply the new config.</div>';
    return;
  }
  var ok=fbInit(cfg);
  if (ok) {
    FS.collection('_ping').doc('ok').get()
      .then(function(){ msg.innerHTML='<div class="alert ok">âœ… Firebase connected! Project: <strong>'+cfg.projectId+'</strong>. Real-time sync is now live.</div>'; updateFbBadge(); if(g('fb-migrate-btn'))g('fb-migrate-btn').style.display=''; })
      .catch(function(){ msg.innerHTML='<div class="alert ok">âœ… Config saved ('+cfg.projectId+'). Make sure Firestore is enabled in Firebase Console in Test mode.</div>'; updateFbBadge(); });
  } else {
    msg.innerHTML='<div class="alert err">Initialization failed. Check browser console (F12).</div>';
  }
}

function testFbCfg() {
  var msg=g('fb-msg');
  if (!fbOk()) { msg.innerHTML='<div class="alert err">Not connected. Save config first.</div>'; return; }
  msg.innerHTML='<div class="alert info">Testingâ€¦</div>';
  FS.collection('_ping').doc('ok').set({ts:Date.now()})
    .then(function(){ msg.innerHTML='<div class="alert ok">âœ… Firestore read/write working perfectly!</div>'; })
    .catch(function(e){ msg.innerHTML='<div class="alert err">âŒ '+e.message+'<br><small>Enable Firestore in Test mode in Firebase Console.</small></div>'; });
}

function migrateFb() {
  if (!confirm('Copy existing user points from Google Sheets to Firebase?\n\nThis is safe to run multiple times.')) return;
  var msg=g('fb-migrate-msg');
  if (!fbOk()) { msg.textContent='âŒ Firebase not connected.'; return; }
  if (!CFG.gas) { msg.textContent='âŒ GAS URL not set.'; return; }
  msg.textContent='â³ Fetching users from Google Sheetsâ€¦';
  gasGet('GET_LEADERBOARD','t='+Date.now()).then(function(r){
    if (!r||!r.success||!Array.isArray(r.data)||!r.data.length) { msg.textContent='âŒ No users found in GAS.'; return; }
    var users=r.data, done=0, total=users.length;
    msg.textContent='â³ Migrating '+total+' usersâ€¦';
    users.forEach(function(u){
      if (!u.email) { done++; return; }
      FS.collection('users').doc(u.email.toLowerCase()).set({
        email:u.email.toLowerCase(), name:u.name||'',
        institution:u.institution||'', cohort:u.cohort||'',
        points:u.points||0
      },{merge:true}).then(function(){ done++; if(done===total) msg.textContent='âœ… Done! '+total+' users migrated.'; })
                    .catch(function(){ done++; if(done===total) msg.textContent='âš ï¸ Finished (some errors). Check console.'; });
    });
  }).catch(function(){ msg.textContent='âŒ GAS connection error.'; });
}

// ============================================================
function gasGet(action, qs) {
  if (!CFG.gas) return Promise.resolve(null);
  var url = CFG.gas + (action ? '?action='+encodeURIComponent(action) : '') + (qs?'&'+qs:'');
  return fetch(url, {method:'GET', mode:'cors'})
    .then(function(r){
      return r.text().then(function(txt){
        try { return JSON.parse(txt); }
        catch(e) {
          console.warn('GAS GET non-JSON:', txt.substring(0,200));
          return null;
        }
      });
    })
    .catch(function(e){ console.warn('GAS GET error:', e); return null; });
}

function gasPost(action, data, token) {
  if (!CFG.gas) return Promise.resolve(null);
  var body = {action:action, data:data};
  if (token) body.token = token;
  return fetch(CFG.gas, {
    method:'POST',
    mode:'cors',
    // text/plain avoids CORS preflight â€” GAS handles it as a simple request
    headers:{'Content-Type':'text/plain'},
    body: JSON.stringify(body)
  }).then(function(r){
    // GAS can return HTML redirect pages on auth errors â€” detect and handle
    var ct = r.headers.get('content-type') || '';
    if (ct.indexOf('html') > -1) {
      return {success:false, message:'GAS deployment error: received HTML instead of JSON. Check that your GAS is deployed with "Execute as: Me" and "Who has access: Anyone".'};
    }
    return r.text().then(function(txt){
      try { return JSON.parse(txt); }
      catch(e) {
        console.warn('GAS POST non-JSON response:', txt.substring(0,200));
        return {success:false, message:'Server returned invalid response. Please check GAS deployment settings.'};
      }
    });
  }).catch(function(e){ console.warn('GAS POST error:', e); return null; });
}

// ============================================================
// CONFIRM OVERLAY
// ============================================================
var coCb=null;
function openCo(t,m,cb) { g('co-t').textContent=t; g('co-m').textContent=m; coCb=cb; g('cov').classList.remove('hidden'); }
function closeCo() { g('cov').classList.add('hidden'); coCb=null; }
document.getElementById('co-ok').onclick=function(){ if(coCb) coCb(); closeCo(); };

// ============================================================
// UTILITIES
// ============================================================
function g(id)   { return document.getElementById(id); }
function eye(id) { var el=g(id); el.type=el.type==='password'?'text':'password'; }
function esc(s)  { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function fd(d)   { try{ return new Date(d).toLocaleDateString(); }catch(e){ return d||'â€“'; } }
function showErr(el,msg) { el.textContent=msg; el.classList.remove('hidden'); setTimeout(function(){ el.classList.add('hidden'); },5000); }
function toast(msg) {
  var t=document.createElement('div'); t.className='toast'; t.textContent='âœ… '+msg;
  document.body.appendChild(t); setTimeout(function(){ if(t.parentNode) t.remove(); },3000);
}

</script>
</body>
</html>
